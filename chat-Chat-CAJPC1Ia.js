import{r as c,c as q,j as W,h as Te,y as r,A as a,K as m,Q as F,u as Ie,J as X,aj as Y,P as O,a6 as B,O as g,M as xe,D as I,a4 as $e,V as Ae,n as x,aC as Ne,z as u}from"./chat-vendor-BrOh9MUQ.js";import{u as ze,a as Le,b as h}from"./chat-index-Dt5A4Wk2.js";import{A as G}from"./chat-Avatar-D-uQkRWk.js";import{_ as Ee}from"./chat-_plugin-vue_export-helper-DlAUqK2U.js";import{E as Z}from"./chat-element-C03ZGswg.js";const Ue={class:"wechat-container"},Ve={class:"sidebar"},je={class:"sidebar-header"},Re={class:"user-avatar"},Fe={class:"search-box"},Oe={class:"search-input"},Be={class:"chat-list"},Ge=["onClick"],Ke={class:"chat-avatar"},Pe={key:0,class:"unread-badge"},He={class:"chat-info"},Je={class:"chat-name"},Qe={class:"chat-last-message"},qe={class:"chat-time"},We={class:"main-chat"},Xe={key:0,class:"chat-area"},Ye={class:"chat-header"},Ze={class:"chat-title"},et={key:0,class:"online-status"},tt={class:"chat-actions"},st={class:"messages-wrapper"},at={key:0,class:"load-more"},nt=["disabled"],ot={key:0,class:"time-divider"},it={key:0,class:"message-avatar"},lt={key:1,class:"message-avatar-placeholder"},rt={class:"message-content"},ut={class:"message-bubble"},ct={class:"message-text"},dt={class:"message-status"},vt={class:"message-time"},pt={key:0,class:"message-status-icon"},gt={key:0,class:"iconfont icon-loading"},ft={key:1,class:"iconfont icon-check"},mt={key:2,class:"iconfont icon-check-double"},ht={class:"input-area"},_t={class:"input-toolbar"},wt={class:"input-container"},yt=["onKeydown"],Ct=["disabled"],kt={key:1,class:"welcome-page"},bt={key:0,class:"emoji-picker"},St={class:"emoji-list"},Dt=["onClick"],Mt={key:2,class:"voice-recorder"},Tt={class:"voice-modal"},It={class:"voice-content"},C=20,xt={__name:"Chat",setup($t){const k=Ne(),p=ze(),$=Le(),l=c(null),v=c([]),f=c(""),A=c(""),N=c(!1),E=c(!1),U=c(!1);c(!1),c(!1);const ee=c(!1),z=c(),V=c(),te=c(),b=c(!1),S=c(!0),w=c(1),d=c([]),L=c([]),K=c([]),se=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕","🤑","🤠"],ae=q(()=>A.value?d.value.filter(t=>t.name.toLowerCase().includes(A.value.toLowerCase())):d.value),ne=q(()=>d.value.reduce((t,e)=>t+(e.unreadCount||0),0));W(ne,t=>{t>0?document.title=`(${t}) FEI信`:document.title="FEI信"});const oe=async()=>{try{const t=await h.get("/api/users/friends/list");t.data.success&&(L.value=t.data.friends);const e=await h.get("/api/chats/groups");e.data.success&&(K.value=e.data.groups);const n=await h.get("/api/chats/unread-count");let s={};n.data.success&&(s=n.data.unreadCount);const o=[];L.value.forEach(i=>{o.push({type:"private",id:i._id,name:i.nickname||i.username,avatar:i.avatar,lastMessage:i.lastMessage||"",lastTime:i.lastMessageTime,unreadCount:s[i._id]||0})}),K.value.forEach(i=>{o.push({type:"group",id:i._id,name:i.name,avatar:i.avatar,lastMessage:i.lastMessage||"",lastTime:i.lastMessageTime,unreadCount:s[i._id]||0})}),o.sort((i,_)=>new Date(_.lastTime||0)-new Date(i.lastTime||0)),d.value=o}catch(t){console.error("获取聊天列表失败:",t)}},ie=async t=>{l.value=t,v.value=[],w.value=1,S.value=!0,console.log("选择聊天:",t),console.log("当前用户:",p.user),le(t.type,t.id);try{let e;if(t.type==="private"?e=await h.get(`/api/chats/private/${t.id}?page=${w.value}&limit=${C}`):e=await h.get(`/api/chats/groups/${t.id}?page=${w.value}&limit=${C}`),e.data.success){console.log("获取到的消息:",e.data.messages),console.log("消息数量:",e.data.messages.length);const n=e.data.messages.sort((s,o)=>new Date(s.createdAt)-new Date(o.createdAt));n.forEach((s,o)=>{var i,_;console.log(`消息 ${o+1}:`,{content:s.content.substring(0,20)+"...",senderId:s.sender._id,currentUserId:((i=p.user)==null?void 0:i.id)||((_=p.user)==null?void 0:_._id),isOwn:M(s)})}),v.value=n,S.value=e.data.messages.length===C,await x(),D()}}catch(e){console.error("获取消息失败:",e),Z.error("获取消息失败")}},le=(t,e)=>{const n=d.value.findIndex(s=>s.type===t&&String(s.id)===String(e));n!==-1&&(d.value[n].unreadCount=0)},re=(t,e,n)=>{const s=d.value.findIndex(o=>o.type===t&&String(o.id)===String(e));if(s!==-1){d.value[s].lastMessage=n,d.value[s].lastTime=new Date;const o=d.value.splice(s,1)[0];d.value.unshift(o)}},ue=async()=>{if(!(b.value||!S.value)){b.value=!0,w.value++;try{let t;if(l.value.type==="private"?t=await h.get(`/api/chats/private/${l.value.id}?page=${w.value}&limit=${C}`):t=await h.get(`/api/chats/groups/${l.value.id}?page=${w.value}&limit=${C}`),t.data.success){const e=t.data.messages.reverse();v.value.unshift(...e),S.value=e.length===C}}catch(t){console.error("加载更多消息失败:",t),w.value--}finally{b.value=!1}}},P=async()=>{var n,s,o,i,_;if(!f.value.trim()||!l.value)return;const t={content:f.value,timestamp:new Date,status:"sending"},e={_id:Date.now().toString(),content:f.value,sender:{_id:((n=p.user)==null?void 0:n.id)||((s=p.user)==null?void 0:s._id),username:(o=p.user)==null?void 0:o.username,nickname:(i=p.user)==null?void 0:i.nickname,avatar:(_=p.user)==null?void 0:_.avatar},createdAt:new Date,status:"sending"};v.value.push(e),f.value="",await x(),D();try{let y;if(l.value.type==="private"?y=await h.post("/api/chats/private",{receiver:l.value.id,content:t.content}):y=await h.post(`/api/chats/groups/${l.value.id}`,{content:t.content}),y.data.success){const T=v.value.findIndex(R=>R._id===e._id);T!==-1&&(v.value[T]={...y.data.message,status:"sent",_id:y.data.message._id}),re(l.value.type,l.value.id,e.content)}}catch(y){console.error("发送消息失败:",y),Z.error("发送消息失败");const T=v.value.findIndex(R=>R._id===e._id);T!==-1&&(v.value[T].status="failed")}},ce=()=>{k.push("/profile")},de=()=>{k.push("/settings")},ve=()=>{k.push("/add-friend")},pe=()=>{k.push("/group-chat")},ge=()=>{k.push("/moments")},D=()=>{z.value&&(z.value.scrollTop=z.value.scrollHeight)},fe=()=>{const t=V.value;t&&(t.style.height="auto",t.style.height=Math.min(t.scrollHeight,120)+"px")},me=t=>{var e;f.value+=t,N.value=!1,(e=V.value)==null||e.focus()},he=t=>{const e=t.target.files[0];e&&console.log("图片上传:",e),E.value=!1},_e=()=>{console.log("开始录音")},H=()=>{console.log("停止录音"),U.value=!1},we=()=>{},J=t=>{const e=L.value.find(n=>n._id===t);return(e==null?void 0:e.status)||"offline"},ye=t=>{const e=new Date(t),s=new Date-e;return s<6e4?"刚刚":s<36e5?Math.floor(s/6e4)+"分钟前":s<864e5?Math.floor(s/36e5)+"小时前":e.toLocaleDateString("zh-CN")},Ce=t=>{const e=new Date(t),n=new Date;return e.toDateString()===n.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toDateString()===new Date(n-864e5).toDateString()?"昨天 "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN")+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})},ke=t=>{if(!t)return"";const e=new Date(t),n=new Date;return e.toDateString()===n.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},be=(t,e)=>{if(!e)return!0;const n=new Date(t.createdAt),s=new Date(e.createdAt);return n-s>3e5},j=(t,e)=>{if(!e)return!1;const n=new Date(t.createdAt),s=new Date(e.createdAt),o=n-s;return t.sender._id===e.sender._id&&o<3e5},Se=t=>{l.value&&l.value.type==="private"&&String(t.sender._id)===String(l.value.id)&&!M(t)&&(v.value.push({...t,status:"received"}),x(()=>D())),Q("private",t.sender._id,t)},De=t=>{l.value&&l.value.type==="group"&&String(t.group)===String(l.value.id)&&!M(t)&&(v.value.push({...t,status:"received"}),x(()=>D())),Q("group",t.group,t)},Q=(t,e,n)=>{if(l.value&&l.value.type===t&&String(l.value.id)===String(e))return;const s=d.value.findIndex(o=>o.type===t&&String(o.id)===String(e));if(s!==-1){d.value[s].unreadCount=(d.value[s].unreadCount||0)+1,d.value[s].lastMessage=n.content,d.value[s].lastTime=n.createdAt;const o=d.value.splice(s,1)[0];d.value.unshift(o)}},M=t=>{var o,i;const e=((o=p.user)==null?void 0:o.id)||((i=p.user)==null?void 0:i._id),n=t.sender._id||t.sender.id;return String(e)===String(n)},Me=t=>{const e=L.value.find(n=>n._id===t.userId);e&&(e.status=t.status)};return Te(async()=>{var t,e,n,s;((t=p.user)!=null&&t.id||(e=p.user)!=null&&e._id)&&$.connect(((n=p.user)==null?void 0:n.id)||((s=p.user)==null?void 0:s._id)),await oe(),$.onNewMessage(Se),$.onNewGroupMessage(De),$.onUserStatus(Me)}),W(v,()=>{x(()=>D())}),(t,e)=>{var n;return u(),r("div",Ue,[a("div",Ve,[a("div",je,[a("div",Re,[F(G,{src:(n=Ie(p).user)==null?void 0:n.avatar,size:"medium"},null,8,["src"])]),a("div",{class:"user-actions"},[a("button",{class:"action-btn",onClick:ce,"aria-label":"个人资料"},e[6]||(e[6]=[a("i",{class:"iconfont icon-user"},null,-1)])),a("button",{class:"action-btn",onClick:de,"aria-label":"设置"},e[7]||(e[7]=[a("i",{class:"iconfont icon-settings"},null,-1)]))])]),a("div",Fe,[a("div",Oe,[e[8]||(e[8]=a("i",{class:"iconfont icon-search"},null,-1)),X(a("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>A.value=s),type:"text",placeholder:"搜索",onInput:we},null,544),[[Y,A.value]])])]),a("div",{class:"function-buttons"},[a("button",{class:"function-btn",onClick:ve,"aria-label":"添加好友"},e[9]||(e[9]=[a("i",{class:"iconfont icon-add"},null,-1),a("span",null,"添加好友",-1)])),a("button",{class:"function-btn",onClick:pe,"aria-label":"群聊"},e[10]||(e[10]=[a("i",{class:"iconfont icon-group"},null,-1),a("span",null,"群聊",-1)])),a("button",{class:"function-btn",onClick:ge,"aria-label":"朋友圈"},e[11]||(e[11]=[a("i",{class:"iconfont icon-moments"},null,-1),a("span",null,"朋友圈",-1)]))]),a("div",Be,[(u(!0),r(O,null,B(ae.value,s=>{var o,i;return u(),r("div",{key:`${s.type}-${s.id}`,class:I(["chat-item",{active:((o=l.value)==null?void 0:o.type)===s.type&&((i=l.value)==null?void 0:i.id)===s.id}]),onClick:_=>ie(s)},[a("div",Ke,[F(G,{src:s.avatar,size:"medium"},null,8,["src"]),s.unreadCount>0?(u(),r("div",Pe,g(s.unreadCount>99?"99+":s.unreadCount),1)):m("",!0)]),a("div",He,[a("div",Je,g(s.name),1),a("div",Qe,g(s.lastMessage||"暂无消息"),1)]),a("div",qe,g(ke(s.lastTime)),1)],10,Ge)}),128))])]),a("div",We,[l.value?(u(),r("div",Xe,[a("div",Ye,[a("div",Ze,[a("span",null,g(l.value.name),1),l.value.type==="private"?(u(),r("span",et,[a("span",{class:I(["status-dot",J(l.value.id)])},null,2),xe(" "+g(J(l.value.id)==="online"?"在线":"离线"),1)])):m("",!0)]),a("div",tt,[a("button",{class:"action-btn",onClick:e[1]||(e[1]=s=>ee.value=!0),"aria-label":"聊天信息"},e[12]||(e[12]=[a("i",{class:"iconfont icon-info"},null,-1)]))])]),a("div",{class:"messages-container",ref_key:"messagesContainer",ref:z},[a("div",st,[S.value?(u(),r("div",at,[a("button",{onClick:ue,disabled:b.value},g(b.value?"加载中...":"加载更多消息"),9,nt)])):m("",!0),(u(!0),r(O,null,B(v.value,(s,o)=>(u(),r("div",{key:s._id,class:I(["message-wrapper",{"message-group":j(s,v.value[o-1])}])},[be(s,v.value[o-1])?(u(),r("div",ot,g(Ce(s.createdAt)),1)):m("",!0),a("div",{class:I(["message-item",{own:M(s),grouped:j(s,v.value[o-1])}])},[j(s,v.value[o-1])?(u(),r("div",lt)):(u(),r("div",it,[F(G,{src:s.sender.avatar,size:"small"},null,8,["src"])])),a("div",rt,[a("div",ut,[a("div",ct,g(s.content),1),a("div",dt,[a("span",vt,g(ye(s.createdAt)),1),M(s)?(u(),r("span",pt,[s.status==="sending"?(u(),r("i",gt)):s.status==="sent"?(u(),r("i",ft)):s.status==="read"?(u(),r("i",mt)):m("",!0)])):m("",!0)])])])],2)],2))),128))])],512),a("div",ht,[a("div",_t,[a("button",{class:"tool-btn",onClick:e[2]||(e[2]=s=>N.value=!N.value),"aria-label":"表情"},e[13]||(e[13]=[a("i",{class:"iconfont icon-emoji"},null,-1)])),a("button",{class:"tool-btn",onClick:e[3]||(e[3]=s=>E.value=!0),"aria-label":"图片"},e[14]||(e[14]=[a("i",{class:"iconfont icon-image"},null,-1)])),a("button",{class:"tool-btn",onClick:e[4]||(e[4]=s=>U.value=!0),"aria-label":"语音"},e[15]||(e[15]=[a("i",{class:"iconfont icon-voice"},null,-1)]))]),a("div",wt,[X(a("textarea",{"onUpdate:modelValue":e[5]||(e[5]=s=>f.value=s),ref_key:"messageInput",ref:V,class:"message-input",placeholder:"输入消息...",onKeydown:$e(Ae(P,["prevent"]),["enter"]),onInput:fe,rows:"1"},null,40,yt),[[Y,f.value]]),a("button",{class:I(["send-btn",{active:f.value.trim()}]),onClick:P,disabled:!f.value.trim()}," 发送 ",10,Ct)])])])):(u(),r("div",kt,e[16]||(e[16]=[a("div",{class:"welcome-content"},[a("div",{class:"welcome-icon"},[a("i",{style:{"font-size":"50px"},class:"iconfont icon-chat"})]),a("h2",null,"飞信"),a("p",null,"选择一个聊天开始对话")],-1)])))]),N.value?(u(),r("div",bt,[a("div",St,[(u(),r(O,null,B(se,s=>a("span",{key:s,class:"emoji-item",onClick:o=>me(s)},g(s),9,Dt)),64))])])):m("",!0),E.value?(u(),r("input",{key:1,ref_key:"imageInput",ref:te,type:"file",accept:"image/*",onChange:he,style:{display:"none"}},null,544)):m("",!0),U.value?(u(),r("div",Mt,[a("div",Tt,[a("div",It,[e[17]||(e[17]=a("div",{class:"voice-icon"},[a("i",{class:"iconfont icon-microphone"})],-1)),e[18]||(e[18]=a("p",null,"按住说话",-1)),a("button",{class:"voice-btn",onMousedown:_e,onMouseup:H,onMouseleave:H}," 录音 ",32)])])])):m("",!0)])}}},Ut=Ee(xt,[["__scopeId","data-v-65e32f8e"]]);export{Ut as default};
