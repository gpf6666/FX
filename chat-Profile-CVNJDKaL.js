import{r as m,y as g,z as h,A as e,K,Q as t,C as ae,O as u,X as oe,h as le,I as n,al as r,P as Q,a6 as W,aC as ne,M as C,D as re,u as X}from"./chat-vendor-BrOh9MUQ.js";import{u as ie,b as E}from"./chat-index-CX24nwUD.js";import{A as ce}from"./chat-Avatar-D-uQkRWk.js";import{_ as H}from"./chat-_plugin-vue_export-helper-DlAUqK2U.js";import{d as q,E as k}from"./chat-element-C03ZGswg.js";const ue={class:"avatar-upload"},de={key:0,class:"upload-progress"},me={class:"progress-bar"},pe={class:"progress-text"},ve={key:1,class:"upload-error"},_e={__name:"AvatarUpload",props:{currentAvatar:{type:String,default:""},size:{type:String,default:"large"},maxSize:{type:Number,default:5*1024*1024}},emits:["upload-success","upload-error"],setup(V,{emit:F}){const i=V,x=F,w=m(null),v=m(""),_=m(!1),d=m(0),l=m(""),P=()=>{var f;(f=w.value)==null||f.click()},R=async f=>{const c=f.target.files[0];if(!c)return;if(!c.type.startsWith("image/")){l.value="请选择图片文件";return}if(c.size>i.maxSize){l.value=`文件大小不能超过 ${i.maxSize/1024/1024}MB`;return}l.value="";const A=new FileReader;A.onload=p=>{v.value=p.target.result},A.readAsDataURL(c);try{_.value=!0,d.value=0;const p=new FormData;p.append("avatar",c);const S=await fetch("/api/upload/avatar",{method:"POST",body:p});if(!S.ok)throw new Error("上传失败");const y=await S.json();if(y.success)d.value=100,_.value=!1,v.value=y.data.url,x("upload-success",{url:y.data.url,file:c}),setTimeout(()=>{v.value=""},1e3);else throw new Error(y.message||"上传失败")}catch(p){_.value=!1,l.value=p.message||"上传失败",x("upload-error",p.message||"上传失败")}};return(f,c)=>(h(),g("div",ue,[e("div",{class:"avatar-preview",onClick:P},[t(ce,{src:v.value||V.currentAvatar,size:V.size},null,8,["src","size"]),c[0]||(c[0]=e("div",{class:"upload-overlay"},[e("i",{class:"iconfont icon-image"}),e("span",null,"更换头像")],-1))]),e("input",{ref_key:"fileInput",ref:w,type:"file",accept:"image/*",onChange:R,style:{display:"none"}},null,544),_.value?(h(),g("div",de,[e("div",me,[e("div",{class:"progress-fill",style:ae({width:d.value+"%"})},null,4)]),e("span",pe,u(d.value)+"%",1)])):K("",!0),l.value?(h(),g("div",ve,u(l.value),1)):K("",!0)]))}},fe=H(_e,[["__scopeId","data-v-13514240"]]),ge={class:"wechat-page"},he={class:"wechat-header"},we={class:"wechat-content"},ye={class:"profile-section"},ke={class:"profile-card"},xe={class:"profile-header"},be={class:"profile-info"},ze={class:"profile-name"},Ce={class:"profile-username"},Ve={class:"function-list"},Ae={class:"function-section"},Se={class:"function-section"},$e={class:"section-header"},Ue={class:"section-count"},Be={class:"friends-list"},Ee={class:"friend-info"},Fe={class:"friend-name"},Pe={class:"friend-status"},Re={class:"function-section"},Te={class:"section-header"},Ie={class:"section-count"},De={class:"groups-list"},Le={class:"group-info"},Me={class:"group-name"},Ne={class:"group-members"},Oe={class:"group-role"},je={class:"function-section"},Ge={__name:"Profile",setup(V){var L,M,N,O;const F=ne(),i=ie(),x=m(),w=m([]),v=m([]),_=m(!1),d=m(!1),l=oe({username:((L=i.user)==null?void 0:L.username)||"",email:((M=i.user)==null?void 0:M.email)||"",nickname:((N=i.user)==null?void 0:N.nickname)||"",avatar:((O=i.user)==null?void 0:O.avatar)||""}),P={nickname:[{max:20,message:"昵称长度不能超过20个字符",trigger:"blur"}]},R=async()=>{try{await x.value.validate(),_.value=!0;const o=await E.put("/api/users/profile",{nickname:l.nickname,avatar:l.avatar});o.data.success&&(k.success("更新成功"),i.user=o.data.user,d.value=!1)}catch(o){console.error("更新个人资料失败:",o),k.error("更新失败")}finally{_.value=!1}},f=async()=>{try{const o=await E.get("/api/users/friends/list");o.data.success&&(w.value=o.data.friends)}catch(o){console.error("获取好友列表失败:",o)}},c=async()=>{try{const o=await E.get("/api/chats/groups");o.data.success&&(v.value=o.data.groups)}catch(o){console.error("获取群组列表失败:",o)}},A=async o=>{try{await q.confirm("确定要删除这个好友吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await E.delete(`/api/users/friends/${o}`)).data.success&&(k.success("删除成功"),await f())}catch(s){s!=="cancel"&&(console.error("删除好友失败:",s),k.error("删除失败"))}},p=o=>{l.avatar=o.url,k.success("头像上传成功")},S=o=>{k.error(o||"头像上传失败")},y=async()=>{try{await q.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),i.logout(),F.push("/login")}catch{}};return le(async()=>{await f(),await c()}),(o,s)=>{const J=r("ArrowLeft"),b=r("el-icon"),z=r("el-button"),T=r("el-avatar"),j=r("ArrowRight"),Y=r("User"),Z=r("el-tag"),ee=r("SwitchButton"),$=r("el-form-item"),I=r("el-input"),se=r("el-form"),te=r("el-dialog");return h(),g("div",ge,[e("div",he,[t(z,{onClick:s[0]||(s[0]=a=>o.$router.push("/chat")),type:"text",size:"small"},{default:n(()=>[t(b,null,{default:n(()=>[t(J)]),_:1})]),_:1}),s[7]||(s[7]=e("div",{class:"wechat-header-title"},"我",-1)),s[8]||(s[8]=e("div",null,null,-1))]),e("div",we,[e("div",ye,[e("div",ke,[e("div",xe,[t(T,{src:l.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),e("div",be,[e("div",ze,u(l.nickname||l.username),1),e("div",Ce,"微信号："+u(l.username),1)]),t(z,{type:"text",size:"small"},{default:n(()=>[t(b,null,{default:n(()=>[t(j)]),_:1})]),_:1})])])]),e("div",Ve,[e("div",Ae,[e("div",{class:"wechat-list-item",onClick:s[1]||(s[1]=a=>d.value=!0)},[t(b,null,{default:n(()=>[t(Y)]),_:1}),s[9]||(s[9]=e("span",{class:"function-text"},"个人资料",-1)),t(b,null,{default:n(()=>[t(j)]),_:1})])]),e("div",Se,[e("div",$e,[s[10]||(s[10]=e("span",null,"好友管理",-1)),e("span",Ue,"("+u(w.value.length)+")",1)]),e("div",Be,[(h(!0),g(Q,null,W(w.value,a=>(h(),g("div",{key:a._id,class:"wechat-list-item"},[t(T,{src:a.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),e("div",Ee,[e("div",Fe,u(a.nickname||a.username),1),e("div",Pe,[e("span",{class:re(["user-status",a.status])},null,2),C(" "+u(a.status==="online"?"在线":"离线"),1)])]),t(z,{type:"text",size:"small",onClick:D=>A(a._id),class:"delete-btn"},{default:n(()=>s[11]||(s[11]=[C(" 删除 ",-1)])),_:2,__:[11]},1032,["onClick"])]))),128))])]),e("div",Re,[e("div",Te,[s[12]||(s[12]=e("span",null,"群组管理",-1)),e("span",Ie,"("+u(v.value.length)+")",1)]),e("div",De,[(h(!0),g(Q,null,W(v.value,a=>{var D;return h(),g("div",{key:a._id,class:"wechat-list-item"},[t(T,{src:a.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),e("div",Le,[e("div",Me,u(a.name),1),e("div",Ne,u(a.members.length)+"人",1)]),e("div",Oe,[t(Z,{type:((D=a.members.find(U=>{var B;return U.user._id===((B=X(i).user)==null?void 0:B.id)}))==null?void 0:D.role)==="admin"?"danger":"info",size:"small"},{default:n(()=>{var U;return[C(u(((U=a.members.find(B=>{var G;return B.user._id===((G=X(i).user)==null?void 0:G.id)}))==null?void 0:U.role)==="admin"?"管理员":"成员"),1)]}),_:2},1032,["type"])])])}),128))])]),e("div",je,[e("div",{class:"wechat-list-item logout-item",onClick:y},[t(b,null,{default:n(()=>[t(ee)]),_:1}),s[13]||(s[13]=e("span",{class:"function-text"},"退出登录",-1))])])])]),t(te,{modelValue:d.value,"onUpdate:modelValue":s[6]||(s[6]=a=>d.value=a),title:"编辑个人资料",width:"500px"},{footer:n(()=>[t(z,{onClick:s[5]||(s[5]=a=>d.value=!1)},{default:n(()=>s[14]||(s[14]=[C("取消",-1)])),_:1,__:[14]}),t(z,{type:"primary",onClick:R,loading:_.value},{default:n(()=>s[15]||(s[15]=[C(" 保存 ",-1)])),_:1,__:[15]},8,["loading"])]),default:n(()=>[t(se,{ref_key:"profileFormRef",ref:x,model:l,rules:P,"label-width":"80px"},{default:n(()=>[t($,{label:"头像"},{default:n(()=>[t(fe,{"current-avatar":l.avatar,size:"xlarge",onUploadSuccess:p,onUploadError:S},null,8,["current-avatar"])]),_:1}),t($,{label:"用户名"},{default:n(()=>[t(I,{modelValue:l.username,"onUpdate:modelValue":s[2]||(s[2]=a=>l.username=a),disabled:""},null,8,["modelValue"])]),_:1}),t($,{label:"邮箱"},{default:n(()=>[t(I,{modelValue:l.email,"onUpdate:modelValue":s[3]||(s[3]=a=>l.email=a),disabled:""},null,8,["modelValue"])]),_:1}),t($,{label:"昵称",prop:"nickname"},{default:n(()=>[t(I,{modelValue:l.nickname,"onUpdate:modelValue":s[4]||(s[4]=a=>l.nickname=a),placeholder:"请输入昵称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},He=H(Ge,[["__scopeId","data-v-ad7cecfa"]]);export{He as default};
