const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Login.js","assets/vendor.js","assets/element.js","assets/element.css","assets/_plugin-vue_export-helper.js","assets/Login.css","assets/Register.js","assets/Register.css","assets/Chat.js","assets/Avatar.js","assets/Avatar.css","assets/Chat.css","assets/Moments.js","assets/Moments.css","assets/Profile.js","assets/Profile.css","assets/Settings.js","assets/Settings.css","assets/AddFriend.js","assets/AddFriend.css","assets/GroupChat.js","assets/GroupChat.css"])))=>i.map(i=>d[i]);
import{cr as y,r as f,c as M,cs as A,ct as P,y as L,B as R,W as O,bm as D,C,cu as q,cv as N,cn as T,cw as I}from"./vendor.js";import{i as U}from"./element.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&l(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function l(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();const S=y("auth",()=>{const e=f(localStorage.getItem("token")||""),n=f(null),r=f(!1),l=M(()=>!!e.value),o=v=>{e.value=v,localStorage.setItem("token",v),A.defaults.headers.common.Authorization=`Bearer ${v}`},a=()=>{e.value="",n.value=null,localStorage.removeItem("token"),delete A.defaults.headers.common.Authorization},c=async v=>{var d,g;r.value=!0;try{const m=await A.post("/api/auth/login",v);return m.data.success?(o(m.data.token),n.value=m.data.user,{success:!0}):{success:!1,message:m.data.message}}catch(m){return{success:!1,message:((g=(d=m.response)==null?void 0:d.data)==null?void 0:g.message)||"登录失败"}}finally{r.value=!1}},u=async v=>{var d,g;r.value=!0;try{const m=await A.post("/api/auth/register",v);return m.data.success?(o(m.data.token),n.value=m.data.user,{success:!0}):{success:!1,message:m.data.message}}catch(m){return{success:!1,message:((g=(d=m.response)==null?void 0:d.data)==null?void 0:g.message)||"注册失败"}}finally{r.value=!1}},i=async()=>{if(e.value)try{const v=await A.get("/api/auth/me");v.data.success&&(n.value=v.data.user)}catch(v){console.error("获取用户信息失败:",v),a()}},p=()=>{a()};return e.value&&(A.defaults.headers.common.Authorization=`Bearer ${e.value}`),{token:e,user:n,loading:r,isAuthenticated:l,setToken:o,clearToken:a,login:c,register:u,getUserInfo:i,logout:p}}),V=y("socket",()=>{const e=f(null),n=f(!1),r=f(!1),l=f(0),o=5,a=f(new Map),c=f(new Map),u=f(new Map),i=f(new Map),p=s=>{r.value||(r.value=!0,e.value&&e.value.disconnect(),e.value=P("http://localhost:3000",{transports:["websocket","polling"],timeout:2e4,reconnection:!0,reconnectionAttempts:o,reconnectionDelay:1e3,reconnectionDelayMax:5e3,maxReconnectionAttempts:o}),e.value.on("connect",()=>{n.value=!0,r.value=!1,l.value=0,console.log("Socket connected successfully"),s&&(e.value.emit("user_login",s),console.log("User login event sent:",s))}),e.value.on("disconnect",t=>{n.value=!1,r.value=!1,console.log("Socket disconnected:",t),t==="io server disconnect"&&setTimeout(()=>{l.value<o&&(l.value++,p(s))},1e3)}),e.value.on("connect_error",t=>{console.error("Socket connection error:",t),n.value=!1,r.value=!1,l.value<o&&(l.value++,setTimeout(()=>{p(s)},2e3))}),e.value.on("reconnect",t=>{console.log("Socket reconnected after",t,"attempts"),l.value=0,s&&e.value.emit("user_login",s)}),e.value.on("reconnect_error",t=>{console.error("Socket reconnection error:",t)}),e.value.on("reconnect_failed",()=>{console.error("Socket reconnection failed after",o,"attempts"),l.value=0}),e.value.on("new_message",t=>{console.log("New message received:",t),a.value.forEach(_=>{try{_(t)}catch(k){console.error("Error in message callback:",k)}})}),e.value.on("new_group_message",t=>{console.log("New group message received:",t),c.value.forEach(_=>{try{_(t)}catch(k){console.error("Error in group message callback:",k)}})}),e.value.on("user_status",t=>{console.log("User status change:",t),u.value.forEach(_=>{try{_(t)}catch(k){console.error("Error in user status callback:",k)}})}),e.value.on("new_moment",t=>{console.log("New moment received:",t),i.value.forEach(_=>{try{_(t)}catch(k){console.error("Error in moment callback:",k)}})}),e.value.on("message_sent",t=>{console.log("Message sent confirmation:",t)}),e.value.on("message_read",t=>{console.log("Message read confirmation:",t)}))};return{socket:e,connected:n,connecting:r,connect:p,disconnect:()=>{e.value&&(e.value.disconnect(),e.value=null,n.value=!1,r.value=!1,l.value=0,a.value.clear(),c.value.clear(),u.value.clear(),i.value.clear())},sendPrivateMessage:s=>e.value&&n.value?(console.log("Sending private message:",s),e.value.emit("private_message",s),!0):(console.warn("Socket not connected, cannot send message"),!1),sendGroupMessage:s=>e.value&&n.value?(console.log("Sending group message:",s),e.value.emit("group_message",s),!0):(console.warn("Socket not connected, cannot send group message"),!1),markMessageAsRead:s=>{e.value&&n.value&&e.value.emit("mark_message_read",{messageId:s})},onNewMessage:s=>{const t=Date.now()+Math.random();return a.value.set(t,s),t},onNewGroupMessage:s=>{const t=Date.now()+Math.random();return c.value.set(t,s),t},onUserStatus:s=>{const t=Date.now()+Math.random();return u.value.set(t,s),t},onNewMoment:s=>{const t=Date.now()+Math.random();return i.value.set(t,s),t},removeListener:(s,t)=>{switch(s){case"new_message":a.value.delete(t);break;case"new_group_message":c.value.delete(t);break;case"user_status":u.value.delete(t);break;case"new_moment":i.value.delete(t);break}},removeAllListeners:()=>{a.value.clear(),c.value.clear(),u.value.clear(),i.value.clear()},getConnectionStatus:()=>({connected:n.value,connecting:r.value,reconnectAttempts:l.value,maxReconnectAttempts:o})}}),B={id:"app"},G={__name:"App",setup(e){const n=S();return V(),L(()=>{const r=localStorage.getItem("token");r&&(n.setToken(r),n.getUserInfo())}),(r,l)=>{const o=D("router-view");return C(),R("div",B,[O(o)])}}},$="modulepreload",x=function(e){return"/FX/"+e},E={},h=function(n,r,l){let o=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),u=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));o=Promise.allSettled(r.map(i=>{if(i=x(i),i in E)return;E[i]=!0;const p=i.endsWith(".css"),v=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${v}`))return;const d=document.createElement("link");if(d.rel=p?"stylesheet":$,p||(d.as="script"),d.crossOrigin="",d.href=i,u&&d.setAttribute("nonce",u),document.head.appendChild(d),p)return new Promise((g,m)=>{d.addEventListener("load",g),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${i}`)))})}))}function a(c){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=c,window.dispatchEvent(u),!u.defaultPrevented)throw c}return o.then(c=>{for(const u of c||[])u.status==="rejected"&&a(u.reason);return n().catch(a)})},z=[{path:"/",redirect:"/login"},{path:"/login",name:"Login",component:()=>h(()=>import("./Login.js"),__vite__mapDeps([0,1,2,3,4,5])),meta:{requiresAuth:!1}},{path:"/register",name:"Register",component:()=>h(()=>import("./Register.js"),__vite__mapDeps([6,1,2,3,4,7])),meta:{requiresAuth:!1}},{path:"/chat",name:"Chat",component:()=>h(()=>import("./Chat.js"),__vite__mapDeps([8,1,2,3,9,4,10,11])),meta:{requiresAuth:!0}},{path:"/moments",name:"Moments",component:()=>h(()=>import("./Moments.js"),__vite__mapDeps([12,1,2,3,4,13])),meta:{requiresAuth:!0}},{path:"/profile",name:"Profile",component:()=>h(()=>import("./Profile.js"),__vite__mapDeps([14,1,2,3,9,4,10,15])),meta:{requiresAuth:!0}},{path:"/settings",name:"Settings",component:()=>h(()=>import("./Settings.js"),__vite__mapDeps([16,1,2,3,4,17])),meta:{requiresAuth:!0}},{path:"/add-friend",name:"AddFriend",component:()=>h(()=>import("./AddFriend.js"),__vite__mapDeps([18,1,2,3,9,4,10,19])),meta:{requiresAuth:!0}},{path:"/group-chat",name:"GroupChat",component:()=>h(()=>import("./GroupChat.js"),__vite__mapDeps([20,1,2,3,9,4,10,21])),meta:{requiresAuth:!0}}],b=q({history:N(),routes:z});b.beforeEach((e,n,r)=>{const l=S();e.meta.requiresAuth&&!l.isAuthenticated?r("/login"):(e.path==="/login"||e.path==="/register")&&l.isAuthenticated?r("/chat"):r()});const w=T(G);w.use(I());w.use(b);w.use(U);w.mount("#app");export{V as a,S as u};
