var oe=Object.defineProperty;var u=(y,z)=>oe(y,"name",{value:z,configurable:!0});import{r as p,c as h,o as w,b as e,p as q,e as t,M as le,t as d,u as ne,a as re,n as ie,w as n,f as r,F as H,s as J,z as R,L as K,h as ce,j as S,x as ue,i as Q,E as b}from"./index.js";import{A as de}from"./Avatar.js";import{_ as X}from"./_plugin-vue_export-helper.js";const me={class:"avatar-upload"},pe={key:0,class:"upload-progress"},ve={class:"progress-bar"},_e={class:"progress-text"},fe={key:1,class:"upload-error"},ge={__name:"AvatarUpload",props:{currentAvatar:{type:String,default:""},size:{type:String,default:"large"},maxSize:{type:Number,default:5*1024*1024}},emits:["upload-success","upload-error"],setup(y,{emit:z}){const i=y,V=z,k=p(null),_=p(""),f=p(!1),m=p(0),l=p(""),T=u(()=>{var g;(g=k.value)==null||g.click()},"triggerFileInput"),L=u(async g=>{const c=g.target.files[0];if(!c)return;if(!c.type.startsWith("image/")){l.value="请选择图片文件";return}if(c.size>i.maxSize){l.value=`文件大小不能超过 ${i.maxSize/1024/1024}MB`;return}l.value="";const $=new FileReader;$.onload=v=>{_.value=v.target.result},$.readAsDataURL(c);try{f.value=!0,m.value=0;const v=new FormData;v.append("avatar",c);const U=await fetch("/api/upload/avatar",{method:"POST",body:v});if(!U.ok)throw new Error("上传失败");const x=await U.json();if(x.success)m.value=100,f.value=!1,_.value=x.data.url,V("upload-success",{url:x.data.url,file:c}),setTimeout(()=>{_.value=""},1e3);else throw new Error(x.message||"上传失败")}catch(v){f.value=!1,l.value=v.message||"上传失败",V("upload-error",v.message||"上传失败")}},"handleFileChange");return(g,c)=>(w(),h("div",me,[e("div",{class:"avatar-preview",onClick:T},[t(de,{src:_.value||y.currentAvatar,size:y.size},null,8,["src","size"]),c[0]||(c[0]=e("div",{class:"upload-overlay"},[e("i",{class:"iconfont icon-image"}),e("span",null,"更换头像")],-1))]),e("input",{ref_key:"fileInput",ref:k,type:"file",accept:"image/*",onChange:L,style:{display:"none"}},null,544),f.value?(w(),h("div",pe,[e("div",ve,[e("div",{class:"progress-fill",style:le({width:m.value+"%"})},null,4)]),e("span",_e,d(m.value)+"%",1)])):q("",!0),l.value?(w(),h("div",fe,d(l.value),1)):q("",!0)]))}},he=X(ge,[["__scopeId","data-v-ad412b2c"]]),we={class:"wechat-page"},ye={class:"wechat-header"},ke={class:"wechat-content"},xe={class:"profile-section"},be={class:"profile-card"},ze={class:"profile-header"},Ve={class:"profile-info"},Ae={class:"profile-name"},Ce={class:"profile-username"},Se={class:"function-list"},$e={class:"function-section"},Ue={class:"function-section"},Be={class:"section-header"},Fe={class:"section-count"},Ee={class:"friends-list"},Re={class:"friend-info"},Te={class:"friend-name"},Le={class:"friend-status"},Pe={class:"function-section"},Ie={class:"section-header"},Me={class:"section-count"},Ne={class:"groups-list"},De={class:"group-info"},je={class:"group-name"},Ge={class:"group-members"},Oe={class:"group-role"},We={class:"function-section"},qe={__name:"Profile",setup(y){var N,D,j,G;const z=ce(),i=ne(),V=p(),k=p([]),_=p([]),f=p(!1),m=p(!1),l=re({username:((N=i.user)==null?void 0:N.username)||"",email:((D=i.user)==null?void 0:D.email)||"",nickname:((j=i.user)==null?void 0:j.nickname)||"",avatar:((G=i.user)==null?void 0:G.avatar)||""}),T={nickname:[{max:20,message:"昵称长度不能超过20个字符",trigger:"blur"}]},L=u(async()=>{try{await V.value.validate(),f.value=!0;const o=await R.put("/api/users/profile",{nickname:l.nickname,avatar:l.avatar});o.data.success&&(b.success("更新成功"),i.user=o.data.user,m.value=!1)}catch(o){console.error("更新个人资料失败:",o),b.error("更新失败")}finally{f.value=!1}},"updateProfile"),g=u(async()=>{try{const o=await R.get("/api/users/friends/list");o.data.success&&(k.value=o.data.friends)}catch(o){console.error("获取好友列表失败:",o)}},"getFriends"),c=u(async()=>{try{const o=await R.get("/api/chats/groups");o.data.success&&(_.value=o.data.groups)}catch(o){console.error("获取群组列表失败:",o)}},"getGroups"),$=u(async o=>{try{await K.confirm("确定要删除这个好友吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await R.delete(`/api/users/friends/${o}`)).data.success&&(b.success("删除成功"),await g())}catch(s){s!=="cancel"&&(console.error("删除好友失败:",s),b.error("删除失败"))}},"removeFriend"),v=u(o=>{l.avatar=o.url,b.success("头像上传成功")},"handleAvatarUpload"),U=u(o=>{b.error(o||"头像上传失败")},"handleAvatarError"),x=u(async()=>{try{await K.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),i.logout(),z.push("/login")}catch{}},"handleLogout");return ie(async()=>{await g(),await c()}),(o,s)=>{const Y=r("ArrowLeft"),A=r("el-icon"),C=r("el-button"),P=r("el-avatar"),O=r("ArrowRight"),Z=r("User"),ee=r("el-tag"),se=r("SwitchButton"),B=r("el-form-item"),I=r("el-input"),te=r("el-form"),ae=r("el-dialog");return w(),h("div",we,[e("div",ye,[t(C,{onClick:s[0]||(s[0]=a=>o.$router.push("/chat")),type:"text",size:"small"},{default:n(()=>[t(A,null,{default:n(()=>[t(Y)]),_:1})]),_:1}),s[7]||(s[7]=e("div",{class:"wechat-header-title"},"我",-1)),s[8]||(s[8]=e("div",null,null,-1))]),e("div",ke,[e("div",xe,[e("div",be,[e("div",ze,[t(P,{src:l.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),e("div",Ve,[e("div",Ae,d(l.nickname||l.username),1),e("div",Ce,"微信号："+d(l.username),1)]),t(C,{type:"text",size:"small"},{default:n(()=>[t(A,null,{default:n(()=>[t(O)]),_:1})]),_:1})])])]),e("div",Se,[e("div",$e,[e("div",{class:"wechat-list-item",onClick:s[1]||(s[1]=a=>m.value=!0)},[t(A,null,{default:n(()=>[t(Z)]),_:1}),s[9]||(s[9]=e("span",{class:"function-text"},"个人资料",-1)),t(A,null,{default:n(()=>[t(O)]),_:1})])]),e("div",Ue,[e("div",Be,[s[10]||(s[10]=e("span",null,"好友管理",-1)),e("span",Fe,"("+d(k.value.length)+")",1)]),e("div",Ee,[(w(!0),h(H,null,J(k.value,a=>(w(),h("div",{key:a._id,class:"wechat-list-item"},[t(P,{src:a.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),e("div",Re,[e("div",Te,d(a.nickname||a.username),1),e("div",Le,[e("span",{class:ue(["user-status",a.status])},null,2),S(" "+d(a.status==="online"?"在线":"离线"),1)])]),t(C,{type:"text",size:"small",onClick:u(M=>$(a._id),"onClick"),class:"delete-btn"},{default:n(()=>s[11]||(s[11]=[S(" 删除 ",-1)])),_:2,__:[11]},1032,["onClick"])]))),128))])]),e("div",Pe,[e("div",Ie,[s[12]||(s[12]=e("span",null,"群组管理",-1)),e("span",Me,"("+d(_.value.length)+")",1)]),e("div",Ne,[(w(!0),h(H,null,J(_.value,a=>{var M;return w(),h("div",{key:a._id,class:"wechat-list-item"},[t(P,{src:a.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),e("div",De,[e("div",je,d(a.name),1),e("div",Ge,d(a.members.length)+"人",1)]),e("div",Oe,[t(ee,{type:((M=a.members.find(F=>{var E;return F.user._id===((E=Q(i).user)==null?void 0:E.id)}))==null?void 0:M.role)==="admin"?"danger":"info",size:"small"},{default:n(()=>{var F;return[S(d(((F=a.members.find(E=>{var W;return E.user._id===((W=Q(i).user)==null?void 0:W.id)}))==null?void 0:F.role)==="admin"?"管理员":"成员"),1)]}),_:2},1032,["type"])])])}),128))])]),e("div",We,[e("div",{class:"wechat-list-item logout-item",onClick:x},[t(A,null,{default:n(()=>[t(se)]),_:1}),s[13]||(s[13]=e("span",{class:"function-text"},"退出登录",-1))])])])]),t(ae,{modelValue:m.value,"onUpdate:modelValue":s[6]||(s[6]=a=>m.value=a),title:"编辑个人资料",width:"500px"},{footer:n(()=>[t(C,{onClick:s[5]||(s[5]=a=>m.value=!1)},{default:n(()=>s[14]||(s[14]=[S("取消",-1)])),_:1,__:[14]}),t(C,{type:"primary",onClick:L,loading:f.value},{default:n(()=>s[15]||(s[15]=[S(" 保存 ",-1)])),_:1,__:[15]},8,["loading"])]),default:n(()=>[t(te,{ref_key:"profileFormRef",ref:V,model:l,rules:T,"label-width":"80px"},{default:n(()=>[t(B,{label:"头像"},{default:n(()=>[t(he,{"current-avatar":l.avatar,size:"xlarge",onUploadSuccess:v,onUploadError:U},null,8,["current-avatar"])]),_:1}),t(B,{label:"用户名"},{default:n(()=>[t(I,{modelValue:l.username,"onUpdate:modelValue":s[2]||(s[2]=a=>l.username=a),disabled:""},null,8,["modelValue"])]),_:1}),t(B,{label:"邮箱"},{default:n(()=>[t(I,{modelValue:l.email,"onUpdate:modelValue":s[3]||(s[3]=a=>l.email=a),disabled:""},null,8,["modelValue"])]),_:1}),t(B,{label:"昵称",prop:"nickname"},{default:n(()=>[t(I,{modelValue:l.nickname,"onUpdate:modelValue":s[4]||(s[4]=a=>l.nickname=a),placeholder:"请输入昵称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Xe=X(qe,[["__scopeId","data-v-13488231"]]);export{Xe as default};
