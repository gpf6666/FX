var ge=Object.defineProperty;var r=(D,y)=>ge(D,"name",{value:y,configurable:!0});import{r as b,X as ke,h as ye,y as c,A as n,Q as t,I as l,al as _,K as h,u as m,O as g,P as T,a6 as P,z as d,H,M as f,D as Q,a4 as we,V as be}from"./vendor-Bqb8d2G-.js";import{E as k,a as Ce,c as Ve,m as $e,l as Me,s as X,b as xe,p as ze,d as Te}from"./element-BpKrs9tq.js";import{u as Pe,a as Be,b as $}from"./index-zIVw9yR6.js";import{_ as Ne}from"./_plugin-vue_export-helper-y4GvAF8u.js";const Se={class:"wechat-page"},Ue={class:"wechat-header moments-header-custom"},Ie={class:"wechat-content"},Le={class:"moments-header"},De={class:"user-profile"},Ee={class:"user-name"},Ke={class:"publish-moment"},Oe={class:"publish-card"},Ae={class:"publish-header"},Re={class:"moments-list"},je={class:"moment-header"},Fe={class:"moment-info"},qe={class:"moment-author"},He={class:"moment-time"},Qe={class:"moment-content"},Xe={key:0,class:"moment-images"},Ge=["onClick"],Je=["src","alt"],We={key:1,class:"moment-location"},Ye={class:"moment-actions"},Ze={class:"action-buttons"},et={key:2,class:"moment-likes"},tt={key:0},st={key:3,class:"moment-comments"},ot={class:"comment-author"},lt={key:0,class:"comment-reply"},at={class:"comment-content"},nt={key:4,class:"comment-input"},it={key:0,class:"load-more"},rt={key:1,class:"wechat-empty"},ut={class:"wechat-empty-icon"},dt={__name:"Moments",setup(D){const y=Pe(),G=Be(),v=b([]),M=b(!1),B=b(!1),E=b(!0),N=b(1),C=b(!1),S=b(null),V=b(""),p=ke({content:"",images:[],location:"",isPublic:!0}),U=r(async(o=!1)=>{if(!M.value){M.value=!0;try{o&&(N.value=1,v.value=[]);const e=await $.get("/api/moments",{params:{page:N.value,limit:10}});e.data.success&&(o?v.value=e.data.moments:v.value.push(...e.data.moments),E.value=e.data.moments.length===10,N.value++)}catch(e){console.error("获取朋友圈失败:",e),k.error("获取朋友圈失败")}finally{M.value=!1}}},"getMoments"),J=r(async()=>{if(!p.content.trim()){k.warning("请输入内容");return}B.value=!0;try{(await $.post("/api/moments",p)).data.success&&(k.success("发布成功"),C.value=!1,Object.assign(p,{content:"",images:[],location:"",isPublic:!0}),await U(!0))}catch(o){console.error("发布朋友圈失败:",o),k.error("发布失败")}finally{B.value=!1}},"publishMoment"),W=r(async o=>{try{const e=await $.post(`/api/moments/${o}/like`);if(e.data.success){const a=v.value.find(i=>i._id===o);a&&(a.likes=e.data.moment.likes)}}catch(e){console.error("操作失败:",e),k.error("操作失败")}},"toggleLike"),Y=r(o=>{S.value=o,V.value=""},"showCommentInput"),K=r(async o=>{if(!V.value.trim()){k.warning("请输入评论内容");return}try{const e=await $.post(`/api/moments/${o}/comment`,{content:V.value});if(e.data.success){const a=v.value.find(i=>i._id===o);a&&(a.comments=e.data.moment.comments),V.value="",S.value=null}}catch(e){console.error("评论失败:",e),k.error("评论失败")}},"submitComment"),Z=r(async(o,e)=>{try{const a=await $.delete(`/api/moments/${o}/comment/${e}`);if(a.data.success){const i=v.value.find(x=>x._id===o);i&&(i.comments=a.data.moment.comments),k.success("删除成功")}}catch(a){console.error("删除评论失败:",a),k.error("删除失败")}},"deleteComment"),ee=r(async o=>{try{(await $.delete(`/api/moments/${o}`)).data.success&&(v.value=v.value.filter(a=>a._id!==o),k.success("删除成功"))}catch(e){console.error("删除朋友圈失败:",e),k.error("删除失败")}},"deleteMoment"),te=r(o=>{o.action==="delete"&&Te.confirm("确定要删除这条朋友圈吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{ee(o.momentId)})},"handleMomentCommand"),se=r(o=>o.likes.some(e=>{var a;return e.user._id===((a=y.user)==null?void 0:a.id)}),"isLiked"),oe=r(o=>{const e=new Date,a=new Date(o),i=e-a;return i<6e4?"刚刚":i<36e5?`${Math.floor(i/6e4)}分钟前`:i<864e5?`${Math.floor(i/36e5)}小时前`:i<2592e6?`${Math.floor(i/864e5)}天前`:a.toLocaleDateString("zh-CN")},"formatTime"),le=r(o=>o===1?"single":o===2?"double":o===3?"triple":o===4?"quad":"grid","getImageClass"),ae=r(()=>{U()},"loadMore"),ne=r(o=>{p.images.push(URL.createObjectURL(o.raw))},"handleImageChange"),ie=r(o=>{const e=p.images.indexOf(o.url);e>-1&&p.images.splice(e,1)},"handleImageRemove"),re=r((o,e)=>{console.log("预览图片:",o[e])},"previewImage"),ue=r(o=>{v.value.unshift(o)},"handleNewMoment");return ye(async()=>{await U(!0),G.onNewMoment(ue)}),(o,e)=>{var A,R,j,F;const a=_("el-icon"),i=_("el-button"),x=_("el-avatar"),de=_("el-dropdown-item"),ce=_("el-dropdown-menu"),me=_("el-dropdown"),I=_("el-input"),z=_("el-form-item"),_e=_("Plus"),pe=_("el-upload"),O=_("el-radio"),fe=_("el-radio-group"),ve=_("el-form"),he=_("el-dialog");return d(),c("div",Se,[n("div",Ue,[t(i,{onClick:e[0]||(e[0]=s=>o.$router.push("/chat")),type:"text",size:"small",class:"header-btn-white"},{default:l(()=>[t(a,null,{default:l(()=>[t(m(Ce))]),_:1})]),_:1}),e[9]||(e[9]=n("div",{class:"wechat-header-title moments-title-white"},"朋友圈",-1)),t(i,{type:"text",size:"small",onClick:e[1]||(e[1]=s=>C.value=!0),class:"header-btn-white"},{default:l(()=>[t(a,null,{default:l(()=>[t(m(Ve))]),_:1})]),_:1})]),n("div",Ie,[n("div",Le,[e[10]||(e[10]=n("div",{class:"moments-cover"},[n("div",{class:"cover-image"})],-1)),n("div",De,[t(x,{src:(A=m(y).user)==null?void 0:A.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),n("div",Ee,g(((R=m(y).user)==null?void 0:R.nickname)||((j=m(y).user)==null?void 0:j.username)),1)])]),n("div",Ke,[n("div",Oe,[n("div",Ae,[t(x,{src:(F=m(y).user)==null?void 0:F.avatar,size:"small"},null,8,["src"]),n("div",{class:"publish-input",onClick:e[2]||(e[2]=s=>C.value=!0)},e[11]||(e[11]=[n("span",{class:"publish-placeholder"},"这一刻的想法...",-1)]))])])]),n("div",Re,[(d(!0),c(T,null,P(v.value,s=>{var q;return d(),c("div",{key:s._id,class:"moment-item"},[n("div",je,[t(x,{src:s.author.avatar,size:"small",class:"moment-avatar"},null,8,["src"]),n("div",Fe,[n("div",qe,g(s.author.nickname||s.author.username),1),n("div",He,g(oe(s.createdAt)),1)]),s.author._id===((q=m(y).user)==null?void 0:q.id)?(d(),H(me,{key:0,onCommand:te},{dropdown:l(()=>[t(ce,null,{default:l(()=>[t(de,{command:{action:"delete",momentId:s._id}},{default:l(()=>e[12]||(e[12]=[f(" 删除 ",-1)])),_:2,__:[12]},1032,["command"])]),_:2},1024)]),default:l(()=>[t(i,{type:"text",size:"small"},{default:l(()=>[t(a,null,{default:l(()=>[t(m($e))]),_:1})]),_:1})]),_:2},1024)):h("",!0)]),n("div",Qe,g(s.content),1),s.images&&s.images.length>0?(d(),c("div",Xe,[(d(!0),c(T,null,P(s.images,(u,w)=>(d(),c("div",{key:w,class:Q(["moment-image-wrapper",le(s.images.length)]),onClick:r(L=>re(s.images,w),"onClick")},[n("img",{src:u,alt:`朋友圈图片 ${w+1}`,class:"moment-image"},null,8,Je)],10,Ge))),128))])):h("",!0),s.location?(d(),c("div",We,[t(a,null,{default:l(()=>[t(m(Me))]),_:1}),f(" "+g(s.location),1)])):h("",!0),n("div",Ye,[n("div",Ze,[t(i,{type:"text",size:"small",class:Q({liked:se(s)}),onClick:r(u=>W(s._id),"onClick")},{default:l(()=>[t(a,null,{default:l(()=>[t(m(X))]),_:1}),f(" "+g(s.likes.length>0?s.likes.length:"")+" 赞 ",1)]),_:2},1032,["class","onClick"]),t(i,{type:"text",size:"small",onClick:r(u=>Y(s._id),"onClick")},{default:l(()=>[t(a,null,{default:l(()=>[t(m(xe))]),_:1}),f(" "+g(s.comments.length>0?s.comments.length:"")+" 评论 ",1)]),_:2},1032,["onClick"])])]),s.likes.length>0?(d(),c("div",et,[t(a,null,{default:l(()=>[t(m(X))]),_:1}),(d(!0),c(T,null,P(s.likes,(u,w)=>(d(),c("span",{key:u.user._id},[f(g(u.user.nickname||u.user.username)+" ",1),w<s.likes.length-1?(d(),c("span",tt,"、")):h("",!0)]))),128))])):h("",!0),s.comments.length>0?(d(),c("div",st,[(d(!0),c(T,null,P(s.comments,u=>{var w,L;return d(),c("div",{key:u._id,class:"comment-item"},[n("span",ot,g(u.user.nickname||u.user.username),1),u.replyTo?(d(),c("span",lt," 回复 "+g(u.replyTo.nickname||u.replyTo.username)+"： ",1)):h("",!0),n("span",at,g(u.content),1),u.user._id===((w=m(y).user)==null?void 0:w.id)||s.author._id===((L=m(y).user)==null?void 0:L.id)?(d(),H(i,{key:1,type:"text",size:"small",onClick:r(ct=>Z(s._id,u._id),"onClick")},{default:l(()=>e[13]||(e[13]=[f(" 删除 ",-1)])),_:2,__:[13]},1032,["onClick"])):h("",!0)])}),128))])):h("",!0),S.value===s._id?(d(),c("div",nt,[t(I,{modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=u=>V.value=u),placeholder:"写评论...",onKeydown:we(be(u=>K(s._id),["prevent"]),["enter"])},{append:l(()=>[t(i,{onClick:r(u=>K(s._id),"onClick")},{default:l(()=>e[14]||(e[14]=[f("发送",-1)])),_:2,__:[14]},1032,["onClick"])]),_:2},1032,["modelValue","onKeydown"])])):h("",!0)])}),128))]),E.value?(d(),c("div",it,[t(i,{onClick:ae,loading:M.value},{default:l(()=>e[15]||(e[15]=[f("加载更多",-1)])),_:1,__:[15]},8,["loading"])])):h("",!0),v.value.length===0&&!M.value?(d(),c("div",rt,[n("div",ut,[t(a,null,{default:l(()=>[t(m(ze))]),_:1})]),e[16]||(e[16]=n("p",null,"暂无朋友圈内容",-1))])):h("",!0)]),t(he,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=s=>C.value=s),title:"发布朋友圈",width:"600px"},{footer:l(()=>[t(i,{onClick:e[7]||(e[7]=s=>C.value=!1)},{default:l(()=>e[19]||(e[19]=[f("取消",-1)])),_:1,__:[19]}),t(i,{type:"primary",onClick:J,loading:B.value},{default:l(()=>e[20]||(e[20]=[f(" 发布 ",-1)])),_:1,__:[20]},8,["loading"])]),default:l(()=>[t(ve,{model:p,"label-width":"80px"},{default:l(()=>[t(z,{label:"内容"},{default:l(()=>[t(I,{modelValue:p.content,"onUpdate:modelValue":e[4]||(e[4]=s=>p.content=s),type:"textarea",rows:4,placeholder:"这一刻的想法..."},null,8,["modelValue"])]),_:1}),t(z,{label:"图片"},{default:l(()=>[t(pe,{action:"#","list-type":"picture-card","auto-upload":!1,"on-change":ne,"on-remove":ie,limit:9},{default:l(()=>[t(a,null,{default:l(()=>[t(_e)]),_:1})]),_:1})]),_:1}),t(z,{label:"位置"},{default:l(()=>[t(I,{modelValue:p.location,"onUpdate:modelValue":e[5]||(e[5]=s=>p.location=s),placeholder:"添加位置（可选）"},null,8,["modelValue"])]),_:1}),t(z,{label:"可见性"},{default:l(()=>[t(fe,{modelValue:p.isPublic,"onUpdate:modelValue":e[6]||(e[6]=s=>p.isPublic=s)},{default:l(()=>[t(O,{label:!0},{default:l(()=>e[17]||(e[17]=[f("公开",-1)])),_:1,__:[17]}),t(O,{label:!1},{default:l(()=>e[18]||(e[18]=[f("仅好友可见",-1)])),_:1,__:[18]})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ht=Ne(dt,[["__scopeId","data-v-eda14584"]]);export{ht as default};
