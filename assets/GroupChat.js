import{r as d,ad as ae,c as q,y as ne,B as a,D as s,W as l,V as $,aw as G,O as u,bm as y,cs as S,cy as re,C as n,Q as C,U as r,aa as F,S as w,P as ie,aZ as ue,G as ce}from"./vendor.js";import{u as de}from"./index.js";import{A as x}from"./Avatar.js";import{_ as me}from"./_plugin-vue_export-helper.js";import{E as f,a as pe}from"./element.js";const ve={class:"group-chat-page"},_e={class:"group-header"},fe={class:"header-actions"},ge={class:"group-content"},be={key:0,class:"group-list"},he=["onClick"],ke={class:"group-avatar"},ye={key:0,class:"unread-badge"},Ce={class:"group-info"},we={class:"group-name"},xe={class:"group-members"},Me={class:"group-last-message"},Ve={class:"group-time"},$e={key:1,class:"empty-state"},Ge={class:"member-selector"},Se={class:"selected-members"},Be=["onClick"],De={class:"member-selector-content"},Ue={class:"search-box"},ze={class:"member-list"},Fe={key:0,class:"empty-members"},Te=["onClick"],Ae={class:"member-avatar"},Ee={class:"member-info"},Ie={class:"member-name"},Le={class:"member-username"},Ne={class:"member-check"},Re={key:0,class:"iconfont icon-check"},qe={key:0,class:"group-detail"},Ke={class:"group-header-info"},Oe={class:"group-info-detail"},Pe={class:"group-members-list"},Qe={class:"members-grid"},We={class:"member-name"},Ze={class:"member-role"},je={class:"group-actions"},He={__name:"GroupChat",setup(Je){const T=re(),A=de(),B=d([]),h=d([]),b=d(!1),g=d(!1),D=d(!1),M=d(!1),k=d(""),m=d([]),p=d([]),v=d(null),E=d(),_=ae({name:"",description:""}),K={name:[{required:!0,message:"请输入群组名称",trigger:"blur"},{min:2,max:20,message:"群组名称长度在2-20个字符",trigger:"blur"}],description:[{max:100,message:"群组描述不能超过100个字符",trigger:"blur"}]},I=q(()=>k.value?h.value.filter(o=>(o.nickname||o.username).toLowerCase().includes(k.value.toLowerCase())):h.value),O=q(()=>!v.value||!A.user?!1:v.value.members.some(o=>o.user._id===A.user.id&&o.role==="admin")),P=()=>{T.back()},U=async()=>{try{const o=await S.get("/api/chats/groups");o.data.success&&(B.value=o.data.groups)}catch(o){console.error("获取群组列表失败:",o),f.error("获取群组列表失败")}},L=async()=>{try{const o=await S.get("/api/users/friends/list");o.data.success&&(h.value=o.data.friends)}catch(o){console.error("获取好友列表失败:",o)}},Q=o=>{T.push(`/chat?group=${o._id}`)},W=async()=>{var o,e;try{if(await E.value.validate(),m.value.length===0){f.warning("请至少选择一个成员");return}M.value=!0,(await S.post("/api/chats/groups",{name:_.name,description:_.description,members:m.value.map(i=>i._id)})).data.success&&(f.success("群组创建成功"),b.value=!1,_.name="",_.description="",m.value=[],p.value=[],await U())}catch(c){(e=(o=c.response)==null?void 0:o.data)!=null&&e.message?f.error(c.response.data.message):f.error("创建群组失败")}finally{M.value=!1}},Z=()=>{},j=o=>{const e=p.value.findIndex(c=>c._id===o._id);e!==-1?p.value.splice(e,1):p.value.push(o)},N=o=>p.value.some(e=>e._id===o),H=o=>{const e=m.value.findIndex(c=>c._id===o);e!==-1&&m.value.splice(e,1)},J=async()=>{try{console.log("开始打开成员选择器"),g.value=!0,h.value.length===0&&(console.log("好友列表为空，开始加载..."),await L(),console.log("好友列表加载完成，数量:",h.value.length)),p.value=[...m.value],console.log("成员选择器打开完成，当前选中成员数:",p.value.length)}catch(o){console.error("打开成员选择器失败:",o),f.error("打开成员选择器失败"),g.value=!1}},X=()=>{p.value=[],g.value=!1,console.log("取消成员选择")},Y=()=>{m.value=[...p.value],g.value=!1,console.log("确认成员选择，选中成员数:",m.value.length)},ee=()=>{f.info("编辑群组功能开发中")},se=async()=>{try{await pe.confirm("确定要退出该群组吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await S.post(`/api/chats/groups/${v.value._id}/leave`)).data.success&&(f.success("已退出群组"),D.value=!1,await U())}catch(o){o!=="cancel"&&f.error("退出群组失败")}},te=o=>{if(!o)return"";const e=new Date(o),i=new Date-e;return i<6e4?"刚刚":i<36e5?`${Math.floor(i/6e4)}分钟前`:i<864e5?`${Math.floor(i/36e5)}小时前`:i<2592e6?`${Math.floor(i/864e5)}天前`:e.toLocaleDateString()};ne(()=>{U(),L()});const oe=o=>{console.log("成员选择器即将关闭"),g.value&&o()};return(o,e)=>{const c=y("el-input"),i=y("el-form-item"),le=y("el-form"),V=y("el-button"),z=y("el-dialog");return n(),a("div",ve,[s("div",_e,[s("button",{class:"back-btn",onClick:P,"aria-label":"返回"},e[10]||(e[10]=[s("i",{class:"iconfont icon-back"},null,-1)])),e[13]||(e[13]=s("h2",null,"群聊",-1)),s("div",fe,[s("button",{class:"test-btn",onClick:e[0]||(e[0]=t=>o.$router.push("/test-group-avatar")),"aria-label":"测试群组头像"},e[11]||(e[11]=[s("i",{class:"iconfont icon-group"},null,-1)])),s("button",{class:"create-btn",onClick:e[1]||(e[1]=t=>b.value=!0),"aria-label":"创建群组"},e[12]||(e[12]=[s("i",{class:"iconfont icon-add"},null,-1)]))])]),s("div",ge,[B.value.length>0?(n(),a("div",be,[(n(!0),a($,null,G(B.value,t=>(n(),a("div",{key:t._id,class:"group-item",onClick:R=>Q(t)},[s("div",ke,[l(x,{src:t.avatar,size:"medium"},null,8,["src"]),t.unreadCount>0?(n(),a("div",ye,r(t.unreadCount>99?"99+":t.unreadCount),1)):C("",!0)]),s("div",Ce,[s("div",we,r(t.name),1),s("div",xe,r(t.members.length)+"人",1),s("div",Me,r(t.lastMessage||"暂无消息"),1)]),s("div",Ve,r(te(t.lastMessageTime)),1)],8,he))),128))])):(n(),a("div",$e,[e[14]||(e[14]=s("div",{class:"empty-icon"},[s("i",{class:"iconfont icon-group"})],-1)),e[15]||(e[15]=s("p",null,"暂无群组",-1)),s("button",{class:"create-group-btn",onClick:e[2]||(e[2]=t=>b.value=!0)}," 创建群组 ")]))]),l(z,{modelValue:b.value,"onUpdate:modelValue":e[6]||(e[6]=t=>b.value=t),title:"创建群组",width:"500px","close-on-click-modal":!1},{footer:u(()=>[l(V,{onClick:e[5]||(e[5]=t=>b.value=!1)},{default:u(()=>e[17]||(e[17]=[w("取消",-1)])),_:1,__:[17]}),l(V,{type:"primary",onClick:W,loading:M.value},{default:u(()=>[w(r(M.value?"创建中...":"创建"),1)]),_:1},8,["loading"])]),default:u(()=>[l(le,{model:_,rules:K,ref_key:"groupFormRef",ref:E},{default:u(()=>[l(i,{label:"群组名称",prop:"name"},{default:u(()=>[l(c,{modelValue:_.name,"onUpdate:modelValue":e[3]||(e[3]=t=>_.name=t),placeholder:"请输入群组名称"},null,8,["modelValue"])]),_:1}),l(i,{label:"群组描述",prop:"description"},{default:u(()=>[l(c,{modelValue:_.description,"onUpdate:modelValue":e[4]||(e[4]=t=>_.description=t),type:"textarea",placeholder:"请输入群组描述",rows:3},null,8,["modelValue"])]),_:1}),l(i,{label:"选择成员"},{default:u(()=>[s("div",Ge,[s("div",Se,[(n(!0),a($,null,G(m.value,t=>(n(),a("div",{key:t._id,class:"selected-member"},[l(x,{src:t.avatar,size:"small"},null,8,["src"]),s("span",null,r(t.nickname||t.username),1),s("button",{type:"button",class:"remove-member",onClick:F(R=>H(t._id),["stop","prevent"]),"aria-label":"移除成员"}," × ",8,Be)]))),128))]),s("button",{type:"button",class:"add-member-btn",onClick:F(J,["stop","prevent"])},e[16]||(e[16]=[s("i",{class:"iconfont icon-add"},null,-1),w(" 添加成员 ",-1)]))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(z,{modelValue:g.value,"onUpdate:modelValue":e[8]||(e[8]=t=>g.value=t),title:"选择成员",width:"600px","append-to-body":!0,"close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":oe},{footer:u(()=>[l(V,{onClick:X},{default:u(()=>e[20]||(e[20]=[w("取消",-1)])),_:1,__:[20]}),l(V,{type:"primary",onClick:Y},{default:u(()=>e[21]||(e[21]=[w("确定",-1)])),_:1,__:[21]})]),default:u(()=>[s("div",De,[s("div",Ue,[e[18]||(e[18]=s("i",{class:"iconfont icon-search"},null,-1)),ie(s("input",{"onUpdate:modelValue":e[7]||(e[7]=t=>k.value=t),type:"text",placeholder:"搜索好友",onInput:Z},null,544),[[ue,k.value]])]),s("div",ze,[I.value.length===0?(n(),a("div",Fe,[e[19]||(e[19]=s("div",{class:"empty-icon"},[s("i",{class:"iconfont icon-user"})],-1)),s("p",null,r(k.value?"没有找到匹配的好友":"暂无好友"),1)])):C("",!0),(n(!0),a($,null,G(I.value,t=>(n(),a("div",{key:t._id,class:ce(["member-item",{selected:N(t._id)}]),onClick:F(R=>j(t),["stop"])},[s("div",Ae,[l(x,{src:t.avatar,size:"small"},null,8,["src"])]),s("div",Ee,[s("div",Ie,r(t.nickname||t.username),1),s("div",Le,"@"+r(t.username),1)]),s("div",Ne,[N(t._id)?(n(),a("i",Re)):C("",!0)])],10,Te))),128))])])]),_:1},8,["modelValue"]),l(z,{modelValue:D.value,"onUpdate:modelValue":e[9]||(e[9]=t=>D.value=t),title:"群组详情",width:"600px"},{default:u(()=>[v.value?(n(),a("div",qe,[s("div",Ke,[l(x,{src:v.value.avatar,size:"xlarge"},null,8,["src"]),s("div",Oe,[s("h3",null,r(v.value.name),1),s("p",null,r(v.value.description||"暂无描述"),1),s("p",null,"群成员："+r(v.value.members.length)+"人",1)])]),s("div",Pe,[e[22]||(e[22]=s("h4",null,"群成员",-1)),s("div",Qe,[(n(!0),a($,null,G(v.value.members,t=>(n(),a("div",{key:t.user._id,class:"member-card"},[l(x,{src:t.user.avatar,size:"medium"},null,8,["src"]),s("div",We,r(t.user.nickname||t.user.username),1),s("div",Ze,r(t.role==="admin"?"管理员":"成员"),1)]))),128))])]),s("div",je,[O.value?(n(),a("button",{key:0,class:"action-btn edit-btn",onClick:ee}," 编辑群组 ")):C("",!0),s("button",{class:"action-btn leave-btn",onClick:se}," 退出群组 ")])])):C("",!0)]),_:1},8,["modelValue"])])}}},os=me(He,[["__scopeId","data-v-25248d73"]]);export{os as default};
