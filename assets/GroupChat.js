var re=Object.defineProperty;var l=(A,V)=>re(A,"name",{value:V,configurable:!0});import{u as ie,r as m,a as ue,l as K,n as ce,c as n,b as s,e as a,F as S,s as z,w as c,f as C,z as B,E as g,h as de,o as r,p as w,t as i,g as L,j as x,q as me,v as ve,x as pe,L as _e}from"./index.js";import{A as M}from"./Avatar.js";import{_ as fe}from"./_plugin-vue_export-helper.js";const ge={class:"group-chat-page"},be={class:"group-header"},he={class:"header-actions"},ke={class:"group-content"},ye={key:0,class:"group-list"},Ce=["onClick"],we={class:"group-avatar"},xe={key:0,class:"unread-badge"},Me={class:"group-info"},Ve={class:"group-name"},$e={class:"group-members"},Ge={class:"group-last-message"},Se={class:"group-time"},ze={key:1,class:"empty-state"},Be={class:"member-selector"},De={class:"selected-members"},Fe=["onClick"],Te={class:"member-selector-content"},Ue={class:"search-box"},Le={class:"member-list"},Ae={key:0,class:"empty-members"},Ee=["onClick"],Ie={class:"member-avatar"},Ne={class:"member-info"},Re={class:"member-name"},qe={class:"member-username"},je={class:"member-check"},Ke={key:0,class:"iconfont icon-check"},He={key:0,class:"group-detail"},Je={class:"group-header-info"},Oe={class:"group-info-detail"},Pe={class:"group-members-list"},Qe={class:"members-grid"},We={class:"member-name"},Xe={class:"member-role"},Ye={class:"group-actions"},Ze={__name:"GroupChat",setup(A){const V=de(),E=ie(),D=m([]),k=m([]),h=m(!1),b=m(!1),F=m(!1),$=m(!1),y=m(""),v=m([]),p=m([]),_=m(null),I=m(),f=ue({name:"",description:""}),H={name:[{required:!0,message:"请输入群组名称",trigger:"blur"},{min:2,max:20,message:"群组名称长度在2-20个字符",trigger:"blur"}],description:[{max:100,message:"群组描述不能超过100个字符",trigger:"blur"}]},N=K(()=>y.value?k.value.filter(o=>(o.nickname||o.username).toLowerCase().includes(y.value.toLowerCase())):k.value),J=K(()=>!_.value||!E.user?!1:_.value.members.some(o=>o.user._id===E.user.id&&o.role==="admin")),O=l(()=>{V.back()},"goBack"),T=l(async()=>{try{const o=await B.get("/api/chats/groups");o.data.success&&(D.value=o.data.groups)}catch(o){console.error("获取群组列表失败:",o),g.error("获取群组列表失败")}},"getGroups"),R=l(async()=>{try{const o=await B.get("/api/users/friends/list");o.data.success&&(k.value=o.data.friends)}catch(o){console.error("获取好友列表失败:",o)}},"getFriends"),P=l(o=>{V.push(`/chat?group=${o._id}`)},"selectGroup"),Q=l(async()=>{var o,e;try{if(await I.value.validate(),v.value.length===0){g.warning("请至少选择一个成员");return}$.value=!0,(await B.post("/api/chats/groups",{name:f.name,description:f.description,members:v.value.map(u=>u._id)})).data.success&&(g.success("群组创建成功"),h.value=!1,f.name="",f.description="",v.value=[],p.value=[],await T())}catch(d){(e=(o=d.response)==null?void 0:o.data)!=null&&e.message?g.error(d.response.data.message):g.error("创建群组失败")}finally{$.value=!1}},"createGroup"),W=l(()=>{},"searchMembers"),X=l(o=>{const e=p.value.findIndex(d=>d._id===o._id);e!==-1?p.value.splice(e,1):p.value.push(o)},"toggleMember"),q=l(o=>p.value.some(e=>e._id===o),"isMemberSelected"),Y=l(o=>{const e=v.value.findIndex(d=>d._id===o);e!==-1&&v.value.splice(e,1)},"removeMember"),Z=l(async()=>{try{console.log("开始打开成员选择器"),b.value=!0,k.value.length===0&&(console.log("好友列表为空，开始加载..."),await R(),console.log("好友列表加载完成，数量:",k.value.length)),p.value=[...v.value],console.log("成员选择器打开完成，当前选中成员数:",p.value.length)}catch(o){console.error("打开成员选择器失败:",o),g.error("打开成员选择器失败"),b.value=!1}},"openMemberSelector"),ee=l(()=>{p.value=[],b.value=!1,console.log("取消成员选择")},"cancelMemberSelection"),se=l(()=>{v.value=[...p.value],b.value=!1,console.log("确认成员选择，选中成员数:",v.value.length)},"confirmMembers"),te=l(()=>{g.info("编辑群组功能开发中")},"editGroup"),oe=l(async()=>{try{await _e.confirm("确定要退出该群组吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await B.post(`/api/chats/groups/${_.value._id}/leave`)).data.success&&(g.success("已退出群组"),F.value=!1,await T())}catch(o){o!=="cancel"&&g.error("退出群组失败")}},"leaveGroup"),le=l(o=>{if(!o)return"";const e=new Date(o),u=new Date-e;return u<6e4?"刚刚":u<36e5?`${Math.floor(u/6e4)}分钟前`:u<864e5?`${Math.floor(u/36e5)}小时前`:u<2592e6?`${Math.floor(u/864e5)}天前`:e.toLocaleDateString()},"formatTime");ce(()=>{T(),R()});const ae=l(o=>{console.log("成员选择器即将关闭"),b.value&&o()},"handleMemberSelectorClose");return(o,e)=>{const d=C("el-input"),u=C("el-form-item"),ne=C("el-form"),G=C("el-button"),U=C("el-dialog");return r(),n("div",ge,[s("div",be,[s("button",{class:"back-btn",onClick:O,"aria-label":"返回"},e[10]||(e[10]=[s("i",{class:"iconfont icon-back"},null,-1)])),e[13]||(e[13]=s("h2",null,"群聊",-1)),s("div",he,[s("button",{class:"test-btn",onClick:e[0]||(e[0]=t=>o.$router.push("/test-group-avatar")),"aria-label":"测试群组头像"},e[11]||(e[11]=[s("i",{class:"iconfont icon-group"},null,-1)])),s("button",{class:"create-btn",onClick:e[1]||(e[1]=t=>h.value=!0),"aria-label":"创建群组"},e[12]||(e[12]=[s("i",{class:"iconfont icon-add"},null,-1)]))])]),s("div",ke,[D.value.length>0?(r(),n("div",ye,[(r(!0),n(S,null,z(D.value,t=>(r(),n("div",{key:t._id,class:"group-item",onClick:l(j=>P(t),"onClick")},[s("div",we,[a(M,{src:t.avatar,size:"medium"},null,8,["src"]),t.unreadCount>0?(r(),n("div",xe,i(t.unreadCount>99?"99+":t.unreadCount),1)):w("",!0)]),s("div",Me,[s("div",Ve,i(t.name),1),s("div",$e,i(t.members.length)+"人",1),s("div",Ge,i(t.lastMessage||"暂无消息"),1)]),s("div",Se,i(le(t.lastMessageTime)),1)],8,Ce))),128))])):(r(),n("div",ze,[e[14]||(e[14]=s("div",{class:"empty-icon"},[s("i",{class:"iconfont icon-group"})],-1)),e[15]||(e[15]=s("p",null,"暂无群组",-1)),s("button",{class:"create-group-btn",onClick:e[2]||(e[2]=t=>h.value=!0)}," 创建群组 ")]))]),a(U,{modelValue:h.value,"onUpdate:modelValue":e[6]||(e[6]=t=>h.value=t),title:"创建群组",width:"500px","close-on-click-modal":!1},{footer:c(()=>[a(G,{onClick:e[5]||(e[5]=t=>h.value=!1)},{default:c(()=>e[17]||(e[17]=[x("取消",-1)])),_:1,__:[17]}),a(G,{type:"primary",onClick:Q,loading:$.value},{default:c(()=>[x(i($.value?"创建中...":"创建"),1)]),_:1},8,["loading"])]),default:c(()=>[a(ne,{model:f,rules:H,ref_key:"groupFormRef",ref:I},{default:c(()=>[a(u,{label:"群组名称",prop:"name"},{default:c(()=>[a(d,{modelValue:f.name,"onUpdate:modelValue":e[3]||(e[3]=t=>f.name=t),placeholder:"请输入群组名称"},null,8,["modelValue"])]),_:1}),a(u,{label:"群组描述",prop:"description"},{default:c(()=>[a(d,{modelValue:f.description,"onUpdate:modelValue":e[4]||(e[4]=t=>f.description=t),type:"textarea",placeholder:"请输入群组描述",rows:3},null,8,["modelValue"])]),_:1}),a(u,{label:"选择成员"},{default:c(()=>[s("div",Be,[s("div",De,[(r(!0),n(S,null,z(v.value,t=>(r(),n("div",{key:t._id,class:"selected-member"},[a(M,{src:t.avatar,size:"small"},null,8,["src"]),s("span",null,i(t.nickname||t.username),1),s("button",{type:"button",class:"remove-member",onClick:L(j=>Y(t._id),["stop","prevent"]),"aria-label":"移除成员"}," × ",8,Fe)]))),128))]),s("button",{type:"button",class:"add-member-btn",onClick:L(Z,["stop","prevent"])},e[16]||(e[16]=[s("i",{class:"iconfont icon-add"},null,-1),x(" 添加成员 ",-1)]))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(U,{modelValue:b.value,"onUpdate:modelValue":e[8]||(e[8]=t=>b.value=t),title:"选择成员",width:"600px","append-to-body":!0,"close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":ae},{footer:c(()=>[a(G,{onClick:ee},{default:c(()=>e[20]||(e[20]=[x("取消",-1)])),_:1,__:[20]}),a(G,{type:"primary",onClick:se},{default:c(()=>e[21]||(e[21]=[x("确定",-1)])),_:1,__:[21]})]),default:c(()=>[s("div",Te,[s("div",Ue,[e[18]||(e[18]=s("i",{class:"iconfont icon-search"},null,-1)),me(s("input",{"onUpdate:modelValue":e[7]||(e[7]=t=>y.value=t),type:"text",placeholder:"搜索好友",onInput:W},null,544),[[ve,y.value]])]),s("div",Le,[N.value.length===0?(r(),n("div",Ae,[e[19]||(e[19]=s("div",{class:"empty-icon"},[s("i",{class:"iconfont icon-user"})],-1)),s("p",null,i(y.value?"没有找到匹配的好友":"暂无好友"),1)])):w("",!0),(r(!0),n(S,null,z(N.value,t=>(r(),n("div",{key:t._id,class:pe(["member-item",{selected:q(t._id)}]),onClick:L(j=>X(t),["stop"])},[s("div",Ie,[a(M,{src:t.avatar,size:"small"},null,8,["src"])]),s("div",Ne,[s("div",Re,i(t.nickname||t.username),1),s("div",qe,"@"+i(t.username),1)]),s("div",je,[q(t._id)?(r(),n("i",Ke)):w("",!0)])],10,Ee))),128))])])]),_:1},8,["modelValue"]),a(U,{modelValue:F.value,"onUpdate:modelValue":e[9]||(e[9]=t=>F.value=t),title:"群组详情",width:"600px"},{default:c(()=>[_.value?(r(),n("div",He,[s("div",Je,[a(M,{src:_.value.avatar,size:"xlarge"},null,8,["src"]),s("div",Oe,[s("h3",null,i(_.value.name),1),s("p",null,i(_.value.description||"暂无描述"),1),s("p",null,"群成员："+i(_.value.members.length)+"人",1)])]),s("div",Pe,[e[22]||(e[22]=s("h4",null,"群成员",-1)),s("div",Qe,[(r(!0),n(S,null,z(_.value.members,t=>(r(),n("div",{key:t.user._id,class:"member-card"},[a(M,{src:t.user.avatar,size:"medium"},null,8,["src"]),s("div",We,i(t.user.nickname||t.user.username),1),s("div",Xe,i(t.role==="admin"?"管理员":"成员"),1)]))),128))])]),s("div",Ye,[J.value?(r(),n("button",{key:0,class:"action-btn edit-btn",onClick:te}," 编辑群组 ")):w("",!0),s("button",{class:"action-btn leave-btn",onClick:oe}," 退出群组 ")])])):w("",!0)]),_:1},8,["modelValue"])])}}},ls=fe(Ze,[["__scopeId","data-v-b4186a2c"]]);export{ls as default};
