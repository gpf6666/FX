var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,i=(a,t,s)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s,u=(e,a)=>{for(var t in a||(a={}))n.call(a,t)&&i(e,t,a[t]);if(s)for(var t of s(a))l.call(a,t)&&i(e,t,a[t]);return e},o=(e,s)=>a(e,t(s)),c=(e,a,t)=>new Promise(((s,n)=>{var l=e=>{try{u(t.next(e))}catch(a){n(a)}},i=e=>{try{u(t.throw(e))}catch(a){n(a)}},u=e=>e.done?s(e.value):Promise.resolve(e.value).then(l,i);u((t=t.apply(e,a)).next())}));import{r,c as d,j as v,h as p,y as g,A as m,K as h,Q as f,u as y,J as b,aj as k,P as w,a6 as C,O as _,M as D,D as S,a4 as M,V as j,n as x,aC as I,z as T}from"./vendor-BU-zYVMe.js";import{u as A,a as z,b as $}from"./index-zPCyQuwE.js";import{A as O}from"./Avatar-BggJlZXq.js";import{_ as L}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{E as N}from"./element-LGSq3epL.js";const P={class:"wechat-container"},E={class:"sidebar"},K={class:"sidebar-header"},U={class:"user-avatar"},V={class:"search-box"},F={class:"search-input"},H={class:"chat-list"},G=["onClick"],J={class:"chat-avatar"},Q={key:0,class:"unread-badge"},q={class:"chat-info"},B={class:"chat-name"},R={class:"chat-last-message"},W={class:"chat-time"},X={class:"main-chat"},Y={key:0,class:"chat-area"},Z={class:"chat-header"},ee={class:"chat-title"},ae={key:0,class:"online-status"},te={class:"chat-actions"},se={class:"messages-wrapper"},ne={key:0,class:"load-more"},le=["disabled"],ie={key:0,class:"time-divider"},ue={key:0,class:"message-avatar"},oe={key:1,class:"message-avatar-placeholder"},ce={class:"message-content"},re={class:"message-bubble"},de={class:"message-text"},ve={class:"message-status"},pe={class:"message-time"},ge={key:0,class:"message-status-icon"},me={key:0,class:"iconfont icon-loading"},he={key:1,class:"iconfont icon-check"},fe={key:2,class:"iconfont icon-check-double"},ye={class:"input-area"},be={class:"input-toolbar"},ke={class:"input-container"},we=["onKeydown"],Ce=["disabled"],_e={key:1,class:"welcome-page"},De={key:0,class:"emoji-picker"},Se={class:"emoji-list"},Me=["onClick"],je={key:2,class:"voice-recorder"},xe={class:"voice-modal"},Ie={class:"voice-content"},Te=20,Ae=L({__name:"Chat",setup(e){const a=I(),t=A(),s=z(),n=r(null),l=r([]),i=r(""),L=r(""),Ae=r(!1),ze=r(!1),$e=r(!1);r(!1),r(!1);const Oe=r(!1),Le=r(),Ne=r(),Pe=r(),Ee=r(!1),Ke=r(!0),Ue=r(1),Ve=r([]),Fe=r([]),He=r([]),Ge=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕","🤑","🤠"],Je=d((()=>L.value?Ve.value.filter((e=>e.name.toLowerCase().includes(L.value.toLowerCase()))):Ve.value)),Qe=d((()=>Ve.value.reduce(((e,a)=>e+(a.unreadCount||0)),0)));v(Qe,(e=>{document.title=e>0?`(${e}) FEI信`:"FEI信"}));const qe=()=>c(this,null,(function*(){try{const e=yield $.get("/api/users/friends/list");e.data.success&&(Fe.value=e.data.friends);const a=yield $.get("/api/chats/groups");a.data.success&&(He.value=a.data.groups);const t=yield $.get("/api/chats/unread-count");let s={};t.data.success&&(s=t.data.unreadCount);const n=[];Fe.value.forEach((e=>{n.push({type:"private",id:e._id,name:e.nickname||e.username,avatar:e.avatar,lastMessage:e.lastMessage||"",lastTime:e.lastMessageTime,unreadCount:s[e._id]||0})})),He.value.forEach((e=>{n.push({type:"group",id:e._id,name:e.name,avatar:e.avatar,lastMessage:e.lastMessage||"",lastTime:e.lastMessageTime,unreadCount:s[e._id]||0})})),n.sort(((e,a)=>new Date(a.lastTime||0)-new Date(e.lastTime||0))),Ve.value=n}catch(e){}})),Be=e=>c(this,null,(function*(){n.value=e,l.value=[],Ue.value=1,Ke.value=!0,Re(e.type,e.id);try{let a;if(a="private"===e.type?yield $.get(`/api/chats/private/${e.id}?page=${Ue.value}&limit=20`):yield $.get(`/api/chats/groups/${e.id}?page=${Ue.value}&limit=20`),a.data.success){const e=a.data.messages.sort(((e,a)=>new Date(e.createdAt)-new Date(a.createdAt)));e.forEach(((e,a)=>{})),l.value=e,Ke.value=a.data.messages.length===Te,yield x(),sa()}}catch(a){N.error("获取消息失败")}})),Re=(e,a)=>{const t=Ve.value.findIndex((t=>t.type===e&&String(t.id)===String(a)));-1!==t&&(Ve.value[t].unreadCount=0)},We=()=>c(this,null,(function*(){if(!Ee.value&&Ke.value){Ee.value=!0,Ue.value++;try{let e;if(e="private"===n.value.type?yield $.get(`/api/chats/private/${n.value.id}?page=${Ue.value}&limit=20`):yield $.get(`/api/chats/groups/${n.value.id}?page=${Ue.value}&limit=20`),e.data.success){const a=e.data.messages.reverse();l.value.unshift(...a),Ke.value=a.length===Te}}catch(e){Ue.value--}finally{Ee.value=!1}}})),Xe=()=>c(this,null,(function*(){var e,a,s,c,r;if(!i.value.trim()||!n.value)return;const d={content:i.value,timestamp:new Date,status:"sending"},v={_id:Date.now().toString(),content:i.value,sender:{_id:(null==(e=t.user)?void 0:e.id)||(null==(a=t.user)?void 0:a._id),username:null==(s=t.user)?void 0:s.username,nickname:null==(c=t.user)?void 0:c.nickname,avatar:null==(r=t.user)?void 0:r.avatar},createdAt:new Date,status:"sending"};l.value.push(v),i.value="",yield x(),sa();try{let e;if(e="private"===n.value.type?yield $.post("/api/chats/private",{receiver:n.value.id,content:d.content}):yield $.post(`/api/chats/groups/${n.value.id}`,{content:d.content}),e.data.success){const a=l.value.findIndex((e=>e._id===v._id));-1!==a&&(l.value[a]=o(u({},e.data.message),{status:"sent",_id:e.data.message._id})),((e,a,t)=>{const s=Ve.value.findIndex((t=>t.type===e&&String(t.id)===String(a)));if(-1!==s){Ve.value[s].lastMessage=t,Ve.value[s].lastTime=new Date;const e=Ve.value.splice(s,1)[0];Ve.value.unshift(e)}})(n.value.type,n.value.id,v.content)}}catch(p){N.error("发送消息失败");const e=l.value.findIndex((e=>e._id===v._id));-1!==e&&(l.value[e].status="failed")}})),Ye=()=>{a.push("/profile")},Ze=()=>{a.push("/settings")},ea=()=>{a.push("/add-friend")},aa=()=>{a.push("/group-chat")},ta=()=>{a.push("/moments")},sa=()=>{Le.value&&(Le.value.scrollTop=Le.value.scrollHeight)},na=()=>{const e=Ne.value;e&&(e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px")},la=e=>{e.target.files[0];ze.value=!1},ia=()=>{},ua=()=>{$e.value=!1},oa=()=>{},ca=e=>{const a=Fe.value.find((a=>a._id===e));return(null==a?void 0:a.status)||"offline"},ra=e=>{const a=new Date(e),t=new Date-a;return t<6e4?"刚刚":t<36e5?Math.floor(t/6e4)+"分钟前":t<864e5?Math.floor(t/36e5)+"小时前":a.toLocaleDateString("zh-CN")},da=e=>{const a=new Date(e),t=new Date;return a.toDateString()===t.toDateString()?a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):a.toDateString()===new Date(t-864e5).toDateString()?"昨天 "+a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):a.toLocaleDateString("zh-CN")+" "+a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})},va=e=>{if(!e)return"";const a=new Date(e),t=new Date;return a.toDateString()===t.toDateString()?a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):a.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},pa=(e,a)=>{if(!a)return!0;return new Date(e.createdAt)-new Date(a.createdAt)>3e5},ga=(e,a)=>{if(!a)return!1;const t=new Date(e.createdAt)-new Date(a.createdAt);return e.sender._id===a.sender._id&&t<3e5},ma=e=>{n.value&&"private"===n.value.type&&String(e.sender._id)===String(n.value.id)&&!ya(e)&&(l.value.push(o(u({},e),{status:"received"})),x((()=>sa()))),fa("private",e.sender._id,e)},ha=e=>{n.value&&"group"===n.value.type&&String(e.group)===String(n.value.id)&&!ya(e)&&(l.value.push(o(u({},e),{status:"received"})),x((()=>sa()))),fa("group",e.group,e)},fa=(e,a,t)=>{if(n.value&&n.value.type===e&&String(n.value.id)===String(a))return;const s=Ve.value.findIndex((t=>t.type===e&&String(t.id)===String(a)));if(-1!==s){Ve.value[s].unreadCount=(Ve.value[s].unreadCount||0)+1,Ve.value[s].lastMessage=t.content,Ve.value[s].lastTime=t.createdAt;const e=Ve.value.splice(s,1)[0];Ve.value.unshift(e)}},ya=e=>{var a,s;const n=(null==(a=t.user)?void 0:a.id)||(null==(s=t.user)?void 0:s._id),l=e.sender._id||e.sender.id;return String(n)===String(l)},ba=e=>{const a=Fe.value.find((a=>a._id===e.userId));a&&(a.status=e.status)};return p((()=>c(this,null,(function*(){var e,a,n,l;((null==(e=t.user)?void 0:e.id)||(null==(a=t.user)?void 0:a._id))&&s.connect((null==(n=t.user)?void 0:n.id)||(null==(l=t.user)?void 0:l._id)),yield qe(),s.onNewMessage(ma),s.onNewGroupMessage(ha),s.onUserStatus(ba)})))),v(l,(()=>{x((()=>sa()))})),(e,a)=>{var s;return T(),g("div",P,[m("div",E,[m("div",K,[m("div",U,[f(O,{src:null==(s=y(t).user)?void 0:s.avatar,size:"medium"},null,8,["src"])]),m("div",{class:"user-actions"},[m("button",{class:"action-btn",onClick:Ye,"aria-label":"个人资料"},a[6]||(a[6]=[m("i",{class:"iconfont icon-user"},null,-1)])),m("button",{class:"action-btn",onClick:Ze,"aria-label":"设置"},a[7]||(a[7]=[m("i",{class:"iconfont icon-settings"},null,-1)]))])]),m("div",V,[m("div",F,[a[8]||(a[8]=m("i",{class:"iconfont icon-search"},null,-1)),b(m("input",{"onUpdate:modelValue":a[0]||(a[0]=e=>L.value=e),type:"text",placeholder:"搜索",onInput:oa},null,544),[[k,L.value]])])]),m("div",{class:"function-buttons"},[m("button",{class:"function-btn",onClick:ea,"aria-label":"添加好友"},a[9]||(a[9]=[m("i",{class:"iconfont icon-add"},null,-1),m("span",null,"添加好友",-1)])),m("button",{class:"function-btn",onClick:aa,"aria-label":"群聊"},a[10]||(a[10]=[m("i",{class:"iconfont icon-group"},null,-1),m("span",null,"群聊",-1)])),m("button",{class:"function-btn",onClick:ta,"aria-label":"朋友圈"},a[11]||(a[11]=[m("i",{class:"iconfont icon-moments"},null,-1),m("span",null,"朋友圈",-1)]))]),m("div",H,[(T(!0),g(w,null,C(Je.value,(e=>{var a,t;return T(),g("div",{key:`${e.type}-${e.id}`,class:S(["chat-item",{active:(null==(a=n.value)?void 0:a.type)===e.type&&(null==(t=n.value)?void 0:t.id)===e.id}]),onClick:a=>Be(e)},[m("div",J,[f(O,{src:e.avatar,size:"medium"},null,8,["src"]),e.unreadCount>0?(T(),g("div",Q,_(e.unreadCount>99?"99+":e.unreadCount),1)):h("",!0)]),m("div",q,[m("div",B,_(e.name),1),m("div",R,_(e.lastMessage||"暂无消息"),1)]),m("div",W,_(va(e.lastTime)),1)],10,G)})),128))])]),m("div",X,[n.value?(T(),g("div",Y,[m("div",Z,[m("div",ee,[m("span",null,_(n.value.name),1),"private"===n.value.type?(T(),g("span",ae,[m("span",{class:S(["status-dot",ca(n.value.id)])},null,2),D(" "+_("online"===ca(n.value.id)?"在线":"离线"),1)])):h("",!0)]),m("div",te,[m("button",{class:"action-btn",onClick:a[1]||(a[1]=e=>Oe.value=!0),"aria-label":"聊天信息"},a[12]||(a[12]=[m("i",{class:"iconfont icon-info"},null,-1)]))])]),m("div",{class:"messages-container",ref_key:"messagesContainer",ref:Le},[m("div",se,[Ke.value?(T(),g("div",ne,[m("button",{onClick:We,disabled:Ee.value},_(Ee.value?"加载中...":"加载更多消息"),9,le)])):h("",!0),(T(!0),g(w,null,C(l.value,((e,a)=>(T(),g("div",{key:e._id,class:S(["message-wrapper",{"message-group":ga(e,l.value[a-1])}])},[pa(e,l.value[a-1])?(T(),g("div",ie,_(da(e.createdAt)),1)):h("",!0),m("div",{class:S(["message-item",{own:ya(e),grouped:ga(e,l.value[a-1])}])},[ga(e,l.value[a-1])?(T(),g("div",oe)):(T(),g("div",ue,[f(O,{src:e.sender.avatar,size:"small"},null,8,["src"])])),m("div",ce,[m("div",re,[m("div",de,_(e.content),1),m("div",ve,[m("span",pe,_(ra(e.createdAt)),1),ya(e)?(T(),g("span",ge,["sending"===e.status?(T(),g("i",me)):"sent"===e.status?(T(),g("i",he)):"read"===e.status?(T(),g("i",fe)):h("",!0)])):h("",!0)])])])],2)],2)))),128))])],512),m("div",ye,[m("div",be,[m("button",{class:"tool-btn",onClick:a[2]||(a[2]=e=>Ae.value=!Ae.value),"aria-label":"表情"},a[13]||(a[13]=[m("i",{class:"iconfont icon-emoji"},null,-1)])),m("button",{class:"tool-btn",onClick:a[3]||(a[3]=e=>ze.value=!0),"aria-label":"图片"},a[14]||(a[14]=[m("i",{class:"iconfont icon-image"},null,-1)])),m("button",{class:"tool-btn",onClick:a[4]||(a[4]=e=>$e.value=!0),"aria-label":"语音"},a[15]||(a[15]=[m("i",{class:"iconfont icon-voice"},null,-1)]))]),m("div",ke,[b(m("textarea",{"onUpdate:modelValue":a[5]||(a[5]=e=>i.value=e),ref_key:"messageInput",ref:Ne,class:"message-input",placeholder:"输入消息...",onKeydown:M(j(Xe,["prevent"]),["enter"]),onInput:na,rows:"1"},null,40,we),[[k,i.value]]),m("button",{class:S(["send-btn",{active:i.value.trim()}]),onClick:Xe,disabled:!i.value.trim()}," 发送 ",10,Ce)])])])):(T(),g("div",_e,a[16]||(a[16]=[m("div",{class:"welcome-content"},[m("div",{class:"welcome-icon"},[m("i",{style:{"font-size":"50px"},class:"iconfont icon-chat"})]),m("h2",null,"飞信"),m("p",null,"选择一个聊天开始对话")],-1)])))]),Ae.value?(T(),g("div",De,[m("div",Se,[(T(),g(w,null,C(Ge,(e=>m("span",{key:e,class:"emoji-item",onClick:a=>(e=>{var a;i.value+=e,Ae.value=!1,null==(a=Ne.value)||a.focus()})(e)},_(e),9,Me))),64))])])):h("",!0),ze.value?(T(),g("input",{key:1,ref_key:"imageInput",ref:Pe,type:"file",accept:"image/*",onChange:la,style:{display:"none"}},null,544)):h("",!0),$e.value?(T(),g("div",je,[m("div",xe,[m("div",Ie,[a[17]||(a[17]=m("div",{class:"voice-icon"},[m("i",{class:"iconfont icon-microphone"})],-1)),a[18]||(a[18]=m("p",null,"按住说话",-1)),m("button",{class:"voice-btn",onMousedown:ia,onMouseup:ua,onMouseleave:ua}," 录音 ",32)])])])):h("",!0)])}}},[["__scopeId","data-v-65e32f8e"]]);export{Ae as default};
