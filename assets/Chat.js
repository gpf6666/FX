var xe=Object.defineProperty;var i=(P,y)=>xe(P,"name",{value:y,configurable:!0});import{u as $e,k as Ae,r as d,l as X,m as Y,n as Ne,c as u,b as a,p as h,e as B,i as ze,q as Z,v as ee,F as G,s as O,t as f,j as Le,x,y as Ee,g as Ue,z as _,A as $,h as Re,E as te,o as c}from"./index.js";import{A as K}from"./Avatar.js";import{_ as Ve}from"./_plugin-vue_export-helper.js";const je={class:"wechat-container"},Fe={class:"sidebar"},Be={class:"sidebar-header"},Ge={class:"user-avatar"},Oe={class:"search-box"},Ke={class:"search-input"},Pe={class:"chat-list"},He=["onClick"],qe={class:"chat-avatar"},Je={key:0,class:"unread-badge"},Qe={class:"chat-info"},We={class:"chat-name"},Xe={class:"chat-last-message"},Ye={class:"chat-time"},Ze={class:"main-chat"},et={key:0,class:"chat-area"},tt={class:"chat-header"},st={class:"chat-title"},at={key:0,class:"online-status"},nt={class:"chat-actions"},ot={class:"messages-wrapper"},it={key:0,class:"load-more"},lt=["disabled"],rt={key:0,class:"time-divider"},ut={key:0,class:"message-avatar"},ct={key:1,class:"message-avatar-placeholder"},dt={class:"message-content"},vt={class:"message-bubble"},pt={class:"message-text"},gt={class:"message-status"},ft={class:"message-time"},mt={key:0,class:"message-status-icon"},ht={key:0,class:"iconfont icon-loading"},_t={key:1,class:"iconfont icon-check"},wt={key:2,class:"iconfont icon-check-double"},yt={class:"input-area"},Ct={class:"input-toolbar"},kt={class:"input-container"},bt=["onKeydown"],St=["disabled"],Dt={key:1,class:"welcome-page"},Mt={key:0,class:"emoji-picker"},Tt={class:"emoji-list"},It=["onClick"],xt={key:2,class:"voice-recorder"},$t={class:"voice-modal"},At={class:"voice-content"},b=20,Nt={__name:"Chat",setup(P){const y=Re(),g=$e(),A=Ae(),r=d(null),p=d([]),m=d(""),N=d(""),z=d(!1),U=d(!1),R=d(!1);d(!1),d(!1);const se=d(!1),L=d(),V=d(),ae=d(),S=d(!1),D=d(!0),C=d(1),v=d([]),E=d([]),H=d([]),ne=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕","🤑","🤠"],oe=X(()=>N.value?v.value.filter(t=>t.name.toLowerCase().includes(N.value.toLowerCase())):v.value),ie=X(()=>v.value.reduce((t,e)=>t+(e.unreadCount||0),0));Y(ie,t=>{t>0?document.title=`(${t}) FEI信`:document.title="FEI信"});const le=i(async()=>{try{const t=await _.get("/api/users/friends/list");t.data.success&&(E.value=t.data.friends);const e=await _.get("/api/chats/groups");e.data.success&&(H.value=e.data.groups);const n=await _.get("/api/chats/unread-count");let s={};n.data.success&&(s=n.data.unreadCount);const o=[];E.value.forEach(l=>{o.push({type:"private",id:l._id,name:l.nickname||l.username,avatar:l.avatar,lastMessage:l.lastMessage||"",lastTime:l.lastMessageTime,unreadCount:s[l._id]||0})}),H.value.forEach(l=>{o.push({type:"group",id:l._id,name:l.name,avatar:l.avatar,lastMessage:l.lastMessage||"",lastTime:l.lastMessageTime,unreadCount:s[l._id]||0})}),o.sort((l,w)=>new Date(w.lastTime||0)-new Date(l.lastTime||0)),v.value=o}catch(t){console.error("获取聊天列表失败:",t)}},"getChats"),re=i(async t=>{r.value=t,p.value=[],C.value=1,D.value=!0,console.log("选择聊天:",t),console.log("当前用户:",g.user),ue(t.type,t.id);try{let e;if(t.type==="private"?e=await _.get(`/api/chats/private/${t.id}?page=${C.value}&limit=${b}`):e=await _.get(`/api/chats/groups/${t.id}?page=${C.value}&limit=${b}`),e.data.success){console.log("获取到的消息:",e.data.messages),console.log("消息数量:",e.data.messages.length);const n=e.data.messages.sort((s,o)=>new Date(s.createdAt)-new Date(o.createdAt));n.forEach((s,o)=>{var l,w;console.log(`消息 ${o+1}:`,{content:s.content.substring(0,20)+"...",senderId:s.sender._id,currentUserId:((l=g.user)==null?void 0:l.id)||((w=g.user)==null?void 0:w._id),isOwn:T(s)})}),p.value=n,D.value=e.data.messages.length===b,await $(),M()}}catch(e){console.error("获取消息失败:",e),te.error("获取消息失败")}},"selectChat"),ue=i((t,e)=>{const n=v.value.findIndex(s=>s.type===t&&String(s.id)===String(e));n!==-1&&(v.value[n].unreadCount=0)},"clearUnreadCount"),ce=i((t,e,n)=>{const s=v.value.findIndex(o=>o.type===t&&String(o.id)===String(e));if(s!==-1){v.value[s].lastMessage=n,v.value[s].lastTime=new Date;const o=v.value.splice(s,1)[0];v.value.unshift(o)}},"updateChatLastMessage"),de=i(async()=>{if(!(S.value||!D.value)){S.value=!0,C.value++;try{let t;if(r.value.type==="private"?t=await _.get(`/api/chats/private/${r.value.id}?page=${C.value}&limit=${b}`):t=await _.get(`/api/chats/groups/${r.value.id}?page=${C.value}&limit=${b}`),t.data.success){const e=t.data.messages.reverse();p.value.unshift(...e),D.value=e.length===b}}catch(t){console.error("加载更多消息失败:",t),C.value--}finally{S.value=!1}}},"loadMoreMessages"),q=i(async()=>{var n,s,o,l,w;if(!m.value.trim()||!r.value)return;const t={content:m.value,timestamp:new Date,status:"sending"},e={_id:Date.now().toString(),content:m.value,sender:{_id:((n=g.user)==null?void 0:n.id)||((s=g.user)==null?void 0:s._id),username:(o=g.user)==null?void 0:o.username,nickname:(l=g.user)==null?void 0:l.nickname,avatar:(w=g.user)==null?void 0:w.avatar},createdAt:new Date,status:"sending"};p.value.push(e),m.value="",await $(),M();try{let k;if(r.value.type==="private"?k=await _.post("/api/chats/private",{receiver:r.value.id,content:t.content}):k=await _.post(`/api/chats/groups/${r.value.id}`,{content:t.content}),k.data.success){const I=p.value.findIndex(F=>F._id===e._id);I!==-1&&(p.value[I]={...k.data.message,status:"sent",_id:k.data.message._id}),ce(r.value.type,r.value.id,e.content)}}catch(k){console.error("发送消息失败:",k),te.error("发送消息失败");const I=p.value.findIndex(F=>F._id===e._id);I!==-1&&(p.value[I].status="failed")}},"sendMessage"),ve=i(()=>{y.push("/profile")},"goToProfile"),pe=i(()=>{y.push("/settings")},"goToSettings"),ge=i(()=>{y.push("/add-friend")},"goToAddFriend"),fe=i(()=>{y.push("/group-chat")},"goToGroupChat"),me=i(()=>{y.push("/moments")},"goToMoments"),M=i(()=>{L.value&&(L.value.scrollTop=L.value.scrollHeight)},"scrollToBottom"),he=i(()=>{const t=V.value;t&&(t.style.height="auto",t.style.height=Math.min(t.scrollHeight,120)+"px")},"handleInput"),_e=i(t=>{var e;m.value+=t,z.value=!1,(e=V.value)==null||e.focus()},"insertEmoji"),we=i(t=>{const e=t.target.files[0];e&&console.log("图片上传:",e),U.value=!1},"handleImageUpload"),ye=i(()=>{console.log("开始录音")},"startRecording"),J=i(()=>{console.log("停止录音"),R.value=!1},"stopRecording"),Ce=i(()=>{},"handleSearch"),Q=i(t=>{const e=E.value.find(n=>n._id===t);return(e==null?void 0:e.status)||"offline"},"getFriendStatus"),ke=i(t=>{const e=new Date(t),s=new Date-e;return s<6e4?"刚刚":s<36e5?Math.floor(s/6e4)+"分钟前":s<864e5?Math.floor(s/36e5)+"小时前":e.toLocaleDateString("zh-CN")},"formatTime"),be=i(t=>{const e=new Date(t),n=new Date;return e.toDateString()===n.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toDateString()===new Date(n-864e5).toDateString()?"昨天 "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN")+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})},"formatMessageTime"),Se=i(t=>{if(!t)return"";const e=new Date(t),n=new Date;return e.toDateString()===n.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},"formatChatTime"),De=i((t,e)=>{if(!e)return!0;const n=new Date(t.createdAt),s=new Date(e.createdAt);return n-s>3e5},"shouldShowTimeDivider"),j=i((t,e)=>{if(!e)return!1;const n=new Date(t.createdAt),s=new Date(e.createdAt),o=n-s;return t.sender._id===e.sender._id&&o<3e5},"shouldGroupMessage"),Me=i(t=>{r.value&&r.value.type==="private"&&String(t.sender._id)===String(r.value.id)&&!T(t)&&(p.value.push({...t,status:"received"}),$(()=>M())),W("private",t.sender._id,t)},"handleNewMessage"),Te=i(t=>{r.value&&r.value.type==="group"&&String(t.group)===String(r.value.id)&&!T(t)&&(p.value.push({...t,status:"received"}),$(()=>M())),W("group",t.group,t)},"handleNewGroupMessage"),W=i((t,e,n)=>{if(r.value&&r.value.type===t&&String(r.value.id)===String(e))return;const s=v.value.findIndex(o=>o.type===t&&String(o.id)===String(e));if(s!==-1){v.value[s].unreadCount=(v.value[s].unreadCount||0)+1,v.value[s].lastMessage=n.content,v.value[s].lastTime=n.createdAt;const o=v.value.splice(s,1)[0];v.value.unshift(o)}},"updateUnreadCount"),T=i(t=>{var o,l;const e=((o=g.user)==null?void 0:o.id)||((l=g.user)==null?void 0:l._id),n=t.sender._id||t.sender.id;return String(e)===String(n)},"isOwnMessage"),Ie=i(t=>{const e=E.value.find(n=>n._id===t.userId);e&&(e.status=t.status)},"handleUserStatus");return Ne(async()=>{var t,e,n,s;((t=g.user)!=null&&t.id||(e=g.user)!=null&&e._id)&&A.connect(((n=g.user)==null?void 0:n.id)||((s=g.user)==null?void 0:s._id)),await le(),A.onNewMessage(Me),A.onNewGroupMessage(Te),A.onUserStatus(Ie)}),Y(p,()=>{$(()=>M())}),(t,e)=>{var n;return c(),u("div",je,[a("div",Fe,[a("div",Be,[a("div",Ge,[B(K,{src:(n=ze(g).user)==null?void 0:n.avatar,size:"medium"},null,8,["src"])]),a("div",{class:"user-actions"},[a("button",{class:"action-btn",onClick:ve,"aria-label":"个人资料"},e[6]||(e[6]=[a("i",{class:"iconfont icon-user"},null,-1)])),a("button",{class:"action-btn",onClick:pe,"aria-label":"设置"},e[7]||(e[7]=[a("i",{class:"iconfont icon-settings"},null,-1)]))])]),a("div",Oe,[a("div",Ke,[e[8]||(e[8]=a("i",{class:"iconfont icon-search"},null,-1)),Z(a("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>N.value=s),type:"text",placeholder:"搜索",onInput:Ce},null,544),[[ee,N.value]])])]),a("div",{class:"function-buttons"},[a("button",{class:"function-btn",onClick:ge,"aria-label":"添加好友"},e[9]||(e[9]=[a("i",{class:"iconfont icon-add"},null,-1),a("span",null,"添加好友",-1)])),a("button",{class:"function-btn",onClick:fe,"aria-label":"群聊"},e[10]||(e[10]=[a("i",{class:"iconfont icon-group"},null,-1),a("span",null,"群聊",-1)])),a("button",{class:"function-btn",onClick:me,"aria-label":"朋友圈"},e[11]||(e[11]=[a("i",{class:"iconfont icon-moments"},null,-1),a("span",null,"朋友圈",-1)]))]),a("div",Pe,[(c(!0),u(G,null,O(oe.value,s=>{var o,l;return c(),u("div",{key:`${s.type}-${s.id}`,class:x(["chat-item",{active:((o=r.value)==null?void 0:o.type)===s.type&&((l=r.value)==null?void 0:l.id)===s.id}]),onClick:i(w=>re(s),"onClick")},[a("div",qe,[B(K,{src:s.avatar,size:"medium"},null,8,["src"]),s.unreadCount>0?(c(),u("div",Je,f(s.unreadCount>99?"99+":s.unreadCount),1)):h("",!0)]),a("div",Qe,[a("div",We,f(s.name),1),a("div",Xe,f(s.lastMessage||"暂无消息"),1)]),a("div",Ye,f(Se(s.lastTime)),1)],10,He)}),128))])]),a("div",Ze,[r.value?(c(),u("div",et,[a("div",tt,[a("div",st,[a("span",null,f(r.value.name),1),r.value.type==="private"?(c(),u("span",at,[a("span",{class:x(["status-dot",Q(r.value.id)])},null,2),Le(" "+f(Q(r.value.id)==="online"?"在线":"离线"),1)])):h("",!0)]),a("div",nt,[a("button",{class:"action-btn",onClick:e[1]||(e[1]=s=>se.value=!0),"aria-label":"聊天信息"},e[12]||(e[12]=[a("i",{class:"iconfont icon-info"},null,-1)]))])]),a("div",{class:"messages-container",ref_key:"messagesContainer",ref:L},[a("div",ot,[D.value?(c(),u("div",it,[a("button",{onClick:de,disabled:S.value},f(S.value?"加载中...":"加载更多消息"),9,lt)])):h("",!0),(c(!0),u(G,null,O(p.value,(s,o)=>(c(),u("div",{key:s._id,class:x(["message-wrapper",{"message-group":j(s,p.value[o-1])}])},[De(s,p.value[o-1])?(c(),u("div",rt,f(be(s.createdAt)),1)):h("",!0),a("div",{class:x(["message-item",{own:T(s),grouped:j(s,p.value[o-1])}])},[j(s,p.value[o-1])?(c(),u("div",ct)):(c(),u("div",ut,[B(K,{src:s.sender.avatar,size:"small"},null,8,["src"])])),a("div",dt,[a("div",vt,[a("div",pt,f(s.content),1),a("div",gt,[a("span",ft,f(ke(s.createdAt)),1),T(s)?(c(),u("span",mt,[s.status==="sending"?(c(),u("i",ht)):s.status==="sent"?(c(),u("i",_t)):s.status==="read"?(c(),u("i",wt)):h("",!0)])):h("",!0)])])])],2)],2))),128))])],512),a("div",yt,[a("div",Ct,[a("button",{class:"tool-btn",onClick:e[2]||(e[2]=s=>z.value=!z.value),"aria-label":"表情"},e[13]||(e[13]=[a("i",{class:"iconfont icon-emoji"},null,-1)])),a("button",{class:"tool-btn",onClick:e[3]||(e[3]=s=>U.value=!0),"aria-label":"图片"},e[14]||(e[14]=[a("i",{class:"iconfont icon-image"},null,-1)])),a("button",{class:"tool-btn",onClick:e[4]||(e[4]=s=>R.value=!0),"aria-label":"语音"},e[15]||(e[15]=[a("i",{class:"iconfont icon-voice"},null,-1)]))]),a("div",kt,[Z(a("textarea",{"onUpdate:modelValue":e[5]||(e[5]=s=>m.value=s),ref_key:"messageInput",ref:V,class:"message-input",placeholder:"输入消息...",onKeydown:Ee(Ue(q,["prevent"]),["enter"]),onInput:he,rows:"1"},null,40,bt),[[ee,m.value]]),a("button",{class:x(["send-btn",{active:m.value.trim()}]),onClick:q,disabled:!m.value.trim()}," 发送 ",10,St)])])])):(c(),u("div",Dt,e[16]||(e[16]=[a("div",{class:"welcome-content"},[a("div",{class:"welcome-icon"},[a("i",{style:{"font-size":"50px"},class:"iconfont icon-chat"})]),a("h2",null,"飞信"),a("p",null,"选择一个聊天开始对话")],-1)])))]),z.value?(c(),u("div",Mt,[a("div",Tt,[(c(),u(G,null,O(ne,s=>a("span",{key:s,class:"emoji-item",onClick:i(o=>_e(s),"onClick")},f(s),9,It)),64))])])):h("",!0),U.value?(c(),u("input",{key:1,ref_key:"imageInput",ref:ae,type:"file",accept:"image/*",onChange:we,style:{display:"none"}},null,544)):h("",!0),R.value?(c(),u("div",xt,[a("div",$t,[a("div",At,[e[17]||(e[17]=a("div",{class:"voice-icon"},[a("i",{class:"iconfont icon-microphone"})],-1)),e[18]||(e[18]=a("p",null,"按住说话",-1)),a("button",{class:"voice-btn",onMousedown:ye,onMouseup:J,onMouseleave:J}," 录音 ",32)])])])):h("",!0)])}}},Rt=Ve(Nt,[["__scopeId","data-v-a44bf324"]]);export{Rt as default};
