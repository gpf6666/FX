import{r as m,c as g,o as h,b as e,p as W,e as t,M as ae,t as u,u as oe,a as le,n as ne,w as n,f as r,F as q,s as H,z as F,L as J,h as re,j as V,x as ie,i as K,E as k}from"./index-DXrV_0nq.js";import{A as ce}from"./Avatar-BvpI8y4B.js";import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue={class:"avatar-upload"},de={key:0,class:"upload-progress"},me={class:"progress-bar"},pe={class:"progress-text"},ve={key:1,class:"upload-error"},_e={__name:"AvatarUpload",props:{currentAvatar:{type:String,default:""},size:{type:String,default:"large"},maxSize:{type:Number,default:5*1024*1024}},emits:["upload-success","upload-error"],setup(A,{emit:E}){const i=A,x=E,w=m(null),v=m(""),_=m(!1),d=m(0),l=m(""),R=()=>{var f;(f=w.value)==null||f.click()},T=async f=>{const c=f.target.files[0];if(!c)return;if(!c.type.startsWith("image/")){l.value="请选择图片文件";return}if(c.size>i.maxSize){l.value=`文件大小不能超过 ${i.maxSize/1024/1024}MB`;return}l.value="";const C=new FileReader;C.onload=p=>{v.value=p.target.result},C.readAsDataURL(c);try{_.value=!0,d.value=0;const p=new FormData;p.append("avatar",c);const S=await fetch("/api/upload/avatar",{method:"POST",body:p});if(!S.ok)throw new Error("上传失败");const y=await S.json();if(y.success)d.value=100,_.value=!1,v.value=y.data.url,x("upload-success",{url:y.data.url,file:c}),setTimeout(()=>{v.value=""},1e3);else throw new Error(y.message||"上传失败")}catch(p){_.value=!1,l.value=p.message||"上传失败",x("upload-error",p.message||"上传失败")}};return(f,c)=>(h(),g("div",ue,[e("div",{class:"avatar-preview",onClick:R},[t(ce,{src:v.value||A.currentAvatar,size:A.size},null,8,["src","size"]),c[0]||(c[0]=e("div",{class:"upload-overlay"},[e("i",{class:"iconfont icon-image"}),e("span",null,"更换头像")],-1))]),e("input",{ref_key:"fileInput",ref:w,type:"file",accept:"image/*",onChange:T,style:{display:"none"}},null,544),_.value?(h(),g("div",de,[e("div",me,[e("div",{class:"progress-fill",style:ae({width:d.value+"%"})},null,4)]),e("span",pe,u(d.value)+"%",1)])):W("",!0),l.value?(h(),g("div",ve,u(l.value),1)):W("",!0)]))}},fe=Q(_e,[["__scopeId","data-v-13514240"]]),ge={class:"wechat-page"},he={class:"wechat-header"},we={class:"wechat-content"},ye={class:"profile-section"},ke={class:"profile-card"},xe={class:"profile-header"},be={class:"profile-info"},ze={class:"profile-name"},Ve={class:"profile-username"},Ae={class:"function-list"},Ce={class:"function-section"},Se={class:"function-section"},$e={class:"section-header"},Ue={class:"section-count"},Be={class:"friends-list"},Fe={class:"friend-info"},Ee={class:"friend-name"},Re={class:"friend-status"},Te={class:"function-section"},Le={class:"section-header"},Pe={class:"section-count"},Ie={class:"groups-list"},Me={class:"group-info"},Ne={class:"group-name"},De={class:"group-members"},je={class:"group-role"},Ge={class:"function-section"},Oe={__name:"Profile",setup(A){var M,N,D,j;const E=re(),i=oe(),x=m(),w=m([]),v=m([]),_=m(!1),d=m(!1),l=le({username:((M=i.user)==null?void 0:M.username)||"",email:((N=i.user)==null?void 0:N.email)||"",nickname:((D=i.user)==null?void 0:D.nickname)||"",avatar:((j=i.user)==null?void 0:j.avatar)||""}),R={nickname:[{max:20,message:"昵称长度不能超过20个字符",trigger:"blur"}]},T=async()=>{try{await x.value.validate(),_.value=!0;const o=await F.put("/api/users/profile",{nickname:l.nickname,avatar:l.avatar});o.data.success&&(k.success("更新成功"),i.user=o.data.user,d.value=!1)}catch(o){console.error("更新个人资料失败:",o),k.error("更新失败")}finally{_.value=!1}},f=async()=>{try{const o=await F.get("/api/users/friends/list");o.data.success&&(w.value=o.data.friends)}catch(o){console.error("获取好友列表失败:",o)}},c=async()=>{try{const o=await F.get("/api/chats/groups");o.data.success&&(v.value=o.data.groups)}catch(o){console.error("获取群组列表失败:",o)}},C=async o=>{try{await J.confirm("确定要删除这个好友吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await F.delete(`/api/users/friends/${o}`)).data.success&&(k.success("删除成功"),await f())}catch(s){s!=="cancel"&&(console.error("删除好友失败:",s),k.error("删除失败"))}},p=o=>{l.avatar=o.url,k.success("头像上传成功")},S=o=>{k.error(o||"头像上传失败")},y=async()=>{try{await J.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),i.logout(),E.push("/login")}catch{}};return ne(async()=>{await f(),await c()}),(o,s)=>{const X=r("ArrowLeft"),b=r("el-icon"),z=r("el-button"),L=r("el-avatar"),G=r("ArrowRight"),Y=r("User"),Z=r("el-tag"),ee=r("SwitchButton"),$=r("el-form-item"),P=r("el-input"),se=r("el-form"),te=r("el-dialog");return h(),g("div",ge,[e("div",he,[t(z,{onClick:s[0]||(s[0]=a=>o.$router.push("/chat")),type:"text",size:"small"},{default:n(()=>[t(b,null,{default:n(()=>[t(X)]),_:1})]),_:1}),s[7]||(s[7]=e("div",{class:"wechat-header-title"},"我",-1)),s[8]||(s[8]=e("div",null,null,-1))]),e("div",we,[e("div",ye,[e("div",ke,[e("div",xe,[t(L,{src:l.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),e("div",be,[e("div",ze,u(l.nickname||l.username),1),e("div",Ve,"微信号："+u(l.username),1)]),t(z,{type:"text",size:"small"},{default:n(()=>[t(b,null,{default:n(()=>[t(G)]),_:1})]),_:1})])])]),e("div",Ae,[e("div",Ce,[e("div",{class:"wechat-list-item",onClick:s[1]||(s[1]=a=>d.value=!0)},[t(b,null,{default:n(()=>[t(Y)]),_:1}),s[9]||(s[9]=e("span",{class:"function-text"},"个人资料",-1)),t(b,null,{default:n(()=>[t(G)]),_:1})])]),e("div",Se,[e("div",$e,[s[10]||(s[10]=e("span",null,"好友管理",-1)),e("span",Ue,"("+u(w.value.length)+")",1)]),e("div",Be,[(h(!0),g(q,null,H(w.value,a=>(h(),g("div",{key:a._id,class:"wechat-list-item"},[t(L,{src:a.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),e("div",Fe,[e("div",Ee,u(a.nickname||a.username),1),e("div",Re,[e("span",{class:ie(["user-status",a.status])},null,2),V(" "+u(a.status==="online"?"在线":"离线"),1)])]),t(z,{type:"text",size:"small",onClick:I=>C(a._id),class:"delete-btn"},{default:n(()=>s[11]||(s[11]=[V(" 删除 ",-1)])),_:2,__:[11]},1032,["onClick"])]))),128))])]),e("div",Te,[e("div",Le,[s[12]||(s[12]=e("span",null,"群组管理",-1)),e("span",Pe,"("+u(v.value.length)+")",1)]),e("div",Ie,[(h(!0),g(q,null,H(v.value,a=>{var I;return h(),g("div",{key:a._id,class:"wechat-list-item"},[t(L,{src:a.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),e("div",Me,[e("div",Ne,u(a.name),1),e("div",De,u(a.members.length)+"人",1)]),e("div",je,[t(Z,{type:((I=a.members.find(U=>{var B;return U.user._id===((B=K(i).user)==null?void 0:B.id)}))==null?void 0:I.role)==="admin"?"danger":"info",size:"small"},{default:n(()=>{var U;return[V(u(((U=a.members.find(B=>{var O;return B.user._id===((O=K(i).user)==null?void 0:O.id)}))==null?void 0:U.role)==="admin"?"管理员":"成员"),1)]}),_:2},1032,["type"])])])}),128))])]),e("div",Ge,[e("div",{class:"wechat-list-item logout-item",onClick:y},[t(b,null,{default:n(()=>[t(ee)]),_:1}),s[13]||(s[13]=e("span",{class:"function-text"},"退出登录",-1))])])])]),t(te,{modelValue:d.value,"onUpdate:modelValue":s[6]||(s[6]=a=>d.value=a),title:"编辑个人资料",width:"500px"},{footer:n(()=>[t(z,{onClick:s[5]||(s[5]=a=>d.value=!1)},{default:n(()=>s[14]||(s[14]=[V("取消",-1)])),_:1,__:[14]}),t(z,{type:"primary",onClick:T,loading:_.value},{default:n(()=>s[15]||(s[15]=[V(" 保存 ",-1)])),_:1,__:[15]},8,["loading"])]),default:n(()=>[t(se,{ref_key:"profileFormRef",ref:x,model:l,rules:R,"label-width":"80px"},{default:n(()=>[t($,{label:"头像"},{default:n(()=>[t(fe,{"current-avatar":l.avatar,size:"xlarge",onUploadSuccess:p,onUploadError:S},null,8,["current-avatar"])]),_:1}),t($,{label:"用户名"},{default:n(()=>[t(P,{modelValue:l.username,"onUpdate:modelValue":s[2]||(s[2]=a=>l.username=a),disabled:""},null,8,["modelValue"])]),_:1}),t($,{label:"邮箱"},{default:n(()=>[t(P,{modelValue:l.email,"onUpdate:modelValue":s[3]||(s[3]=a=>l.email=a),disabled:""},null,8,["modelValue"])]),_:1}),t($,{label:"昵称",prop:"nickname"},{default:n(()=>[t(P,{modelValue:l.nickname,"onUpdate:modelValue":s[4]||(s[4]=a=>l.nickname=a),placeholder:"请输入昵称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Je=Q(Oe,[["__scopeId","data-v-ad7cecfa"]]);export{Je as default};
