var e=(e,l,a)=>new Promise(((t,s)=>{var n=e=>{try{i(a.next(e))}catch(l){s(l)}},o=e=>{try{i(a.throw(e))}catch(l){s(l)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(n,o);i((a=a.apply(e,l)).next())}));import{r as l,X as a,h as t,y as s,A as n,Q as o,I as i,al as u,K as c,u as d,O as m,P as r,a6 as v,z as p,H as h,M as _,D as f,a4 as y,V as k}from"./vendor-BU-zYVMe.js";import{E as g,a as w,c as b,m as C,l as x,s as V,b as z,p as $,d as P}from"./element-LGSq3epL.js";import{u as U,a as j,b as M}from"./index-zPCyQuwE.js";import{_ as T}from"./_plugin-vue_export-helper-BCo6x5W8.js";const D={class:"wechat-page"},I={class:"wechat-header moments-header-custom"},O={class:"wechat-content"},K={class:"moments-header"},L={class:"user-profile"},A={class:"user-name"},B={class:"publish-moment"},N={class:"publish-card"},R={class:"publish-header"},q={class:"moments-list"},E={class:"moment-header"},H={class:"moment-info"},Q={class:"moment-author"},S={class:"moment-time"},X={class:"moment-content"},F={key:0,class:"moment-images"},G=["onClick"],J=["src","alt"],W={key:1,class:"moment-location"},Y={class:"moment-actions"},Z={class:"action-buttons"},ee={key:2,class:"moment-likes"},le={key:0},ae={key:3,class:"moment-comments"},te={class:"comment-author"},se={key:0,class:"comment-reply"},ne={class:"comment-content"},oe={key:4,class:"comment-input"},ie={key:0,class:"load-more"},ue={key:1,class:"wechat-empty"},ce={class:"wechat-empty-icon"},de=T({__name:"Moments",setup(T){const de=U(),me=j(),re=l([]),ve=l(!1),pe=l(!1),he=l(!0),_e=l(1),fe=l(!1),ye=l(null),ke=l(""),ge=a({content:"",images:[],location:"",isPublic:!0}),we=(l=!1)=>e(this,null,(function*(){if(!ve.value){ve.value=!0;try{l&&(_e.value=1,re.value=[]);const e=yield M.get("/api/moments",{params:{page:_e.value,limit:10}});e.data.success&&(l?re.value=e.data.moments:re.value.push(...e.data.moments),he.value=10===e.data.moments.length,_e.value++)}catch(e){g.error("获取朋友圈失败")}finally{ve.value=!1}}})),be=()=>e(this,null,(function*(){if(ge.content.trim()){pe.value=!0;try{(yield M.post("/api/moments",ge)).data.success&&(g.success("发布成功"),fe.value=!1,Object.assign(ge,{content:"",images:[],location:"",isPublic:!0}),yield we(!0))}catch(e){g.error("发布失败")}finally{pe.value=!1}}else g.warning("请输入内容")})),Ce=l=>e(this,null,(function*(){try{const e=yield M.post(`/api/moments/${l}/like`);if(e.data.success){const a=re.value.find((e=>e._id===l));a&&(a.likes=e.data.moment.likes)}}catch(e){g.error("操作失败")}})),xe=l=>e(this,null,(function*(){if(ke.value.trim())try{const e=yield M.post(`/api/moments/${l}/comment`,{content:ke.value});if(e.data.success){const a=re.value.find((e=>e._id===l));a&&(a.comments=e.data.moment.comments),ke.value="",ye.value=null}}catch(e){g.error("评论失败")}else g.warning("请输入评论内容")})),Ve=(l,a)=>e(this,null,(function*(){try{const e=yield M.delete(`/api/moments/${l}/comment/${a}`);if(e.data.success){const a=re.value.find((e=>e._id===l));a&&(a.comments=e.data.moment.comments),g.success("删除成功")}}catch(e){g.error("删除失败")}})),ze=l=>e(this,null,(function*(){try{(yield M.delete(`/api/moments/${l}`)).data.success&&(re.value=re.value.filter((e=>e._id!==l)),g.success("删除成功"))}catch(e){g.error("删除失败")}})),$e=e=>{"delete"===e.action&&P.confirm("确定要删除这条朋友圈吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{ze(e.momentId)}))},Pe=e=>e.likes.some((e=>{var l;return e.user._id===(null==(l=de.user)?void 0:l.id)})),Ue=e=>{const l=new Date,a=new Date(e),t=l-a;return t<6e4?"刚刚":t<36e5?`${Math.floor(t/6e4)}分钟前`:t<864e5?`${Math.floor(t/36e5)}小时前`:t<2592e6?`${Math.floor(t/864e5)}天前`:a.toLocaleDateString("zh-CN")},je=()=>{we()},Me=e=>{ge.images.push(URL.createObjectURL(e.raw))},Te=e=>{const l=ge.images.indexOf(e.url);l>-1&&ge.images.splice(l,1)},De=e=>{re.value.unshift(e)};return t((()=>e(this,null,(function*(){yield we(!0),me.onNewMoment(De)})))),(e,l)=>{var a,t,g,P;const U=u("el-icon"),j=u("el-button"),M=u("el-avatar"),T=u("el-dropdown-item"),me=u("el-dropdown-menu"),_e=u("el-dropdown"),we=u("el-input"),ze=u("el-form-item"),De=u("Plus"),Ie=u("el-upload"),Oe=u("el-radio"),Ke=u("el-radio-group"),Le=u("el-form"),Ae=u("el-dialog");return p(),s("div",D,[n("div",I,[o(j,{onClick:l[0]||(l[0]=l=>e.$router.push("/chat")),type:"text",size:"small",class:"header-btn-white"},{default:i((()=>[o(U,null,{default:i((()=>[o(d(w))])),_:1})])),_:1}),l[9]||(l[9]=n("div",{class:"wechat-header-title moments-title-white"},"朋友圈",-1)),o(j,{type:"text",size:"small",onClick:l[1]||(l[1]=e=>fe.value=!0),class:"header-btn-white"},{default:i((()=>[o(U,null,{default:i((()=>[o(d(b))])),_:1})])),_:1})]),n("div",O,[n("div",K,[l[10]||(l[10]=n("div",{class:"moments-cover"},[n("div",{class:"cover-image"})],-1)),n("div",L,[o(M,{src:null==(a=d(de).user)?void 0:a.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),n("div",A,m((null==(t=d(de).user)?void 0:t.nickname)||(null==(g=d(de).user)?void 0:g.username)),1)])]),n("div",B,[n("div",N,[n("div",R,[o(M,{src:null==(P=d(de).user)?void 0:P.avatar,size:"small"},null,8,["src"]),n("div",{class:"publish-input",onClick:l[2]||(l[2]=e=>fe.value=!0)},l[11]||(l[11]=[n("span",{class:"publish-placeholder"},"这一刻的想法...",-1)]))])])]),n("div",q,[(p(!0),s(r,null,v(re.value,(e=>{var a;return p(),s("div",{key:e._id,class:"moment-item"},[n("div",E,[o(M,{src:e.author.avatar,size:"small",class:"moment-avatar"},null,8,["src"]),n("div",H,[n("div",Q,m(e.author.nickname||e.author.username),1),n("div",S,m(Ue(e.createdAt)),1)]),e.author._id===(null==(a=d(de).user)?void 0:a.id)?(p(),h(_e,{key:0,onCommand:$e},{dropdown:i((()=>[o(me,null,{default:i((()=>[o(T,{command:{action:"delete",momentId:e._id}},{default:i((()=>l[12]||(l[12]=[_(" 删除 ",-1)]))),_:2,__:[12]},1032,["command"])])),_:2},1024)])),default:i((()=>[o(j,{type:"text",size:"small"},{default:i((()=>[o(U,null,{default:i((()=>[o(d(C))])),_:1})])),_:1})])),_:2},1024)):c("",!0)]),n("div",X,m(e.content),1),e.images&&e.images.length>0?(p(),s("div",F,[(p(!0),s(r,null,v(e.images,((l,a)=>{return p(),s("div",{key:a,class:f(["moment-image-wrapper",(t=e.images.length,1===t?"single":2===t?"double":3===t?"triple":4===t?"quad":"grid")]),onClick:l=>{e.images}},[n("img",{src:l,alt:`朋友圈图片 ${a+1}`,class:"moment-image"},null,8,J)],10,G);var t})),128))])):c("",!0),e.location?(p(),s("div",W,[o(U,null,{default:i((()=>[o(d(x))])),_:1}),_(" "+m(e.location),1)])):c("",!0),n("div",Y,[n("div",Z,[o(j,{type:"text",size:"small",class:f({liked:Pe(e)}),onClick:l=>Ce(e._id)},{default:i((()=>[o(U,null,{default:i((()=>[o(d(V))])),_:1}),_(" "+m(e.likes.length>0?e.likes.length:"")+" 赞 ",1)])),_:2},1032,["class","onClick"]),o(j,{type:"text",size:"small",onClick:l=>{return a=e._id,ye.value=a,void(ke.value="");var a}},{default:i((()=>[o(U,null,{default:i((()=>[o(d(z))])),_:1}),_(" "+m(e.comments.length>0?e.comments.length:"")+" 评论 ",1)])),_:2},1032,["onClick"])])]),e.likes.length>0?(p(),s("div",ee,[o(U,null,{default:i((()=>[o(d(V))])),_:1}),(p(!0),s(r,null,v(e.likes,((l,a)=>(p(),s("span",{key:l.user._id},[_(m(l.user.nickname||l.user.username)+" ",1),a<e.likes.length-1?(p(),s("span",le,"、")):c("",!0)])))),128))])):c("",!0),e.comments.length>0?(p(),s("div",ae,[(p(!0),s(r,null,v(e.comments,(a=>{var t,o;return p(),s("div",{key:a._id,class:"comment-item"},[n("span",te,m(a.user.nickname||a.user.username),1),a.replyTo?(p(),s("span",se," 回复 "+m(a.replyTo.nickname||a.replyTo.username)+"： ",1)):c("",!0),n("span",ne,m(a.content),1),a.user._id===(null==(t=d(de).user)?void 0:t.id)||e.author._id===(null==(o=d(de).user)?void 0:o.id)?(p(),h(j,{key:1,type:"text",size:"small",onClick:l=>Ve(e._id,a._id)},{default:i((()=>l[13]||(l[13]=[_(" 删除 ",-1)]))),_:2,__:[13]},1032,["onClick"])):c("",!0)])})),128))])):c("",!0),ye.value===e._id?(p(),s("div",oe,[o(we,{modelValue:ke.value,"onUpdate:modelValue":l[3]||(l[3]=e=>ke.value=e),placeholder:"写评论...",onKeydown:y(k((l=>xe(e._id)),["prevent"]),["enter"])},{append:i((()=>[o(j,{onClick:l=>xe(e._id)},{default:i((()=>l[14]||(l[14]=[_("发送",-1)]))),_:2,__:[14]},1032,["onClick"])])),_:2},1032,["modelValue","onKeydown"])])):c("",!0)])})),128))]),he.value?(p(),s("div",ie,[o(j,{onClick:je,loading:ve.value},{default:i((()=>l[15]||(l[15]=[_("加载更多",-1)]))),_:1,__:[15]},8,["loading"])])):c("",!0),0!==re.value.length||ve.value?c("",!0):(p(),s("div",ue,[n("div",ce,[o(U,null,{default:i((()=>[o(d($))])),_:1})]),l[16]||(l[16]=n("p",null,"暂无朋友圈内容",-1))]))]),o(Ae,{modelValue:fe.value,"onUpdate:modelValue":l[8]||(l[8]=e=>fe.value=e),title:"发布朋友圈",width:"600px"},{footer:i((()=>[o(j,{onClick:l[7]||(l[7]=e=>fe.value=!1)},{default:i((()=>l[19]||(l[19]=[_("取消",-1)]))),_:1,__:[19]}),o(j,{type:"primary",onClick:be,loading:pe.value},{default:i((()=>l[20]||(l[20]=[_(" 发布 ",-1)]))),_:1,__:[20]},8,["loading"])])),default:i((()=>[o(Le,{model:ge,"label-width":"80px"},{default:i((()=>[o(ze,{label:"内容"},{default:i((()=>[o(we,{modelValue:ge.content,"onUpdate:modelValue":l[4]||(l[4]=e=>ge.content=e),type:"textarea",rows:4,placeholder:"这一刻的想法..."},null,8,["modelValue"])])),_:1}),o(ze,{label:"图片"},{default:i((()=>[o(Ie,{action:"#","list-type":"picture-card","auto-upload":!1,"on-change":Me,"on-remove":Te,limit:9},{default:i((()=>[o(U,null,{default:i((()=>[o(De)])),_:1})])),_:1})])),_:1}),o(ze,{label:"位置"},{default:i((()=>[o(we,{modelValue:ge.location,"onUpdate:modelValue":l[5]||(l[5]=e=>ge.location=e),placeholder:"添加位置（可选）"},null,8,["modelValue"])])),_:1}),o(ze,{label:"可见性"},{default:i((()=>[o(Ke,{modelValue:ge.isPublic,"onUpdate:modelValue":l[6]||(l[6]=e=>ge.isPublic=e)},{default:i((()=>[o(Oe,{label:!0},{default:i((()=>l[17]||(l[17]=[_("公开",-1)]))),_:1,__:[17]}),o(Oe,{label:!1},{default:i((()=>l[18]||(l[18]=[_("仅好友可见",-1)]))),_:1,__:[18]})])),_:1},8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-eda14584"]]);export{de as default};
