var e=(e,a,l)=>new Promise(((s,t)=>{var n=e=>{try{i(l.next(e))}catch(a){t(a)}},o=e=>{try{i(l.throw(e))}catch(a){t(a)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,o);i((l=l.apply(e,a)).next())}));import{r as a,X as l,c as s,h as t,y as n,A as o,Q as i,P as r,a6 as u,I as c,al as d,aC as m,z as v,K as p,O as b,V as g,M as f,J as h,aj as y,D as k}from"./vendor-BU-zYVMe.js";import{u as _,b as C}from"./index-zPCyQuwE.js";import{A as x}from"./Avatar-BggJlZXq.js";import{_ as V}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{E as w,d as j}from"./element-LGSq3epL.js";const z={class:"group-chat-page"},M={class:"group-header"},U={class:"header-actions"},$={class:"group-content"},I={key:0,class:"group-list"},D=["onClick"],A={class:"group-avatar"},L={key:0,class:"unread-badge"},P={class:"group-info"},T={class:"group-name"},B={class:"group-members"},q={class:"group-last-message"},E={class:"group-time"},F={key:1,class:"empty-state"},G={class:"member-selector"},J={class:"selected-members"},K=["onClick"],O={class:"member-selector-content"},Q={class:"search-box"},R={class:"member-list"},S={key:0,class:"empty-members"},X=["onClick"],H={class:"member-avatar"},N={class:"member-info"},W={class:"member-name"},Y={class:"member-username"},Z={class:"member-check"},ee={key:0,class:"iconfont icon-check"},ae={key:0,class:"group-detail"},le={class:"group-header-info"},se={class:"group-info-detail"},te={class:"group-members-list"},ne={class:"members-grid"},oe={class:"member-name"},ie={class:"member-role"},re={class:"group-actions"},ue=V({__name:"GroupChat",setup(V){const ue=m(),ce=_(),de=a([]),me=a([]),ve=a(!1),pe=a(!1),be=a(!1),ge=a(!1),fe=a(""),he=a([]),ye=a([]),ke=a(null),_e=a(),Ce=l({name:"",description:""}),xe={name:[{required:!0,message:"请输入群组名称",trigger:"blur"},{min:2,max:20,message:"群组名称长度在2-20个字符",trigger:"blur"}],description:[{max:100,message:"群组描述不能超过100个字符",trigger:"blur"}]},Ve=s((()=>fe.value?me.value.filter((e=>(e.nickname||e.username).toLowerCase().includes(fe.value.toLowerCase()))):me.value)),we=s((()=>!(!ke.value||!ce.user)&&ke.value.members.some((e=>e.user._id===ce.user.id&&"admin"===e.role)))),je=()=>{ue.back()},ze=()=>e(this,null,(function*(){try{const e=yield C.get("/api/chats/groups");e.data.success&&(de.value=e.data.groups)}catch(e){w.error("获取群组列表失败")}})),Me=()=>e(this,null,(function*(){try{const e=yield C.get("/api/users/friends/list");e.data.success&&(me.value=e.data.friends)}catch(e){}})),Ue=()=>e(this,null,(function*(){var e,a;try{if(yield _e.value.validate(),0===he.value.length)return void w.warning("请至少选择一个成员");ge.value=!0;(yield C.post("/api/chats/groups",{name:Ce.name,description:Ce.description,members:he.value.map((e=>e._id))})).data.success&&(w.success("群组创建成功"),ve.value=!1,Ce.name="",Ce.description="",he.value=[],ye.value=[],yield ze())}catch(l){(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)?w.error(l.response.data.message):w.error("创建群组失败")}finally{ge.value=!1}})),$e=()=>{},Ie=e=>ye.value.some((a=>a._id===e)),De=()=>e(this,null,(function*(){try{pe.value=!0,0===me.value.length&&(yield Me()),ye.value=[...he.value]}catch(e){w.error("打开成员选择器失败"),pe.value=!1}})),Ae=()=>{ye.value=[],pe.value=!1},Le=()=>{he.value=[...ye.value],pe.value=!1},Pe=()=>{w.info("编辑群组功能开发中")},Te=()=>e(this,null,(function*(){try{yield j.confirm("确定要退出该群组吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});(yield C.post(`/api/chats/groups/${ke.value._id}/leave`)).data.success&&(w.success("已退出群组"),be.value=!1,yield ze())}catch(e){"cancel"!==e&&w.error("退出群组失败")}})),Be=e=>{if(!e)return"";const a=new Date(e),l=new Date-a;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分钟前`:l<864e5?`${Math.floor(l/36e5)}小时前`:l<2592e6?`${Math.floor(l/864e5)}天前`:a.toLocaleDateString()};t((()=>{ze(),Me()}));const qe=e=>{pe.value&&e()};return(e,a)=>{const l=d("el-input"),s=d("el-form-item"),t=d("el-form"),m=d("el-button"),_=d("el-dialog");return v(),n("div",z,[o("div",M,[o("button",{class:"back-btn",onClick:je,"aria-label":"返回"},a[10]||(a[10]=[o("i",{class:"iconfont icon-back"},null,-1)])),a[13]||(a[13]=o("h2",null,"群聊",-1)),o("div",U,[o("button",{class:"test-btn",onClick:a[0]||(a[0]=a=>e.$router.push("/test-group-avatar")),"aria-label":"测试群组头像"},a[11]||(a[11]=[o("i",{class:"iconfont icon-group"},null,-1)])),o("button",{class:"create-btn",onClick:a[1]||(a[1]=e=>ve.value=!0),"aria-label":"创建群组"},a[12]||(a[12]=[o("i",{class:"iconfont icon-add"},null,-1)]))])]),o("div",$,[de.value.length>0?(v(),n("div",I,[(v(!0),n(r,null,u(de.value,(e=>(v(),n("div",{key:e._id,class:"group-item",onClick:a=>(e=>{ue.push(`/chat?group=${e._id}`)})(e)},[o("div",A,[i(x,{src:e.avatar,size:"medium"},null,8,["src"]),e.unreadCount>0?(v(),n("div",L,b(e.unreadCount>99?"99+":e.unreadCount),1)):p("",!0)]),o("div",P,[o("div",T,b(e.name),1),o("div",B,b(e.members.length)+"人",1),o("div",q,b(e.lastMessage||"暂无消息"),1)]),o("div",E,b(Be(e.lastMessageTime)),1)],8,D)))),128))])):(v(),n("div",F,[a[14]||(a[14]=o("div",{class:"empty-icon"},[o("i",{class:"iconfont icon-group"})],-1)),a[15]||(a[15]=o("p",null,"暂无群组",-1)),o("button",{class:"create-group-btn",onClick:a[2]||(a[2]=e=>ve.value=!0)}," 创建群组 ")]))]),i(_,{modelValue:ve.value,"onUpdate:modelValue":a[6]||(a[6]=e=>ve.value=e),title:"创建群组",width:"500px","close-on-click-modal":!1},{footer:c((()=>[i(m,{onClick:a[5]||(a[5]=e=>ve.value=!1)},{default:c((()=>a[17]||(a[17]=[f("取消",-1)]))),_:1,__:[17]}),i(m,{type:"primary",onClick:Ue,loading:ge.value},{default:c((()=>[f(b(ge.value?"创建中...":"创建"),1)])),_:1},8,["loading"])])),default:c((()=>[i(t,{model:Ce,rules:xe,ref_key:"groupFormRef",ref:_e},{default:c((()=>[i(s,{label:"群组名称",prop:"name"},{default:c((()=>[i(l,{modelValue:Ce.name,"onUpdate:modelValue":a[3]||(a[3]=e=>Ce.name=e),placeholder:"请输入群组名称"},null,8,["modelValue"])])),_:1}),i(s,{label:"群组描述",prop:"description"},{default:c((()=>[i(l,{modelValue:Ce.description,"onUpdate:modelValue":a[4]||(a[4]=e=>Ce.description=e),type:"textarea",placeholder:"请输入群组描述",rows:3},null,8,["modelValue"])])),_:1}),i(s,{label:"选择成员"},{default:c((()=>[o("div",G,[o("div",J,[(v(!0),n(r,null,u(he.value,(e=>(v(),n("div",{key:e._id,class:"selected-member"},[i(x,{src:e.avatar,size:"small"},null,8,["src"]),o("span",null,b(e.nickname||e.username),1),o("button",{type:"button",class:"remove-member",onClick:g((a=>(e=>{const a=he.value.findIndex((a=>a._id===e));-1!==a&&he.value.splice(a,1)})(e._id)),["stop","prevent"]),"aria-label":"移除成员"}," × ",8,K)])))),128))]),o("button",{type:"button",class:"add-member-btn",onClick:g(De,["stop","prevent"])},a[16]||(a[16]=[o("i",{class:"iconfont icon-add"},null,-1),f(" 添加成员 ",-1)]))])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"]),i(_,{modelValue:pe.value,"onUpdate:modelValue":a[8]||(a[8]=e=>pe.value=e),title:"选择成员",width:"600px","append-to-body":!0,"close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":qe},{footer:c((()=>[i(m,{onClick:Ae},{default:c((()=>a[20]||(a[20]=[f("取消",-1)]))),_:1,__:[20]}),i(m,{type:"primary",onClick:Le},{default:c((()=>a[21]||(a[21]=[f("确定",-1)]))),_:1,__:[21]})])),default:c((()=>[o("div",O,[o("div",Q,[a[18]||(a[18]=o("i",{class:"iconfont icon-search"},null,-1)),h(o("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>fe.value=e),type:"text",placeholder:"搜索好友",onInput:$e},null,544),[[y,fe.value]])]),o("div",R,[0===Ve.value.length?(v(),n("div",S,[a[19]||(a[19]=o("div",{class:"empty-icon"},[o("i",{class:"iconfont icon-user"})],-1)),o("p",null,b(fe.value?"没有找到匹配的好友":"暂无好友"),1)])):p("",!0),(v(!0),n(r,null,u(Ve.value,(e=>(v(),n("div",{key:e._id,class:k(["member-item",{selected:Ie(e._id)}]),onClick:g((a=>(e=>{const a=ye.value.findIndex((a=>a._id===e._id));-1!==a?ye.value.splice(a,1):ye.value.push(e)})(e)),["stop"])},[o("div",H,[i(x,{src:e.avatar,size:"small"},null,8,["src"])]),o("div",N,[o("div",W,b(e.nickname||e.username),1),o("div",Y,"@"+b(e.username),1)]),o("div",Z,[Ie(e._id)?(v(),n("i",ee)):p("",!0)])],10,X)))),128))])])])),_:1},8,["modelValue"]),i(_,{modelValue:be.value,"onUpdate:modelValue":a[9]||(a[9]=e=>be.value=e),title:"群组详情",width:"600px"},{default:c((()=>[ke.value?(v(),n("div",ae,[o("div",le,[i(x,{src:ke.value.avatar,size:"xlarge"},null,8,["src"]),o("div",se,[o("h3",null,b(ke.value.name),1),o("p",null,b(ke.value.description||"暂无描述"),1),o("p",null,"群成员："+b(ke.value.members.length)+"人",1)])]),o("div",te,[a[22]||(a[22]=o("h4",null,"群成员",-1)),o("div",ne,[(v(!0),n(r,null,u(ke.value.members,(e=>(v(),n("div",{key:e.user._id,class:"member-card"},[i(x,{src:e.user.avatar,size:"medium"},null,8,["src"]),o("div",oe,b(e.user.nickname||e.user.username),1),o("div",ie,b("admin"===e.role?"管理员":"成员"),1)])))),128))])]),o("div",re,[we.value?(v(),n("button",{key:0,class:"action-btn edit-btn",onClick:Pe}," 编辑群组 ")):p("",!0),o("button",{class:"action-btn leave-btn",onClick:Te}," 退出群组 ")])])):p("",!0)])),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-25248d73"]]);export{ue as default};
