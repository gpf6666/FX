var e=(e,a,l)=>new Promise(((s,t)=>{var i=e=>{try{n(l.next(e))}catch(a){t(a)}},r=e=>{try{n(l.throw(e))}catch(a){t(a)}},n=e=>e.done?s(e.value):Promise.resolve(e.value).then(i,r);n((l=l.apply(e,a)).next())}));import{r as a,y as l,z as s,A as t,K as i,Q as r,C as n,O as u,X as c,h as o,I as d,al as v,P as m,a6 as p,aC as f,M as h,D as y,u as g}from"./vendor-BU-zYVMe.js";import{u as _,b as w}from"./index-zPCyQuwE.js";import{A as k}from"./Avatar-BggJlZXq.js";import{_ as x}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{d as b,E as z}from"./element-LGSq3epL.js";const V={class:"avatar-upload"},C={key:0,class:"upload-progress"},A={class:"progress-bar"},U={class:"progress-text"},S={key:1,class:"upload-error"},j=x({__name:"AvatarUpload",props:{currentAvatar:{type:String,default:""},size:{type:String,default:"large"},maxSize:{type:Number,default:5242880}},emits:["upload-success","upload-error"],setup(c,{emit:o}){const d=c,v=o,m=a(null),p=a(""),f=a(!1),h=a(0),y=a(""),g=()=>{var e;null==(e=m.value)||e.click()},_=a=>e(this,null,(function*(){const e=a.target.files[0];if(!e)return;if(!e.type.startsWith("image/"))return void(y.value="请选择图片文件");if(e.size>d.maxSize)return void(y.value=`文件大小不能超过 ${d.maxSize/1024/1024}MB`);y.value="";const l=new FileReader;l.onload=e=>{p.value=e.target.result},l.readAsDataURL(e);try{f.value=!0,h.value=0;const a=new FormData;a.append("avatar",e);const l=yield fetch("/api/upload/avatar",{method:"POST",body:a});if(!l.ok)throw new Error("上传失败");const s=yield l.json();if(!s.success)throw new Error(s.message||"上传失败");h.value=100,f.value=!1,p.value=s.data.url,v("upload-success",{url:s.data.url,file:e}),setTimeout((()=>{p.value=""}),1e3)}catch(s){f.value=!1,y.value=s.message||"上传失败",v("upload-error",s.message||"上传失败")}}));return(e,a)=>(s(),l("div",V,[t("div",{class:"avatar-preview",onClick:g},[r(k,{src:p.value||c.currentAvatar,size:c.size},null,8,["src","size"]),a[0]||(a[0]=t("div",{class:"upload-overlay"},[t("i",{class:"iconfont icon-image"}),t("span",null,"更换头像")],-1))]),t("input",{ref_key:"fileInput",ref:m,type:"file",accept:"image/*",onChange:_,style:{display:"none"}},null,544),f.value?(s(),l("div",C,[t("div",A,[t("div",{class:"progress-fill",style:n({width:h.value+"%"})},null,4)]),t("span",U,u(h.value)+"%",1)])):i("",!0),y.value?(s(),l("div",S,u(y.value),1)):i("",!0)]))}},[["__scopeId","data-v-13514240"]]),B={class:"wechat-page"},T={class:"wechat-header"},P={class:"wechat-content"},E={class:"profile-section"},I={class:"profile-card"},R={class:"profile-header"},D={class:"profile-info"},F={class:"profile-name"},$={class:"profile-username"},L={class:"function-list"},M={class:"function-section"},O={class:"function-section"},K={class:"section-header"},N={class:"section-count"},Q={class:"friends-list"},W={class:"friend-info"},X={class:"friend-name"},q={class:"friend-status"},G={class:"function-section"},H={class:"section-header"},J={class:"section-count"},Y={class:"groups-list"},Z={class:"group-info"},ee={class:"group-name"},ae={class:"group-members"},le={class:"group-role"},se={class:"function-section"},te=x({__name:"Profile",setup(i){var n,k,x,V;const C=f(),A=_(),U=a(),S=a([]),te=a([]),ie=a(!1),re=a(!1),ne=c({username:(null==(n=A.user)?void 0:n.username)||"",email:(null==(k=A.user)?void 0:k.email)||"",nickname:(null==(x=A.user)?void 0:x.nickname)||"",avatar:(null==(V=A.user)?void 0:V.avatar)||""}),ue={nickname:[{max:20,message:"昵称长度不能超过20个字符",trigger:"blur"}]},ce=()=>e(this,null,(function*(){try{yield U.value.validate(),ie.value=!0;const e=yield w.put("/api/users/profile",{nickname:ne.nickname,avatar:ne.avatar});e.data.success&&(z.success("更新成功"),A.user=e.data.user,re.value=!1)}catch(e){z.error("更新失败")}finally{ie.value=!1}})),oe=()=>e(this,null,(function*(){try{const e=yield w.get("/api/users/friends/list");e.data.success&&(S.value=e.data.friends)}catch(e){}})),de=()=>e(this,null,(function*(){try{const e=yield w.get("/api/chats/groups");e.data.success&&(te.value=e.data.groups)}catch(e){}})),ve=a=>e(this,null,(function*(){try{yield b.confirm("确定要删除这个好友吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});(yield w.delete(`/api/users/friends/${a}`)).data.success&&(z.success("删除成功"),yield oe())}catch(e){"cancel"!==e&&z.error("删除失败")}})),me=e=>{ne.avatar=e.url,z.success("头像上传成功")},pe=e=>{z.error(e||"头像上传失败")},fe=()=>e(this,null,(function*(){try{yield b.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),A.logout(),C.push("/login")}catch(e){}}));return o((()=>e(this,null,(function*(){yield oe(),yield de()})))),(e,a)=>{const i=v("ArrowLeft"),n=v("el-icon"),c=v("el-button"),o=v("el-avatar"),f=v("ArrowRight"),_=v("User"),w=v("el-tag"),k=v("SwitchButton"),x=v("el-form-item"),b=v("el-input"),z=v("el-form"),V=v("el-dialog");return s(),l("div",B,[t("div",T,[r(c,{onClick:a[0]||(a[0]=a=>e.$router.push("/chat")),type:"text",size:"small"},{default:d((()=>[r(n,null,{default:d((()=>[r(i)])),_:1})])),_:1}),a[7]||(a[7]=t("div",{class:"wechat-header-title"},"我",-1)),a[8]||(a[8]=t("div",null,null,-1))]),t("div",P,[t("div",E,[t("div",I,[t("div",R,[r(o,{src:ne.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),t("div",D,[t("div",F,u(ne.nickname||ne.username),1),t("div",$,"微信号："+u(ne.username),1)]),r(c,{type:"text",size:"small"},{default:d((()=>[r(n,null,{default:d((()=>[r(f)])),_:1})])),_:1})])])]),t("div",L,[t("div",M,[t("div",{class:"wechat-list-item",onClick:a[1]||(a[1]=e=>re.value=!0)},[r(n,null,{default:d((()=>[r(_)])),_:1}),a[9]||(a[9]=t("span",{class:"function-text"},"个人资料",-1)),r(n,null,{default:d((()=>[r(f)])),_:1})])]),t("div",O,[t("div",K,[a[10]||(a[10]=t("span",null,"好友管理",-1)),t("span",N,"("+u(S.value.length)+")",1)]),t("div",Q,[(s(!0),l(m,null,p(S.value,(e=>(s(),l("div",{key:e._id,class:"wechat-list-item"},[r(o,{src:e.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),t("div",W,[t("div",X,u(e.nickname||e.username),1),t("div",q,[t("span",{class:y(["user-status",e.status])},null,2),h(" "+u("online"===e.status?"在线":"离线"),1)])]),r(c,{type:"text",size:"small",onClick:a=>ve(e._id),class:"delete-btn"},{default:d((()=>a[11]||(a[11]=[h(" 删除 ",-1)]))),_:2,__:[11]},1032,["onClick"])])))),128))])]),t("div",G,[t("div",H,[a[12]||(a[12]=t("span",null,"群组管理",-1)),t("span",J,"("+u(te.value.length)+")",1)]),t("div",Y,[(s(!0),l(m,null,p(te.value,(e=>{var a;return s(),l("div",{key:e._id,class:"wechat-list-item"},[r(o,{src:e.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),t("div",Z,[t("div",ee,u(e.name),1),t("div",ae,u(e.members.length)+"人",1)]),t("div",le,[r(w,{type:"admin"===(null==(a=e.members.find((e=>{var a;return e.user._id===(null==(a=g(A).user)?void 0:a.id)})))?void 0:a.role)?"danger":"info",size:"small"},{default:d((()=>{var a;return[h(u("admin"===(null==(a=e.members.find((e=>{var a;return e.user._id===(null==(a=g(A).user)?void 0:a.id)})))?void 0:a.role)?"管理员":"成员"),1)]})),_:2},1032,["type"])])])})),128))])]),t("div",se,[t("div",{class:"wechat-list-item logout-item",onClick:fe},[r(n,null,{default:d((()=>[r(k)])),_:1}),a[13]||(a[13]=t("span",{class:"function-text"},"退出登录",-1))])])])]),r(V,{modelValue:re.value,"onUpdate:modelValue":a[6]||(a[6]=e=>re.value=e),title:"编辑个人资料",width:"500px"},{footer:d((()=>[r(c,{onClick:a[5]||(a[5]=e=>re.value=!1)},{default:d((()=>a[14]||(a[14]=[h("取消",-1)]))),_:1,__:[14]}),r(c,{type:"primary",onClick:ce,loading:ie.value},{default:d((()=>a[15]||(a[15]=[h(" 保存 ",-1)]))),_:1,__:[15]},8,["loading"])])),default:d((()=>[r(z,{ref_key:"profileFormRef",ref:U,model:ne,rules:ue,"label-width":"80px"},{default:d((()=>[r(x,{label:"头像"},{default:d((()=>[r(j,{"current-avatar":ne.avatar,size:"xlarge",onUploadSuccess:me,onUploadError:pe},null,8,["current-avatar"])])),_:1}),r(x,{label:"用户名"},{default:d((()=>[r(b,{modelValue:ne.username,"onUpdate:modelValue":a[2]||(a[2]=e=>ne.username=e),disabled:""},null,8,["modelValue"])])),_:1}),r(x,{label:"邮箱"},{default:d((()=>[r(b,{modelValue:ne.email,"onUpdate:modelValue":a[3]||(a[3]=e=>ne.email=e),disabled:""},null,8,["modelValue"])])),_:1}),r(x,{label:"昵称",prop:"nickname"},{default:d((()=>[r(b,{modelValue:ne.nickname,"onUpdate:modelValue":a[4]||(a[4]=e=>ne.nickname=e),placeholder:"请输入昵称"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-ad7cecfa"]]);export{te as default};
