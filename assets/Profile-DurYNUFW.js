var oe=Object.defineProperty;var u=(y,z)=>oe(y,"name",{value:z,configurable:!0});import{r as p,y as h,z as w,A as e,K as Q,Q as t,C as le,O as d,X as ne,h as re,I as n,al as r,P as W,a6 as X,aC as ie,M as S,D as ce,u as q}from"./vendor-4TsGYA0n.js";import{u as ue,b as P}from"./index-Chbkutgr.js";import{A as de}from"./Avatar-Bh-zq9do.js";import{_ as J}from"./_plugin-vue_export-helper-y4GvAF8u.js";import{d as H,E as b}from"./element-DsYCR5Of.js";const me={class:"avatar-upload"},pe={key:0,class:"upload-progress"},ve={class:"progress-bar"},_e={class:"progress-text"},fe={key:1,class:"upload-error"},ge={__name:"AvatarUpload",props:{currentAvatar:{type:String,default:""},size:{type:String,default:"large"},maxSize:{type:Number,default:5*1024*1024}},emits:["upload-success","upload-error"],setup(y,{emit:z}){const i=y,C=z,k=p(null),_=p(""),f=p(!1),m=p(0),l=p(""),R=u(()=>{var g;(g=k.value)==null||g.click()},"triggerFileInput"),T=u(async g=>{const c=g.target.files[0];if(!c)return;if(!c.type.startsWith("image/")){l.value="请选择图片文件";return}if(c.size>i.maxSize){l.value=`文件大小不能超过 ${i.maxSize/1024/1024}MB`;return}l.value="";const $=new FileReader;$.onload=v=>{_.value=v.target.result},$.readAsDataURL(c);try{f.value=!0,m.value=0;const v=new FormData;v.append("avatar",c);const U=await fetch("/api/upload/avatar",{method:"POST",body:v});if(!U.ok)throw new Error("上传失败");const x=await U.json();if(x.success)m.value=100,f.value=!1,_.value=x.data.url,C("upload-success",{url:x.data.url,file:c}),setTimeout(()=>{_.value=""},1e3);else throw new Error(x.message||"上传失败")}catch(v){f.value=!1,l.value=v.message||"上传失败",C("upload-error",v.message||"上传失败")}},"handleFileChange");return(g,c)=>(w(),h("div",me,[e("div",{class:"avatar-preview",onClick:R},[t(de,{src:_.value||y.currentAvatar,size:y.size},null,8,["src","size"]),c[0]||(c[0]=e("div",{class:"upload-overlay"},[e("i",{class:"iconfont icon-image"}),e("span",null,"更换头像")],-1))]),e("input",{ref_key:"fileInput",ref:k,type:"file",accept:"image/*",onChange:T,style:{display:"none"}},null,544),f.value?(w(),h("div",pe,[e("div",ve,[e("div",{class:"progress-fill",style:le({width:m.value+"%"})},null,4)]),e("span",_e,d(m.value)+"%",1)])):Q("",!0),l.value?(w(),h("div",fe,d(l.value),1)):Q("",!0)]))}},he=J(ge,[["__scopeId","data-v-13514240"]]),we={class:"wechat-page"},ye={class:"wechat-header"},ke={class:"wechat-content"},xe={class:"profile-section"},be={class:"profile-card"},ze={class:"profile-header"},Ce={class:"profile-info"},Ve={class:"profile-name"},Ae={class:"profile-username"},Se={class:"function-list"},$e={class:"function-section"},Ue={class:"function-section"},Be={class:"section-header"},Ee={class:"section-count"},Fe={class:"friends-list"},Pe={class:"friend-info"},Re={class:"friend-name"},Te={class:"friend-status"},Ie={class:"function-section"},De={class:"section-header"},Le={class:"section-count"},Me={class:"groups-list"},Ne={class:"group-info"},Oe={class:"group-name"},je={class:"group-members"},Ge={class:"group-role"},Ke={class:"function-section"},Qe={__name:"Profile",setup(y){var M,N,O,j;const z=ie(),i=ue(),C=p(),k=p([]),_=p([]),f=p(!1),m=p(!1),l=ne({username:((M=i.user)==null?void 0:M.username)||"",email:((N=i.user)==null?void 0:N.email)||"",nickname:((O=i.user)==null?void 0:O.nickname)||"",avatar:((j=i.user)==null?void 0:j.avatar)||""}),R={nickname:[{max:20,message:"昵称长度不能超过20个字符",trigger:"blur"}]},T=u(async()=>{try{await C.value.validate(),f.value=!0;const o=await P.put("/api/users/profile",{nickname:l.nickname,avatar:l.avatar});o.data.success&&(b.success("更新成功"),i.user=o.data.user,m.value=!1)}catch(o){console.error("更新个人资料失败:",o),b.error("更新失败")}finally{f.value=!1}},"updateProfile"),g=u(async()=>{try{const o=await P.get("/api/users/friends/list");o.data.success&&(k.value=o.data.friends)}catch(o){console.error("获取好友列表失败:",o)}},"getFriends"),c=u(async()=>{try{const o=await P.get("/api/chats/groups");o.data.success&&(_.value=o.data.groups)}catch(o){console.error("获取群组列表失败:",o)}},"getGroups"),$=u(async o=>{try{await H.confirm("确定要删除这个好友吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await P.delete(`/api/users/friends/${o}`)).data.success&&(b.success("删除成功"),await g())}catch(s){s!=="cancel"&&(console.error("删除好友失败:",s),b.error("删除失败"))}},"removeFriend"),v=u(o=>{l.avatar=o.url,b.success("头像上传成功")},"handleAvatarUpload"),U=u(o=>{b.error(o||"头像上传失败")},"handleAvatarError"),x=u(async()=>{try{await H.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),i.logout(),z.push("/login")}catch{}},"handleLogout");return re(async()=>{await g(),await c()}),(o,s)=>{const Y=r("ArrowLeft"),V=r("el-icon"),A=r("el-button"),I=r("el-avatar"),G=r("ArrowRight"),Z=r("User"),ee=r("el-tag"),se=r("SwitchButton"),B=r("el-form-item"),D=r("el-input"),te=r("el-form"),ae=r("el-dialog");return w(),h("div",we,[e("div",ye,[t(A,{onClick:s[0]||(s[0]=a=>o.$router.push("/chat")),type:"text",size:"small"},{default:n(()=>[t(V,null,{default:n(()=>[t(Y)]),_:1})]),_:1}),s[7]||(s[7]=e("div",{class:"wechat-header-title"},"我",-1)),s[8]||(s[8]=e("div",null,null,-1))]),e("div",ke,[e("div",xe,[e("div",be,[e("div",ze,[t(I,{src:l.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),e("div",Ce,[e("div",Ve,d(l.nickname||l.username),1),e("div",Ae,"微信号："+d(l.username),1)]),t(A,{type:"text",size:"small"},{default:n(()=>[t(V,null,{default:n(()=>[t(G)]),_:1})]),_:1})])])]),e("div",Se,[e("div",$e,[e("div",{class:"wechat-list-item",onClick:s[1]||(s[1]=a=>m.value=!0)},[t(V,null,{default:n(()=>[t(Z)]),_:1}),s[9]||(s[9]=e("span",{class:"function-text"},"个人资料",-1)),t(V,null,{default:n(()=>[t(G)]),_:1})])]),e("div",Ue,[e("div",Be,[s[10]||(s[10]=e("span",null,"好友管理",-1)),e("span",Ee,"("+d(k.value.length)+")",1)]),e("div",Fe,[(w(!0),h(W,null,X(k.value,a=>(w(),h("div",{key:a._id,class:"wechat-list-item"},[t(I,{src:a.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),e("div",Pe,[e("div",Re,d(a.nickname||a.username),1),e("div",Te,[e("span",{class:ce(["user-status",a.status])},null,2),S(" "+d(a.status==="online"?"在线":"离线"),1)])]),t(A,{type:"text",size:"small",onClick:u(L=>$(a._id),"onClick"),class:"delete-btn"},{default:n(()=>s[11]||(s[11]=[S(" 删除 ",-1)])),_:2,__:[11]},1032,["onClick"])]))),128))])]),e("div",Ie,[e("div",De,[s[12]||(s[12]=e("span",null,"群组管理",-1)),e("span",Le,"("+d(_.value.length)+")",1)]),e("div",Me,[(w(!0),h(W,null,X(_.value,a=>{var L;return w(),h("div",{key:a._id,class:"wechat-list-item"},[t(I,{src:a.avatar,size:"small",class:"wechat-avatar"},null,8,["src"]),e("div",Ne,[e("div",Oe,d(a.name),1),e("div",je,d(a.members.length)+"人",1)]),e("div",Ge,[t(ee,{type:((L=a.members.find(E=>{var F;return E.user._id===((F=q(i).user)==null?void 0:F.id)}))==null?void 0:L.role)==="admin"?"danger":"info",size:"small"},{default:n(()=>{var E;return[S(d(((E=a.members.find(F=>{var K;return F.user._id===((K=q(i).user)==null?void 0:K.id)}))==null?void 0:E.role)==="admin"?"管理员":"成员"),1)]}),_:2},1032,["type"])])])}),128))])]),e("div",Ke,[e("div",{class:"wechat-list-item logout-item",onClick:x},[t(V,null,{default:n(()=>[t(se)]),_:1}),s[13]||(s[13]=e("span",{class:"function-text"},"退出登录",-1))])])])]),t(ae,{modelValue:m.value,"onUpdate:modelValue":s[6]||(s[6]=a=>m.value=a),title:"编辑个人资料",width:"500px"},{footer:n(()=>[t(A,{onClick:s[5]||(s[5]=a=>m.value=!1)},{default:n(()=>s[14]||(s[14]=[S("取消",-1)])),_:1,__:[14]}),t(A,{type:"primary",onClick:T,loading:f.value},{default:n(()=>s[15]||(s[15]=[S(" 保存 ",-1)])),_:1,__:[15]},8,["loading"])]),default:n(()=>[t(te,{ref_key:"profileFormRef",ref:C,model:l,rules:R,"label-width":"80px"},{default:n(()=>[t(B,{label:"头像"},{default:n(()=>[t(he,{"current-avatar":l.avatar,size:"xlarge",onUploadSuccess:v,onUploadError:U},null,8,["current-avatar"])]),_:1}),t(B,{label:"用户名"},{default:n(()=>[t(D,{modelValue:l.username,"onUpdate:modelValue":s[2]||(s[2]=a=>l.username=a),disabled:""},null,8,["modelValue"])]),_:1}),t(B,{label:"邮箱"},{default:n(()=>[t(D,{modelValue:l.email,"onUpdate:modelValue":s[3]||(s[3]=a=>l.email=a),disabled:""},null,8,["modelValue"])]),_:1}),t(B,{label:"昵称",prop:"nickname"},{default:n(()=>[t(D,{modelValue:l.nickname,"onUpdate:modelValue":s[4]||(s[4]=a=>l.nickname=a),placeholder:"请输入昵称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Ze=J(Qe,[["__scopeId","data-v-ad7cecfa"]]);export{Ze as default};
