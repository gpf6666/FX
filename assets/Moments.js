import{r as w,ad as ve,y as he,B as d,D as n,W as t,O as a,bm as m,Q as v,u as c,U as h,V as z,aw as B,cs as V,C as u,aL as ge,cz as ke,N as F,bK as ye,S as p,G as Q,cA as we,bQ as q,cB as be,at as Ce,aa as Ve,cC as $e}from"./vendor.js";import{u as xe,a as Me}from"./index.js";import{_ as ze}from"./_plugin-vue_export-helper.js";import{E as g,a as Be}from"./element.js";const Te={class:"wechat-page"},Ne={class:"wechat-header moments-header-custom"},Se={class:"wechat-content"},Ue={class:"moments-header"},Le={class:"user-profile"},Pe={class:"user-name"},De={class:"publish-moment"},Ie={class:"publish-card"},Ee={class:"publish-header"},Ke={class:"moments-list"},Oe={class:"moment-header"},Ae={class:"moment-info"},Re={class:"moment-author"},je={class:"moment-time"},Fe={class:"moment-content"},Qe={key:0,class:"moment-images"},qe=["onClick"],Ge=["src","alt"],We={key:1,class:"moment-location"},He={class:"moment-actions"},Je={class:"action-buttons"},Xe={key:2,class:"moment-likes"},Ye={key:0},Ze={key:3,class:"moment-comments"},et={class:"comment-author"},tt={key:0,class:"comment-reply"},st={class:"comment-content"},ot={key:4,class:"comment-input"},at={key:0,class:"load-more"},lt={key:1,class:"wechat-empty"},nt={class:"wechat-empty-icon"},it={__name:"Moments",setup(rt){const k=xe(),G=Me(),f=w([]),$=w(!1),T=w(!1),D=w(!0),N=w(1),b=w(!1),S=w(null),C=w(""),_=ve({content:"",images:[],location:"",isPublic:!0}),U=async(o=!1)=>{if(!$.value){$.value=!0;try{o&&(N.value=1,f.value=[]);const e=await V.get("/api/moments",{params:{page:N.value,limit:10}});e.data.success&&(o?f.value=e.data.moments:f.value.push(...e.data.moments),D.value=e.data.moments.length===10,N.value++)}catch(e){console.error("获取朋友圈失败:",e),g.error("获取朋友圈失败")}finally{$.value=!1}}},W=async()=>{if(!_.content.trim()){g.warning("请输入内容");return}T.value=!0;try{(await V.post("/api/moments",_)).data.success&&(g.success("发布成功"),b.value=!1,Object.assign(_,{content:"",images:[],location:"",isPublic:!0}),await U(!0))}catch(o){console.error("发布朋友圈失败:",o),g.error("发布失败")}finally{T.value=!1}},H=async o=>{try{const e=await V.post(`/api/moments/${o}/like`);if(e.data.success){const l=f.value.find(i=>i._id===o);l&&(l.likes=e.data.moment.likes)}}catch(e){console.error("操作失败:",e),g.error("操作失败")}},J=o=>{S.value=o,C.value=""},I=async o=>{if(!C.value.trim()){g.warning("请输入评论内容");return}try{const e=await V.post(`/api/moments/${o}/comment`,{content:C.value});if(e.data.success){const l=f.value.find(i=>i._id===o);l&&(l.comments=e.data.moment.comments),C.value="",S.value=null}}catch(e){console.error("评论失败:",e),g.error("评论失败")}},X=async(o,e)=>{try{const l=await V.delete(`/api/moments/${o}/comment/${e}`);if(l.data.success){const i=f.value.find(x=>x._id===o);i&&(i.comments=l.data.moment.comments),g.success("删除成功")}}catch(l){console.error("删除评论失败:",l),g.error("删除失败")}},Y=async o=>{try{(await V.delete(`/api/moments/${o}`)).data.success&&(f.value=f.value.filter(l=>l._id!==o),g.success("删除成功"))}catch(e){console.error("删除朋友圈失败:",e),g.error("删除失败")}},Z=o=>{o.action==="delete"&&Be.confirm("确定要删除这条朋友圈吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Y(o.momentId)})},ee=o=>o.likes.some(e=>{var l;return e.user._id===((l=k.user)==null?void 0:l.id)}),te=o=>{const e=new Date,l=new Date(o),i=e-l;return i<6e4?"刚刚":i<36e5?`${Math.floor(i/6e4)}分钟前`:i<864e5?`${Math.floor(i/36e5)}小时前`:i<2592e6?`${Math.floor(i/864e5)}天前`:l.toLocaleDateString("zh-CN")},se=o=>o===1?"single":o===2?"double":o===3?"triple":o===4?"quad":"grid",oe=()=>{U()},ae=o=>{_.images.push(URL.createObjectURL(o.raw))},le=o=>{const e=_.images.indexOf(o.url);e>-1&&_.images.splice(e,1)},ne=(o,e)=>{console.log("预览图片:",o[e])},ie=o=>{f.value.unshift(o)};return he(async()=>{await U(!0),G.onNewMoment(ie)}),(o,e)=>{var K,O,A,R;const l=m("el-icon"),i=m("el-button"),x=m("el-avatar"),re=m("el-dropdown-item"),ue=m("el-dropdown-menu"),de=m("el-dropdown"),L=m("el-input"),M=m("el-form-item"),ce=m("Plus"),me=m("el-upload"),E=m("el-radio"),_e=m("el-radio-group"),pe=m("el-form"),fe=m("el-dialog");return u(),d("div",Te,[n("div",Ne,[t(i,{onClick:e[0]||(e[0]=s=>o.$router.push("/chat")),type:"text",size:"small",class:"header-btn-white"},{default:a(()=>[t(l,null,{default:a(()=>[t(c(ge))]),_:1})]),_:1}),e[9]||(e[9]=n("div",{class:"wechat-header-title moments-title-white"},"朋友圈",-1)),t(i,{type:"text",size:"small",onClick:e[1]||(e[1]=s=>b.value=!0),class:"header-btn-white"},{default:a(()=>[t(l,null,{default:a(()=>[t(c(ke))]),_:1})]),_:1})]),n("div",Se,[n("div",Ue,[e[10]||(e[10]=n("div",{class:"moments-cover"},[n("div",{class:"cover-image"})],-1)),n("div",Le,[t(x,{src:(K=c(k).user)==null?void 0:K.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),n("div",Pe,h(((O=c(k).user)==null?void 0:O.nickname)||((A=c(k).user)==null?void 0:A.username)),1)])]),n("div",De,[n("div",Ie,[n("div",Ee,[t(x,{src:(R=c(k).user)==null?void 0:R.avatar,size:"small"},null,8,["src"]),n("div",{class:"publish-input",onClick:e[2]||(e[2]=s=>b.value=!0)},e[11]||(e[11]=[n("span",{class:"publish-placeholder"},"这一刻的想法...",-1)]))])])]),n("div",Ke,[(u(!0),d(z,null,B(f.value,s=>{var j;return u(),d("div",{key:s._id,class:"moment-item"},[n("div",Oe,[t(x,{src:s.author.avatar,size:"small",class:"moment-avatar"},null,8,["src"]),n("div",Ae,[n("div",Re,h(s.author.nickname||s.author.username),1),n("div",je,h(te(s.createdAt)),1)]),s.author._id===((j=c(k).user)==null?void 0:j.id)?(u(),F(de,{key:0,onCommand:Z},{dropdown:a(()=>[t(ue,null,{default:a(()=>[t(re,{command:{action:"delete",momentId:s._id}},{default:a(()=>e[12]||(e[12]=[p(" 删除 ",-1)])),_:2,__:[12]},1032,["command"])]),_:2},1024)]),default:a(()=>[t(i,{type:"text",size:"small"},{default:a(()=>[t(l,null,{default:a(()=>[t(c(ye))]),_:1})]),_:1})]),_:2},1024)):v("",!0)]),n("div",Fe,h(s.content),1),s.images&&s.images.length>0?(u(),d("div",Qe,[(u(!0),d(z,null,B(s.images,(r,y)=>(u(),d("div",{key:y,class:Q(["moment-image-wrapper",se(s.images.length)]),onClick:P=>ne(s.images,y)},[n("img",{src:r,alt:`朋友圈图片 ${y+1}`,class:"moment-image"},null,8,Ge)],10,qe))),128))])):v("",!0),s.location?(u(),d("div",We,[t(l,null,{default:a(()=>[t(c(we))]),_:1}),p(" "+h(s.location),1)])):v("",!0),n("div",He,[n("div",Je,[t(i,{type:"text",size:"small",class:Q({liked:ee(s)}),onClick:r=>H(s._id)},{default:a(()=>[t(l,null,{default:a(()=>[t(c(q))]),_:1}),p(" "+h(s.likes.length>0?s.likes.length:"")+" 赞 ",1)]),_:2},1032,["class","onClick"]),t(i,{type:"text",size:"small",onClick:r=>J(s._id)},{default:a(()=>[t(l,null,{default:a(()=>[t(c(be))]),_:1}),p(" "+h(s.comments.length>0?s.comments.length:"")+" 评论 ",1)]),_:2},1032,["onClick"])])]),s.likes.length>0?(u(),d("div",Xe,[t(l,null,{default:a(()=>[t(c(q))]),_:1}),(u(!0),d(z,null,B(s.likes,(r,y)=>(u(),d("span",{key:r.user._id},[p(h(r.user.nickname||r.user.username)+" ",1),y<s.likes.length-1?(u(),d("span",Ye,"、")):v("",!0)]))),128))])):v("",!0),s.comments.length>0?(u(),d("div",Ze,[(u(!0),d(z,null,B(s.comments,r=>{var y,P;return u(),d("div",{key:r._id,class:"comment-item"},[n("span",et,h(r.user.nickname||r.user.username),1),r.replyTo?(u(),d("span",tt," 回复 "+h(r.replyTo.nickname||r.replyTo.username)+"： ",1)):v("",!0),n("span",st,h(r.content),1),r.user._id===((y=c(k).user)==null?void 0:y.id)||s.author._id===((P=c(k).user)==null?void 0:P.id)?(u(),F(i,{key:1,type:"text",size:"small",onClick:ut=>X(s._id,r._id)},{default:a(()=>e[13]||(e[13]=[p(" 删除 ",-1)])),_:2,__:[13]},1032,["onClick"])):v("",!0)])}),128))])):v("",!0),S.value===s._id?(u(),d("div",ot,[t(L,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=r=>C.value=r),placeholder:"写评论...",onKeydown:Ce(Ve(r=>I(s._id),["prevent"]),["enter"])},{append:a(()=>[t(i,{onClick:r=>I(s._id)},{default:a(()=>e[14]||(e[14]=[p("发送",-1)])),_:2,__:[14]},1032,["onClick"])]),_:2},1032,["modelValue","onKeydown"])])):v("",!0)])}),128))]),D.value?(u(),d("div",at,[t(i,{onClick:oe,loading:$.value},{default:a(()=>e[15]||(e[15]=[p("加载更多",-1)])),_:1,__:[15]},8,["loading"])])):v("",!0),f.value.length===0&&!$.value?(u(),d("div",lt,[n("div",nt,[t(l,null,{default:a(()=>[t(c($e))]),_:1})]),e[16]||(e[16]=n("p",null,"暂无朋友圈内容",-1))])):v("",!0)]),t(fe,{modelValue:b.value,"onUpdate:modelValue":e[8]||(e[8]=s=>b.value=s),title:"发布朋友圈",width:"600px"},{footer:a(()=>[t(i,{onClick:e[7]||(e[7]=s=>b.value=!1)},{default:a(()=>e[19]||(e[19]=[p("取消",-1)])),_:1,__:[19]}),t(i,{type:"primary",onClick:W,loading:T.value},{default:a(()=>e[20]||(e[20]=[p(" 发布 ",-1)])),_:1,__:[20]},8,["loading"])]),default:a(()=>[t(pe,{model:_,"label-width":"80px"},{default:a(()=>[t(M,{label:"内容"},{default:a(()=>[t(L,{modelValue:_.content,"onUpdate:modelValue":e[4]||(e[4]=s=>_.content=s),type:"textarea",rows:4,placeholder:"这一刻的想法..."},null,8,["modelValue"])]),_:1}),t(M,{label:"图片"},{default:a(()=>[t(me,{action:"#","list-type":"picture-card","auto-upload":!1,"on-change":ae,"on-remove":le,limit:9},{default:a(()=>[t(l,null,{default:a(()=>[t(ce)]),_:1})]),_:1})]),_:1}),t(M,{label:"位置"},{default:a(()=>[t(L,{modelValue:_.location,"onUpdate:modelValue":e[5]||(e[5]=s=>_.location=s),placeholder:"添加位置（可选）"},null,8,["modelValue"])]),_:1}),t(M,{label:"可见性"},{default:a(()=>[t(_e,{modelValue:_.isPublic,"onUpdate:modelValue":e[6]||(e[6]=s=>_.isPublic=s)},{default:a(()=>[t(E,{label:!0},{default:a(()=>e[17]||(e[17]=[p("公开",-1)])),_:1,__:[17]}),t(E,{label:!1},{default:a(()=>e[18]||(e[18]=[p("仅好友可见",-1)])),_:1,__:[18]})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},pt=ze(it,[["__scopeId","data-v-eda14584"]]);export{pt as default};
