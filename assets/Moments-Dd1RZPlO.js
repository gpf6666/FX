import{u as ve,k as he,r as w,a as ge,n as ke,c as d,b as n,e as t,w as l,f as m,p as v,i as c,t as h,F as z,s as T,z as $,E as g,o as u,B as ye,C as we,D as A,G as be,j as p,x as q,H as Ce,I as G,J as $e,y as xe,g as Ve,K as Me,L as ze}from"./index-CkSvKw9W.js";import{_ as Te}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Be={class:"wechat-page"},Le={class:"wechat-header moments-header-custom"},Ne={class:"wechat-content"},Pe={class:"moments-header"},Se={class:"user-profile"},Ue={class:"user-name"},Ie={class:"publish-moment"},De={class:"publish-card"},Ee={class:"publish-header"},Ke={class:"moments-list"},je={class:"moment-header"},Fe={class:"moment-info"},Oe={class:"moment-author"},Re={class:"moment-time"},Ae={class:"moment-content"},qe={key:0,class:"moment-images"},Ge=["onClick"],He=["src","alt"],Je={key:1,class:"moment-location"},Qe={class:"moment-actions"},We={class:"action-buttons"},Xe={key:2,class:"moment-likes"},Ye={key:0},Ze={key:3,class:"moment-comments"},et={class:"comment-author"},tt={key:0,class:"comment-reply"},st={class:"comment-content"},ot={key:4,class:"comment-input"},lt={key:0,class:"load-more"},at={key:1,class:"wechat-empty"},nt={class:"wechat-empty-icon"},it={__name:"Moments",setup(rt){const k=ve(),H=he(),f=w([]),x=w(!1),B=w(!1),I=w(!0),L=w(1),b=w(!1),N=w(null),C=w(""),_=ge({content:"",images:[],location:"",isPublic:!0}),P=async(o=!1)=>{if(!x.value){x.value=!0;try{o&&(L.value=1,f.value=[]);const e=await $.get("/api/moments",{params:{page:L.value,limit:10}});e.data.success&&(o?f.value=e.data.moments:f.value.push(...e.data.moments),I.value=e.data.moments.length===10,L.value++)}catch(e){console.error("获取朋友圈失败:",e),g.error("获取朋友圈失败")}finally{x.value=!1}}},J=async()=>{if(!_.content.trim()){g.warning("请输入内容");return}B.value=!0;try{(await $.post("/api/moments",_)).data.success&&(g.success("发布成功"),b.value=!1,Object.assign(_,{content:"",images:[],location:"",isPublic:!0}),await P(!0))}catch(o){console.error("发布朋友圈失败:",o),g.error("发布失败")}finally{B.value=!1}},Q=async o=>{try{const e=await $.post(`/api/moments/${o}/like`);if(e.data.success){const a=f.value.find(i=>i._id===o);a&&(a.likes=e.data.moment.likes)}}catch(e){console.error("操作失败:",e),g.error("操作失败")}},W=o=>{N.value=o,C.value=""},D=async o=>{if(!C.value.trim()){g.warning("请输入评论内容");return}try{const e=await $.post(`/api/moments/${o}/comment`,{content:C.value});if(e.data.success){const a=f.value.find(i=>i._id===o);a&&(a.comments=e.data.moment.comments),C.value="",N.value=null}}catch(e){console.error("评论失败:",e),g.error("评论失败")}},X=async(o,e)=>{try{const a=await $.delete(`/api/moments/${o}/comment/${e}`);if(a.data.success){const i=f.value.find(V=>V._id===o);i&&(i.comments=a.data.moment.comments),g.success("删除成功")}}catch(a){console.error("删除评论失败:",a),g.error("删除失败")}},Y=async o=>{try{(await $.delete(`/api/moments/${o}`)).data.success&&(f.value=f.value.filter(a=>a._id!==o),g.success("删除成功"))}catch(e){console.error("删除朋友圈失败:",e),g.error("删除失败")}},Z=o=>{o.action==="delete"&&ze.confirm("确定要删除这条朋友圈吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Y(o.momentId)})},ee=o=>o.likes.some(e=>{var a;return e.user._id===((a=k.user)==null?void 0:a.id)}),te=o=>{const e=new Date,a=new Date(o),i=e-a;return i<6e4?"刚刚":i<36e5?`${Math.floor(i/6e4)}分钟前`:i<864e5?`${Math.floor(i/36e5)}小时前`:i<2592e6?`${Math.floor(i/864e5)}天前`:a.toLocaleDateString("zh-CN")},se=o=>o===1?"single":o===2?"double":o===3?"triple":o===4?"quad":"grid",oe=()=>{P()},le=o=>{_.images.push(URL.createObjectURL(o.raw))},ae=o=>{const e=_.images.indexOf(o.url);e>-1&&_.images.splice(e,1)},ne=(o,e)=>{console.log("预览图片:",o[e])},ie=o=>{f.value.unshift(o)};return ke(async()=>{await P(!0),H.onNewMoment(ie)}),(o,e)=>{var K,j,F,O;const a=m("el-icon"),i=m("el-button"),V=m("el-avatar"),re=m("el-dropdown-item"),ue=m("el-dropdown-menu"),de=m("el-dropdown"),S=m("el-input"),M=m("el-form-item"),ce=m("Plus"),me=m("el-upload"),E=m("el-radio"),_e=m("el-radio-group"),pe=m("el-form"),fe=m("el-dialog");return u(),d("div",Be,[n("div",Le,[t(i,{onClick:e[0]||(e[0]=s=>o.$router.push("/chat")),type:"text",size:"small",class:"header-btn-white"},{default:l(()=>[t(a,null,{default:l(()=>[t(c(ye))]),_:1})]),_:1}),e[9]||(e[9]=n("div",{class:"wechat-header-title moments-title-white"},"朋友圈",-1)),t(i,{type:"text",size:"small",onClick:e[1]||(e[1]=s=>b.value=!0),class:"header-btn-white"},{default:l(()=>[t(a,null,{default:l(()=>[t(c(we))]),_:1})]),_:1})]),n("div",Ne,[n("div",Pe,[e[10]||(e[10]=n("div",{class:"moments-cover"},[n("div",{class:"cover-image"})],-1)),n("div",Se,[t(V,{src:(K=c(k).user)==null?void 0:K.avatar,size:"large",class:"profile-avatar"},null,8,["src"]),n("div",Ue,h(((j=c(k).user)==null?void 0:j.nickname)||((F=c(k).user)==null?void 0:F.username)),1)])]),n("div",Ie,[n("div",De,[n("div",Ee,[t(V,{src:(O=c(k).user)==null?void 0:O.avatar,size:"small"},null,8,["src"]),n("div",{class:"publish-input",onClick:e[2]||(e[2]=s=>b.value=!0)},e[11]||(e[11]=[n("span",{class:"publish-placeholder"},"这一刻的想法...",-1)]))])])]),n("div",Ke,[(u(!0),d(z,null,T(f.value,s=>{var R;return u(),d("div",{key:s._id,class:"moment-item"},[n("div",je,[t(V,{src:s.author.avatar,size:"small",class:"moment-avatar"},null,8,["src"]),n("div",Fe,[n("div",Oe,h(s.author.nickname||s.author.username),1),n("div",Re,h(te(s.createdAt)),1)]),s.author._id===((R=c(k).user)==null?void 0:R.id)?(u(),A(de,{key:0,onCommand:Z},{dropdown:l(()=>[t(ue,null,{default:l(()=>[t(re,{command:{action:"delete",momentId:s._id}},{default:l(()=>e[12]||(e[12]=[p(" 删除 ",-1)])),_:2,__:[12]},1032,["command"])]),_:2},1024)]),default:l(()=>[t(i,{type:"text",size:"small"},{default:l(()=>[t(a,null,{default:l(()=>[t(c(be))]),_:1})]),_:1})]),_:2},1024)):v("",!0)]),n("div",Ae,h(s.content),1),s.images&&s.images.length>0?(u(),d("div",qe,[(u(!0),d(z,null,T(s.images,(r,y)=>(u(),d("div",{key:y,class:q(["moment-image-wrapper",se(s.images.length)]),onClick:U=>ne(s.images,y)},[n("img",{src:r,alt:`朋友圈图片 ${y+1}`,class:"moment-image"},null,8,He)],10,Ge))),128))])):v("",!0),s.location?(u(),d("div",Je,[t(a,null,{default:l(()=>[t(c(Ce))]),_:1}),p(" "+h(s.location),1)])):v("",!0),n("div",Qe,[n("div",We,[t(i,{type:"text",size:"small",class:q({liked:ee(s)}),onClick:r=>Q(s._id)},{default:l(()=>[t(a,null,{default:l(()=>[t(c(G))]),_:1}),p(" "+h(s.likes.length>0?s.likes.length:"")+" 赞 ",1)]),_:2},1032,["class","onClick"]),t(i,{type:"text",size:"small",onClick:r=>W(s._id)},{default:l(()=>[t(a,null,{default:l(()=>[t(c($e))]),_:1}),p(" "+h(s.comments.length>0?s.comments.length:"")+" 评论 ",1)]),_:2},1032,["onClick"])])]),s.likes.length>0?(u(),d("div",Xe,[t(a,null,{default:l(()=>[t(c(G))]),_:1}),(u(!0),d(z,null,T(s.likes,(r,y)=>(u(),d("span",{key:r.user._id},[p(h(r.user.nickname||r.user.username)+" ",1),y<s.likes.length-1?(u(),d("span",Ye,"、")):v("",!0)]))),128))])):v("",!0),s.comments.length>0?(u(),d("div",Ze,[(u(!0),d(z,null,T(s.comments,r=>{var y,U;return u(),d("div",{key:r._id,class:"comment-item"},[n("span",et,h(r.user.nickname||r.user.username),1),r.replyTo?(u(),d("span",tt," 回复 "+h(r.replyTo.nickname||r.replyTo.username)+"： ",1)):v("",!0),n("span",st,h(r.content),1),r.user._id===((y=c(k).user)==null?void 0:y.id)||s.author._id===((U=c(k).user)==null?void 0:U.id)?(u(),A(i,{key:1,type:"text",size:"small",onClick:ut=>X(s._id,r._id)},{default:l(()=>e[13]||(e[13]=[p(" 删除 ",-1)])),_:2,__:[13]},1032,["onClick"])):v("",!0)])}),128))])):v("",!0),N.value===s._id?(u(),d("div",ot,[t(S,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=r=>C.value=r),placeholder:"写评论...",onKeydown:xe(Ve(r=>D(s._id),["prevent"]),["enter"])},{append:l(()=>[t(i,{onClick:r=>D(s._id)},{default:l(()=>e[14]||(e[14]=[p("发送",-1)])),_:2,__:[14]},1032,["onClick"])]),_:2},1032,["modelValue","onKeydown"])])):v("",!0)])}),128))]),I.value?(u(),d("div",lt,[t(i,{onClick:oe,loading:x.value},{default:l(()=>e[15]||(e[15]=[p("加载更多",-1)])),_:1,__:[15]},8,["loading"])])):v("",!0),f.value.length===0&&!x.value?(u(),d("div",at,[n("div",nt,[t(a,null,{default:l(()=>[t(c(Me))]),_:1})]),e[16]||(e[16]=n("p",null,"暂无朋友圈内容",-1))])):v("",!0)]),t(fe,{modelValue:b.value,"onUpdate:modelValue":e[8]||(e[8]=s=>b.value=s),title:"发布朋友圈",width:"600px"},{footer:l(()=>[t(i,{onClick:e[7]||(e[7]=s=>b.value=!1)},{default:l(()=>e[19]||(e[19]=[p("取消",-1)])),_:1,__:[19]}),t(i,{type:"primary",onClick:J,loading:B.value},{default:l(()=>e[20]||(e[20]=[p(" 发布 ",-1)])),_:1,__:[20]},8,["loading"])]),default:l(()=>[t(pe,{model:_,"label-width":"80px"},{default:l(()=>[t(M,{label:"内容"},{default:l(()=>[t(S,{modelValue:_.content,"onUpdate:modelValue":e[4]||(e[4]=s=>_.content=s),type:"textarea",rows:4,placeholder:"这一刻的想法..."},null,8,["modelValue"])]),_:1}),t(M,{label:"图片"},{default:l(()=>[t(me,{action:"#","list-type":"picture-card","auto-upload":!1,"on-change":le,"on-remove":ae,limit:9},{default:l(()=>[t(a,null,{default:l(()=>[t(ce)]),_:1})]),_:1})]),_:1}),t(M,{label:"位置"},{default:l(()=>[t(S,{modelValue:_.location,"onUpdate:modelValue":e[5]||(e[5]=s=>_.location=s),placeholder:"添加位置（可选）"},null,8,["modelValue"])]),_:1}),t(M,{label:"可见性"},{default:l(()=>[t(_e,{modelValue:_.isPublic,"onUpdate:modelValue":e[6]||(e[6]=s=>_.isPublic=s)},{default:l(()=>[t(E,{label:!0},{default:l(()=>e[17]||(e[17]=[p("公开",-1)])),_:1,__:[17]}),t(E,{label:!1},{default:l(()=>e[18]||(e[18]=[p("仅好友可见",-1)])),_:1,__:[18]})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},mt=Te(it,[["__scopeId","data-v-eda14584"]]);export{mt as default};
