import{r as c,c as Y,j as Z,h as Ae,y as r,A as a,K as m,V as h,D as b,Q as B,u as Ne,J as ee,aj as te,P as G,a6 as K,O as g,M as ze,a4 as Le,n as A,aC as Ee,z as u}from"./chat-vendor-BrOh9MUQ.js";import{u as Ue,a as Ve,b as _}from"./chat-index-C3bXbBuM.js";import{A as P}from"./chat-Avatar-D-uQkRWk.js";import{_ as je}from"./chat-_plugin-vue_export-helper-DlAUqK2U.js";import{E as se}from"./chat-element-C03ZGswg.js";const Re={class:"wechat-container"},Fe={class:"sidebar-header"},Oe={class:"user-avatar"},Be={class:"user-actions"},Ge={class:"search-box"},Ke={class:"search-input"},Pe={class:"function-buttons"},He={class:"chat-list"},Je=["onClick"],Qe={class:"chat-avatar"},We={key:0,class:"unread-badge"},qe={class:"chat-info"},Xe={class:"chat-name"},Ye={class:"chat-last-message"},Ze={class:"chat-time"},et={class:"main-chat"},tt={key:0,class:"chat-area"},st={class:"chat-header"},at={class:"chat-title"},nt={key:0,class:"online-status"},ot={class:"chat-actions"},it={class:"messages-wrapper"},lt={key:0,class:"load-more"},rt=["disabled"],ut={key:0,class:"time-divider"},ct={key:0,class:"message-avatar"},dt={key:1,class:"message-avatar-placeholder"},vt={class:"message-content"},pt={class:"message-bubble"},gt={class:"message-text"},ft={class:"message-status"},mt={class:"message-time"},ht={key:0,class:"message-status-icon"},_t={key:0,class:"iconfont icon-loading"},wt={key:1,class:"iconfont icon-check"},yt={key:2,class:"iconfont icon-check-double"},Ct={class:"input-area"},bt={class:"input-toolbar"},kt={class:"input-container"},St=["onKeydown"],Mt=["disabled"],Dt={key:1,class:"welcome-page"},Tt={key:0,class:"emoji-picker"},It={class:"emoji-list"},xt=["onClick"],$t={key:2,class:"voice-recorder"},At={class:"voice-modal"},Nt={class:"voice-content"},S=20,zt={__name:"Chat",setup(Lt){const M=Ee(),p=Ue(),N=Ve(),l=c(null),v=c([]),f=c(""),z=c(""),L=c(!1),V=c(!1),j=c(!1);c(!1),c(!1);const ae=c(!1),E=c(),R=c(),ne=c(),D=c(!1),T=c(!0),y=c(1),k=c(!1),d=c([]),U=c([]),H=c([]),oe=["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ","ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤¨","ğŸ§","ğŸ¤“","ğŸ˜","ğŸ¤©","ğŸ¥³","ğŸ˜","ğŸ˜’","ğŸ˜","ğŸ˜”","ğŸ˜Ÿ","ğŸ˜•","ğŸ™","â˜¹ï¸","ğŸ˜£","ğŸ˜–","ğŸ˜«","ğŸ˜©","ğŸ¥º","ğŸ˜¢","ğŸ˜­","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬","ğŸ¤¯","ğŸ˜³","ğŸ¥µ","ğŸ¥¶","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ˜¥","ğŸ˜“","ğŸ¤—","ğŸ¤”","ğŸ¤­","ğŸ¤«","ğŸ¤¥","ğŸ˜¶","ğŸ˜","ğŸ˜‘","ğŸ˜¯","ğŸ˜¦","ğŸ˜§","ğŸ˜®","ğŸ˜²","ğŸ¥±","ğŸ˜´","ğŸ¤¤","ğŸ˜ª","ğŸ˜µ","ğŸ¤","ğŸ¥´","ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤‘","ğŸ¤ "],ie=Y(()=>z.value?d.value.filter(s=>s.name.toLowerCase().includes(z.value.toLowerCase())):d.value),le=Y(()=>d.value.reduce((s,e)=>s+(e.unreadCount||0),0));Z(le,s=>{s>0?document.title=`(${s}) FEIä¿¡`:document.title="FEIä¿¡"});const re=async()=>{try{const s=await _.get("/api/users/friends/list");s.data.success&&(U.value=s.data.friends);const e=await _.get("/api/chats/groups");e.data.success&&(H.value=e.data.groups);const o=await _.get("/api/chats/unread-count");let t={};o.data.success&&(t=o.data.unreadCount);const n=[];U.value.forEach(i=>{n.push({type:"private",id:i._id,name:i.nickname||i.username,avatar:i.avatar,lastMessage:i.lastMessage||"",lastTime:i.lastMessageTime,unreadCount:t[i._id]||0})}),H.value.forEach(i=>{n.push({type:"group",id:i._id,name:i.name,avatar:i.avatar,lastMessage:i.lastMessage||"",lastTime:i.lastMessageTime,unreadCount:t[i._id]||0})}),n.sort((i,w)=>new Date(w.lastTime||0)-new Date(i.lastTime||0)),d.value=n}catch(s){console.error("è·å–èŠå¤©åˆ—è¡¨å¤±è´¥:",s)}},ue=async s=>{l.value=s,v.value=[],y.value=1,T.value=!0,console.log("é€‰æ‹©èŠå¤©:",s),console.log("å½“å‰ç”¨æˆ·:",p.user),ce(s.type,s.id);try{let e;if(s.type==="private"?e=await _.get(`/api/chats/private/${s.id}?page=${y.value}&limit=${S}`):e=await _.get(`/api/chats/groups/${s.id}?page=${y.value}&limit=${S}`),e.data.success){console.log("è·å–åˆ°çš„æ¶ˆæ¯:",e.data.messages),console.log("æ¶ˆæ¯æ•°é‡:",e.data.messages.length);const o=e.data.messages.sort((t,n)=>new Date(t.createdAt)-new Date(n.createdAt));o.forEach((t,n)=>{var i,w;console.log(`æ¶ˆæ¯ ${n+1}:`,{content:t.content.substring(0,20)+"...",senderId:t.sender._id,currentUserId:((i=p.user)==null?void 0:i.id)||((w=p.user)==null?void 0:w._id),isOwn:x(t)})}),v.value=o,T.value=e.data.messages.length===S,await A(),I()}}catch(e){console.error("è·å–æ¶ˆæ¯å¤±è´¥:",e),se.error("è·å–æ¶ˆæ¯å¤±è´¥")}},ce=(s,e)=>{const o=d.value.findIndex(t=>t.type===s&&String(t.id)===String(e));o!==-1&&(d.value[o].unreadCount=0)},de=(s,e,o)=>{const t=d.value.findIndex(n=>n.type===s&&String(n.id)===String(e));if(t!==-1){d.value[t].lastMessage=o,d.value[t].lastTime=new Date;const n=d.value.splice(t,1)[0];d.value.unshift(n)}},ve=async()=>{if(!(D.value||!T.value)){D.value=!0,y.value++;try{let s;if(l.value.type==="private"?s=await _.get(`/api/chats/private/${l.value.id}?page=${y.value}&limit=${S}`):s=await _.get(`/api/chats/groups/${l.value.id}?page=${y.value}&limit=${S}`),s.data.success){const e=s.data.messages.reverse();v.value.unshift(...e),T.value=e.length===S}}catch(s){console.error("åŠ è½½æ›´å¤šæ¶ˆæ¯å¤±è´¥:",s),y.value--}finally{D.value=!1}}},J=async()=>{var o,t,n,i,w;if(!f.value.trim()||!l.value)return;const s={content:f.value,timestamp:new Date,status:"sending"},e={_id:Date.now().toString(),content:f.value,sender:{_id:((o=p.user)==null?void 0:o.id)||((t=p.user)==null?void 0:t._id),username:(n=p.user)==null?void 0:n.username,nickname:(i=p.user)==null?void 0:i.nickname,avatar:(w=p.user)==null?void 0:w.avatar},createdAt:new Date,status:"sending"};v.value.push(e),f.value="",await A(),I();try{let C;if(l.value.type==="private"?C=await _.post("/api/chats/private",{receiver:l.value.id,content:s.content}):C=await _.post(`/api/chats/groups/${l.value.id}`,{content:s.content}),C.data.success){const $=v.value.findIndex(O=>O._id===e._id);$!==-1&&(v.value[$]={...C.data.message,status:"sent",_id:C.data.message._id}),de(l.value.type,l.value.id,e.content)}}catch(C){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",C),se.error("å‘é€æ¶ˆæ¯å¤±è´¥");const $=v.value.findIndex(O=>O._id===e._id);$!==-1&&(v.value[$].status="failed")}},pe=()=>{M.push("/profile")},ge=()=>{M.push("/settings")},fe=()=>{M.push("/add-friend")},me=()=>{M.push("/group-chat")},he=()=>{M.push("/moments")},Q=()=>{k.value=!k.value},_e=()=>{k.value=!1},I=()=>{E.value&&(E.value.scrollTop=E.value.scrollHeight)},we=()=>{const s=R.value;s&&(s.style.height="auto",s.style.height=Math.min(s.scrollHeight,120)+"px")},ye=s=>{var e;f.value+=s,L.value=!1,(e=R.value)==null||e.focus()},Ce=s=>{const e=s.target.files[0];e&&console.log("å›¾ç‰‡ä¸Šä¼ :",e),V.value=!1},be=()=>{console.log("å¼€å§‹å½•éŸ³")},W=()=>{console.log("åœæ­¢å½•éŸ³"),j.value=!1},ke=()=>{},q=s=>{const e=U.value.find(o=>o._id===s);return(e==null?void 0:e.status)||"offline"},Se=s=>{const e=new Date(s),t=new Date-e;return t<6e4?"åˆšåˆš":t<36e5?Math.floor(t/6e4)+"åˆ†é’Ÿå‰":t<864e5?Math.floor(t/36e5)+"å°æ—¶å‰":e.toLocaleDateString("zh-CN")},Me=s=>{const e=new Date(s),o=new Date;return e.toDateString()===o.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toDateString()===new Date(o-864e5).toDateString()?"æ˜¨å¤© "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN")+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})},De=s=>{if(!s)return"";const e=new Date(s),o=new Date;return e.toDateString()===o.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},Te=(s,e)=>{if(!e)return!0;const o=new Date(s.createdAt),t=new Date(e.createdAt);return o-t>3e5},F=(s,e)=>{if(!e)return!1;const o=new Date(s.createdAt),t=new Date(e.createdAt),n=o-t;return s.sender._id===e.sender._id&&n<3e5},Ie=s=>{l.value&&l.value.type==="private"&&String(s.sender._id)===String(l.value.id)&&!x(s)&&(v.value.push({...s,status:"received"}),A(()=>I())),X("private",s.sender._id,s)},xe=s=>{l.value&&l.value.type==="group"&&String(s.group)===String(l.value.id)&&!x(s)&&(v.value.push({...s,status:"received"}),A(()=>I())),X("group",s.group,s)},X=(s,e,o)=>{if(l.value&&l.value.type===s&&String(l.value.id)===String(e))return;const t=d.value.findIndex(n=>n.type===s&&String(n.id)===String(e));if(t!==-1){d.value[t].unreadCount=(d.value[t].unreadCount||0)+1,d.value[t].lastMessage=o.content,d.value[t].lastTime=o.createdAt;const n=d.value.splice(t,1)[0];d.value.unshift(n)}},x=s=>{var n,i;const e=((n=p.user)==null?void 0:n.id)||((i=p.user)==null?void 0:i._id),o=s.sender._id||s.sender.id;return String(e)===String(o)},$e=s=>{const e=U.value.find(o=>o._id===s.userId);e&&(e.status=s.status)};return Ae(async()=>{var e,o,t,n;const s=window.innerWidth<=768;k.value=!s,((e=p.user)!=null&&e.id||(o=p.user)!=null&&o._id)&&N.connect(((t=p.user)==null?void 0:t.id)||((n=p.user)==null?void 0:n._id)),await re(),N.onNewMessage(Ie),N.onNewGroupMessage(xe),N.onUserStatus($e)}),Z(v,()=>{A(()=>I())}),(s,e)=>{var o;return u(),r("div",Re,[a("div",{class:"mobile-menu-btn",onClick:h(Q,["stop"])},e[6]||(e[6]=[a("i",{class:"iconfont icon-menu"},null,-1)])),a("div",{class:b(["mobile-overlay",{show:k.value}]),onClick:_e},null,2),a("div",{class:b(["sidebar",{show:k.value}])},[a("div",{class:"mobile-close-btn",onClick:h(Q,["stop"])},e[7]||(e[7]=[a("i",{class:"iconfont icon-close"},null,-1)])),a("div",Fe,[a("div",Oe,[B(P,{src:(o=Ne(p).user)==null?void 0:o.avatar,size:"medium"},null,8,["src"])]),a("div",Be,[a("button",{class:"action-btn",onClick:h(pe,["stop"]),"aria-label":"ä¸ªäººèµ„æ–™"},e[8]||(e[8]=[a("i",{class:"iconfont icon-user"},null,-1)])),a("button",{class:"action-btn",onClick:h(ge,["stop"]),"aria-label":"è®¾ç½®"},e[9]||(e[9]=[a("i",{class:"iconfont icon-settings"},null,-1)]))])]),a("div",Ge,[a("div",Ke,[e[10]||(e[10]=a("i",{class:"iconfont icon-search"},null,-1)),ee(a("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>z.value=t),type:"text",placeholder:"æœç´¢",onInput:ke},null,544),[[te,z.value]])])]),a("div",Pe,[a("button",{class:"function-btn",onClick:h(fe,["stop"]),"aria-label":"æ·»åŠ å¥½å‹"},e[11]||(e[11]=[a("i",{class:"iconfont icon-add"},null,-1),a("span",null,"æ·»åŠ å¥½å‹",-1)])),a("button",{class:"function-btn",onClick:h(me,["stop"]),"aria-label":"ç¾¤èŠ"},e[12]||(e[12]=[a("i",{class:"iconfont icon-group"},null,-1),a("span",null,"ç¾¤èŠ",-1)])),a("button",{class:"function-btn",onClick:h(he,["stop"]),"aria-label":"æœ‹å‹åœˆ"},e[13]||(e[13]=[a("i",{class:"iconfont icon-moments"},null,-1),a("span",null,"æœ‹å‹åœˆ",-1)]))]),a("div",He,[(u(!0),r(G,null,K(ie.value,t=>{var n,i;return u(),r("div",{key:`${t.type}-${t.id}`,class:b(["chat-item",{active:((n=l.value)==null?void 0:n.type)===t.type&&((i=l.value)==null?void 0:i.id)===t.id}]),onClick:h(w=>ue(t),["stop"])},[a("div",Qe,[B(P,{src:t.avatar,size:"medium"},null,8,["src"]),t.unreadCount>0?(u(),r("div",We,g(t.unreadCount>99?"99+":t.unreadCount),1)):m("",!0)]),a("div",qe,[a("div",Xe,g(t.name),1),a("div",Ye,g(t.lastMessage||""),1)]),a("div",Ze,g(De(t.lastTime)),1)],10,Je)}),128))])],2),a("div",et,[l.value?(u(),r("div",tt,[a("div",st,[a("div",at,[a("span",null,g(l.value.name),1),l.value.type==="private"?(u(),r("span",nt,[a("span",{class:b(["status-dot",q(l.value.id)])},null,2),ze(" "+g(q(l.value.id)==="online"?"åœ¨çº¿":"ç¦»çº¿"),1)])):m("",!0)]),a("div",ot,[a("button",{class:"action-btn",onClick:e[1]||(e[1]=t=>ae.value=!0),"aria-label":"èŠå¤©ä¿¡æ¯"},e[14]||(e[14]=[a("i",{class:"iconfont icon-info"},null,-1)]))])]),a("div",{class:"messages-container",ref_key:"messagesContainer",ref:E},[a("div",it,[T.value?(u(),r("div",lt,[a("button",{onClick:ve,disabled:D.value},g(D.value?"åŠ è½½ä¸­...":"åŠ è½½æ›´å¤šæ¶ˆæ¯"),9,rt)])):m("",!0),(u(!0),r(G,null,K(v.value,(t,n)=>(u(),r("div",{key:t._id,class:b(["message-wrapper",{"message-group":F(t,v.value[n-1])}])},[Te(t,v.value[n-1])?(u(),r("div",ut,g(Me(t.createdAt)),1)):m("",!0),a("div",{class:b(["message-item",{own:x(t),grouped:F(t,v.value[n-1])}])},[F(t,v.value[n-1])?(u(),r("div",dt)):(u(),r("div",ct,[B(P,{src:t.sender.avatar,size:"small"},null,8,["src"])])),a("div",vt,[a("div",pt,[a("div",gt,g(t.content),1),a("div",ft,[a("span",mt,g(Se(t.createdAt)),1),x(t)?(u(),r("span",ht,[t.status==="sending"?(u(),r("i",_t)):t.status==="sent"?(u(),r("i",wt)):t.status==="read"?(u(),r("i",yt)):m("",!0)])):m("",!0)])])])],2)],2))),128))])],512),a("div",Ct,[a("div",bt,[a("button",{class:"tool-btn",onClick:e[2]||(e[2]=t=>L.value=!L.value),"aria-label":"è¡¨æƒ…"},e[15]||(e[15]=[a("i",{class:"iconfont icon-emoji"},null,-1)])),a("button",{class:"tool-btn",onClick:e[3]||(e[3]=t=>V.value=!0),"aria-label":"å›¾ç‰‡"},e[16]||(e[16]=[a("i",{class:"iconfont icon-image"},null,-1)])),a("button",{class:"tool-btn",onClick:e[4]||(e[4]=t=>j.value=!0),"aria-label":"è¯­éŸ³"},e[17]||(e[17]=[a("i",{class:"iconfont icon-voice"},null,-1)]))]),a("div",kt,[ee(a("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>f.value=t),ref_key:"messageInput",ref:R,class:"message-input",placeholder:"è¾“å…¥æ¶ˆæ¯...",onKeydown:Le(h(J,["prevent"]),["enter"]),onInput:we,rows:"1"},null,40,St),[[te,f.value]]),a("button",{class:b(["send-btn",{active:f.value.trim()}]),onClick:J,disabled:!f.value.trim()}," å‘é€ ",10,Mt)])])])):(u(),r("div",Dt,e[18]||(e[18]=[a("div",{class:"welcome-content"},[a("div",{class:"welcome-icon"},[a("i",{style:{"font-size":"50px"},class:"iconfont icon-chat"})]),a("h2",null,"é£ä¿¡"),a("p",null,"é€‰æ‹©ä¸€ä¸ªèŠå¤©å¼€å§‹å¯¹è¯")],-1)])))]),L.value?(u(),r("div",Tt,[a("div",It,[(u(),r(G,null,K(oe,t=>a("span",{key:t,class:"emoji-item",onClick:n=>ye(t)},g(t),9,xt)),64))])])):m("",!0),V.value?(u(),r("input",{key:1,ref_key:"imageInput",ref:ne,type:"file",accept:"image/*",onChange:Ce,style:{display:"none"}},null,544)):m("",!0),j.value?(u(),r("div",$t,[a("div",At,[a("div",Nt,[e[19]||(e[19]=a("div",{class:"voice-icon"},[a("i",{class:"iconfont icon-microphone"})],-1)),e[20]||(e[20]=a("p",null,"æŒ‰ä½è¯´è¯",-1)),a("button",{class:"voice-btn",onMousedown:be,onMouseup:W,onMouseleave:W}," å½•éŸ³ ",32)])])])):m("",!0)])}}},Ft=je(zt,[["__scopeId","data-v-37d784a0"]]);export{Ft as default};
