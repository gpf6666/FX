import{r as c,c as X,j as Y,h as xe,y as r,A as a,K as m,D as C,Q as B,u as $e,J as Z,aj as ee,P as G,a6 as K,O as g,M as Ae,a4 as Ne,V as ze,n as $,aC as Le,z as u}from"./chat-vendor-BrOh9MUQ.js";import{u as Ee,a as Ue,b as h}from"./chat-index-B3c8Dexn.js";import{A as P}from"./chat-Avatar-D-uQkRWk.js";import{_ as Ve}from"./chat-_plugin-vue_export-helper-DlAUqK2U.js";import{E as te}from"./chat-element-C03ZGswg.js";const je={class:"wechat-container"},Re={class:"sidebar-header"},Fe={class:"user-avatar"},Oe={class:"search-box"},Be={class:"search-input"},Ge={class:"chat-list"},Ke=["onClick"],Pe={class:"chat-avatar"},He={key:0,class:"unread-badge"},Je={class:"chat-info"},Qe={class:"chat-name"},We={class:"chat-last-message"},qe={class:"chat-time"},Xe={class:"main-chat"},Ye={key:0,class:"chat-area"},Ze={class:"chat-header"},et={class:"chat-title"},tt={key:0,class:"online-status"},st={class:"chat-actions"},at={class:"messages-wrapper"},nt={key:0,class:"load-more"},ot=["disabled"],it={key:0,class:"time-divider"},lt={key:0,class:"message-avatar"},rt={key:1,class:"message-avatar-placeholder"},ut={class:"message-content"},ct={class:"message-bubble"},dt={class:"message-text"},vt={class:"message-status"},pt={class:"message-time"},gt={key:0,class:"message-status-icon"},ft={key:0,class:"iconfont icon-loading"},mt={key:1,class:"iconfont icon-check"},ht={key:2,class:"iconfont icon-check-double"},_t={class:"input-area"},wt={class:"input-toolbar"},yt={class:"input-container"},Ct=["onKeydown"],bt=["disabled"],kt={key:1,class:"welcome-page"},St={key:0,class:"emoji-picker"},Mt={class:"emoji-list"},Dt=["onClick"],Tt={key:2,class:"voice-recorder"},It={class:"voice-modal"},xt={class:"voice-content"},b=20,$t={__name:"Chat",setup(At){const k=Le(),p=Ee(),A=Ue(),l=c(null),v=c([]),f=c(""),N=c(""),z=c(!1),U=c(!1),V=c(!1);c(!1),c(!1);const se=c(!1),L=c(),j=c(),ae=c(),S=c(!1),M=c(!0),w=c(1),D=c(!1),d=c([]),E=c([]),H=c([]),ne=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕","🤑","🤠"],oe=X(()=>N.value?d.value.filter(s=>s.name.toLowerCase().includes(N.value.toLowerCase())):d.value),ie=X(()=>d.value.reduce((s,e)=>s+(e.unreadCount||0),0));Y(ie,s=>{s>0?document.title=`(${s}) FEI信`:document.title="FEI信"});const le=async()=>{try{const s=await h.get("/api/users/friends/list");s.data.success&&(E.value=s.data.friends);const e=await h.get("/api/chats/groups");e.data.success&&(H.value=e.data.groups);const o=await h.get("/api/chats/unread-count");let t={};o.data.success&&(t=o.data.unreadCount);const n=[];E.value.forEach(i=>{n.push({type:"private",id:i._id,name:i.nickname||i.username,avatar:i.avatar,lastMessage:i.lastMessage||"",lastTime:i.lastMessageTime,unreadCount:t[i._id]||0})}),H.value.forEach(i=>{n.push({type:"group",id:i._id,name:i.name,avatar:i.avatar,lastMessage:i.lastMessage||"",lastTime:i.lastMessageTime,unreadCount:t[i._id]||0})}),n.sort((i,_)=>new Date(_.lastTime||0)-new Date(i.lastTime||0)),d.value=n}catch(s){console.error("获取聊天列表失败:",s)}},re=async s=>{l.value=s,v.value=[],w.value=1,M.value=!0,console.log("选择聊天:",s),console.log("当前用户:",p.user),ue(s.type,s.id);try{let e;if(s.type==="private"?e=await h.get(`/api/chats/private/${s.id}?page=${w.value}&limit=${b}`):e=await h.get(`/api/chats/groups/${s.id}?page=${w.value}&limit=${b}`),e.data.success){console.log("获取到的消息:",e.data.messages),console.log("消息数量:",e.data.messages.length);const o=e.data.messages.sort((t,n)=>new Date(t.createdAt)-new Date(n.createdAt));o.forEach((t,n)=>{var i,_;console.log(`消息 ${n+1}:`,{content:t.content.substring(0,20)+"...",senderId:t.sender._id,currentUserId:((i=p.user)==null?void 0:i.id)||((_=p.user)==null?void 0:_._id),isOwn:I(t)})}),v.value=o,M.value=e.data.messages.length===b,await $(),T()}}catch(e){console.error("获取消息失败:",e),te.error("获取消息失败")}},ue=(s,e)=>{const o=d.value.findIndex(t=>t.type===s&&String(t.id)===String(e));o!==-1&&(d.value[o].unreadCount=0)},ce=(s,e,o)=>{const t=d.value.findIndex(n=>n.type===s&&String(n.id)===String(e));if(t!==-1){d.value[t].lastMessage=o,d.value[t].lastTime=new Date;const n=d.value.splice(t,1)[0];d.value.unshift(n)}},de=async()=>{if(!(S.value||!M.value)){S.value=!0,w.value++;try{let s;if(l.value.type==="private"?s=await h.get(`/api/chats/private/${l.value.id}?page=${w.value}&limit=${b}`):s=await h.get(`/api/chats/groups/${l.value.id}?page=${w.value}&limit=${b}`),s.data.success){const e=s.data.messages.reverse();v.value.unshift(...e),M.value=e.length===b}}catch(s){console.error("加载更多消息失败:",s),w.value--}finally{S.value=!1}}},J=async()=>{var o,t,n,i,_;if(!f.value.trim()||!l.value)return;const s={content:f.value,timestamp:new Date,status:"sending"},e={_id:Date.now().toString(),content:f.value,sender:{_id:((o=p.user)==null?void 0:o.id)||((t=p.user)==null?void 0:t._id),username:(n=p.user)==null?void 0:n.username,nickname:(i=p.user)==null?void 0:i.nickname,avatar:(_=p.user)==null?void 0:_.avatar},createdAt:new Date,status:"sending"};v.value.push(e),f.value="",await $(),T();try{let y;if(l.value.type==="private"?y=await h.post("/api/chats/private",{receiver:l.value.id,content:s.content}):y=await h.post(`/api/chats/groups/${l.value.id}`,{content:s.content}),y.data.success){const x=v.value.findIndex(O=>O._id===e._id);x!==-1&&(v.value[x]={...y.data.message,status:"sent",_id:y.data.message._id}),ce(l.value.type,l.value.id,e.content)}}catch(y){console.error("发送消息失败:",y),te.error("发送消息失败");const x=v.value.findIndex(O=>O._id===e._id);x!==-1&&(v.value[x].status="failed")}},ve=()=>{k.push("/profile")},pe=()=>{k.push("/settings")},ge=()=>{k.push("/add-friend")},fe=()=>{k.push("/group-chat")},me=()=>{k.push("/moments")},R=()=>{D.value=!D.value},T=()=>{L.value&&(L.value.scrollTop=L.value.scrollHeight)},he=()=>{const s=j.value;s&&(s.style.height="auto",s.style.height=Math.min(s.scrollHeight,120)+"px")},_e=s=>{var e;f.value+=s,z.value=!1,(e=j.value)==null||e.focus()},we=s=>{const e=s.target.files[0];e&&console.log("图片上传:",e),U.value=!1},ye=()=>{console.log("开始录音")},Q=()=>{console.log("停止录音"),V.value=!1},Ce=()=>{},W=s=>{const e=E.value.find(o=>o._id===s);return(e==null?void 0:e.status)||"offline"},be=s=>{const e=new Date(s),t=new Date-e;return t<6e4?"刚刚":t<36e5?Math.floor(t/6e4)+"分钟前":t<864e5?Math.floor(t/36e5)+"小时前":e.toLocaleDateString("zh-CN")},ke=s=>{const e=new Date(s),o=new Date;return e.toDateString()===o.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toDateString()===new Date(o-864e5).toDateString()?"昨天 "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN")+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})},Se=s=>{if(!s)return"";const e=new Date(s),o=new Date;return e.toDateString()===o.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},Me=(s,e)=>{if(!e)return!0;const o=new Date(s.createdAt),t=new Date(e.createdAt);return o-t>3e5},F=(s,e)=>{if(!e)return!1;const o=new Date(s.createdAt),t=new Date(e.createdAt),n=o-t;return s.sender._id===e.sender._id&&n<3e5},De=s=>{l.value&&l.value.type==="private"&&String(s.sender._id)===String(l.value.id)&&!I(s)&&(v.value.push({...s,status:"received"}),$(()=>T())),q("private",s.sender._id,s)},Te=s=>{l.value&&l.value.type==="group"&&String(s.group)===String(l.value.id)&&!I(s)&&(v.value.push({...s,status:"received"}),$(()=>T())),q("group",s.group,s)},q=(s,e,o)=>{if(l.value&&l.value.type===s&&String(l.value.id)===String(e))return;const t=d.value.findIndex(n=>n.type===s&&String(n.id)===String(e));if(t!==-1){d.value[t].unreadCount=(d.value[t].unreadCount||0)+1,d.value[t].lastMessage=o.content,d.value[t].lastTime=o.createdAt;const n=d.value.splice(t,1)[0];d.value.unshift(n)}},I=s=>{var n,i;const e=((n=p.user)==null?void 0:n.id)||((i=p.user)==null?void 0:i._id),o=s.sender._id||s.sender.id;return String(e)===String(o)},Ie=s=>{const e=E.value.find(o=>o._id===s.userId);e&&(e.status=s.status)};return xe(async()=>{var e,o,t,n;const s=window.innerWidth<=768;D.value=!s,((e=p.user)!=null&&e.id||(o=p.user)!=null&&o._id)&&A.connect(((t=p.user)==null?void 0:t.id)||((n=p.user)==null?void 0:n._id)),await le(),A.onNewMessage(De),A.onNewGroupMessage(Te),A.onUserStatus(Ie)}),Y(v,()=>{$(()=>T())}),(s,e)=>{var o;return u(),r("div",je,[a("div",{class:"mobile-menu-btn",onClick:R},e[6]||(e[6]=[a("i",{class:"iconfont icon-menu"},null,-1)])),a("div",{class:C(["mobile-overlay",{show:D.value}]),onClick:R},null,2),a("div",{class:C(["sidebar",{show:D.value}])},[a("div",{class:"mobile-close-btn",onClick:R},e[7]||(e[7]=[a("i",{class:"iconfont icon-close"},null,-1)])),a("div",Re,[a("div",Fe,[B(P,{src:(o=$e(p).user)==null?void 0:o.avatar,size:"medium"},null,8,["src"])]),a("div",{class:"user-actions"},[a("button",{class:"action-btn",onClick:ve,"aria-label":"个人资料"},e[8]||(e[8]=[a("i",{class:"iconfont icon-user"},null,-1)])),a("button",{class:"action-btn",onClick:pe,"aria-label":"设置"},e[9]||(e[9]=[a("i",{class:"iconfont icon-settings"},null,-1)]))])]),a("div",Oe,[a("div",Be,[e[10]||(e[10]=a("i",{class:"iconfont icon-search"},null,-1)),Z(a("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>N.value=t),type:"text",placeholder:"搜索",onInput:Ce},null,544),[[ee,N.value]])])]),a("div",{class:"function-buttons"},[a("button",{class:"function-btn",onClick:ge,"aria-label":"添加好友"},e[11]||(e[11]=[a("i",{class:"iconfont icon-add"},null,-1),a("span",null,"添加好友",-1)])),a("button",{class:"function-btn",onClick:fe,"aria-label":"群聊"},e[12]||(e[12]=[a("i",{class:"iconfont icon-group"},null,-1),a("span",null,"群聊",-1)])),a("button",{class:"function-btn",onClick:me,"aria-label":"朋友圈"},e[13]||(e[13]=[a("i",{class:"iconfont icon-moments"},null,-1),a("span",null,"朋友圈",-1)]))]),a("div",Ge,[(u(!0),r(G,null,K(oe.value,t=>{var n,i;return u(),r("div",{key:`${t.type}-${t.id}`,class:C(["chat-item",{active:((n=l.value)==null?void 0:n.type)===t.type&&((i=l.value)==null?void 0:i.id)===t.id}]),onClick:_=>re(t)},[a("div",Pe,[B(P,{src:t.avatar,size:"medium"},null,8,["src"]),t.unreadCount>0?(u(),r("div",He,g(t.unreadCount>99?"99+":t.unreadCount),1)):m("",!0)]),a("div",Je,[a("div",Qe,g(t.name),1),a("div",We,g(t.lastMessage||""),1)]),a("div",qe,g(Se(t.lastTime)),1)],10,Ke)}),128))])],2),a("div",Xe,[l.value?(u(),r("div",Ye,[a("div",Ze,[a("div",et,[a("span",null,g(l.value.name),1),l.value.type==="private"?(u(),r("span",tt,[a("span",{class:C(["status-dot",W(l.value.id)])},null,2),Ae(" "+g(W(l.value.id)==="online"?"在线":"离线"),1)])):m("",!0)]),a("div",st,[a("button",{class:"action-btn",onClick:e[1]||(e[1]=t=>se.value=!0),"aria-label":"聊天信息"},e[14]||(e[14]=[a("i",{class:"iconfont icon-info"},null,-1)]))])]),a("div",{class:"messages-container",ref_key:"messagesContainer",ref:L},[a("div",at,[M.value?(u(),r("div",nt,[a("button",{onClick:de,disabled:S.value},g(S.value?"加载中...":"加载更多消息"),9,ot)])):m("",!0),(u(!0),r(G,null,K(v.value,(t,n)=>(u(),r("div",{key:t._id,class:C(["message-wrapper",{"message-group":F(t,v.value[n-1])}])},[Me(t,v.value[n-1])?(u(),r("div",it,g(ke(t.createdAt)),1)):m("",!0),a("div",{class:C(["message-item",{own:I(t),grouped:F(t,v.value[n-1])}])},[F(t,v.value[n-1])?(u(),r("div",rt)):(u(),r("div",lt,[B(P,{src:t.sender.avatar,size:"small"},null,8,["src"])])),a("div",ut,[a("div",ct,[a("div",dt,g(t.content),1),a("div",vt,[a("span",pt,g(be(t.createdAt)),1),I(t)?(u(),r("span",gt,[t.status==="sending"?(u(),r("i",ft)):t.status==="sent"?(u(),r("i",mt)):t.status==="read"?(u(),r("i",ht)):m("",!0)])):m("",!0)])])])],2)],2))),128))])],512),a("div",_t,[a("div",wt,[a("button",{class:"tool-btn",onClick:e[2]||(e[2]=t=>z.value=!z.value),"aria-label":"表情"},e[15]||(e[15]=[a("i",{class:"iconfont icon-emoji"},null,-1)])),a("button",{class:"tool-btn",onClick:e[3]||(e[3]=t=>U.value=!0),"aria-label":"图片"},e[16]||(e[16]=[a("i",{class:"iconfont icon-image"},null,-1)])),a("button",{class:"tool-btn",onClick:e[4]||(e[4]=t=>V.value=!0),"aria-label":"语音"},e[17]||(e[17]=[a("i",{class:"iconfont icon-voice"},null,-1)]))]),a("div",yt,[Z(a("textarea",{"onUpdate:modelValue":e[5]||(e[5]=t=>f.value=t),ref_key:"messageInput",ref:j,class:"message-input",placeholder:"输入消息...",onKeydown:Ne(ze(J,["prevent"]),["enter"]),onInput:he,rows:"1"},null,40,Ct),[[ee,f.value]]),a("button",{class:C(["send-btn",{active:f.value.trim()}]),onClick:J,disabled:!f.value.trim()}," 发送 ",10,bt)])])])):(u(),r("div",kt,e[18]||(e[18]=[a("div",{class:"welcome-content"},[a("div",{class:"welcome-icon"},[a("i",{style:{"font-size":"50px"},class:"iconfont icon-chat"})]),a("h2",null,"飞信"),a("p",null,"选择一个聊天开始对话")],-1)])))]),z.value?(u(),r("div",St,[a("div",Mt,[(u(),r(G,null,K(ne,t=>a("span",{key:t,class:"emoji-item",onClick:n=>_e(t)},g(t),9,Dt)),64))])])):m("",!0),U.value?(u(),r("input",{key:1,ref_key:"imageInput",ref:ae,type:"file",accept:"image/*",onChange:we,style:{display:"none"}},null,544)):m("",!0),V.value?(u(),r("div",Tt,[a("div",It,[a("div",xt,[e[19]||(e[19]=a("div",{class:"voice-icon"},[a("i",{class:"iconfont icon-microphone"})],-1)),e[20]||(e[20]=a("p",null,"按住说话",-1)),a("button",{class:"voice-btn",onMousedown:ye,onMouseup:Q,onMouseleave:Q}," 录音 ",32)])])])):m("",!0)])}}},Vt=Ve($t,[["__scopeId","data-v-f9896b41"]]);export{Vt as default};
